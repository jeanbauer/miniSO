Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 1
scall.ASM



      1				     $comm   macro   name,dist,size,count
      2					     comm    dist name[size]:BYTE:count
      3					     endm
      4					     ?debug  V 300h
      5					     ?debug  S "scall.c"
      6					     ?debug  C E920A9684B077363616C6C2E63
      7					     ?debug  C E98FA6684B086D696E69534F2E68
      8					     ?debug  C E9FBA5684B077363616C6C2E68
      9					     ?debug  C E9D2A4684B056C69622E68
     10	0000			     _TEXT   segment byte public 'CODE'
     11	0000			     _TEXT   ends
     12				     DGROUP  group   _DATA,_BSS
     13					     assume  cs:_TEXT,ds:DGROUP
     14	0000			     _DATA   segment word public 'DATA'
     15	0000			     d@	     label   byte
     16	0000			     d@w     label   word
     17	0000			     _DATA   ends
     18	0000			     _BSS    segment word public 'BSS'
     19	0000			     b@	     label   byte
     20	0000			     b@w     label   word
     21	0000			     _BSS    ends
     22	0000			     _DATA   segment word public 'DATA'
     23	0000			     miniSO_col	     label   byte
     24	0000  50			     db	     80
     25	0001			     miniSO_cor	     label   byte
     26	0001  07			     db	     7
     27	0002			     miniSO_pag	     label   byte
     28	0002  00			     db	     0
     29	0003			     miniSO_iskey    label   byte
     30	0003  00			     db	     0
     31	0004			     miniSO_key	     label   byte
     32	0004  00			     db	     0
     33	0005			     nextsemid	     label   word
     34	0005  00			     db	     0
     35	0006  00			     db	     0
     36	0007			     _miniSO_ready   label   word
     37	0007  FF			     db	     255
     38	0008  FF			     db	     255
     39	0009			     _miniSO_free    label   word
     40	0009  FF			     db	     255
     41	000A  FF			     db	     255
     42	000B			     _miniSO_scall_table     label   word
     43	000B  00			     db	     0
     44	000C  01			     db	     1
     45	000D  00			     db	     0
     46	000E  00DAr			     dw	     _sc_putch
     47	0010  01			     db	     1
     48	0011  00			     db	     0
     49	0012  00			     db	     0
     50	0013  0170r			     dw	     _sc_getch
     51	0015  02			     db	     2
     52	0016  00			     db	     0
     53	0017  00			     db	     0
     54	0018  01C0r			     dw	     _sc_clrscr
     55	001A  03			     db	     3
     56	001B  00			     db	     0
     57	001C  00			     db	     0
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 2
scall.ASM



     58	001D  01E2r			     dw	     _sc_getcolor
     59	001F  04			     db	     4
     60	0020  01			     db	     1
     61	0021  00			     db	     0
     62	0022  01EDr			     dw	     _sc_setcolor
     63	0024  05			     db	     5
     64	0025  00			     db	     0
     65	0026  00			     db	     0
     66	0027  01FCr			     dw	     _sc_wherex
     67	0029  06			     db	     6
     68	002A  00			     db	     0
     69	002B  00			     db	     0
     70	002C  0209r			     dw	     _sc_wherey
     71	002E  07			     db	     7
     72	002F  02			     db	     2
     73	0030  00			     db	     0
     74	0031  021Ar			     dw	     _sc_gotoxy
     75	0033  08			     db	     8
     76	0034  02			     db	     2
     77	0035  00			     db	     0
     78	0036  0248r			     dw	     _sc_getdate
     79	0038  09			     db	     9
     80	0039  02			     db	     2
     81	003A  00			     db	     0
     82	003B  02F8r			     dw	     _sc_gettime
     83	003D  0A			     db	     10
     84	003E  00			     db	     0
     85	003F  00			     db	     0
     86	0040  05B8r			     dw	     _sc_reboot
     87	0042  0B			     db	     11
     88	0043  02			     db	     2
     89	0044  00			     db	     0
     90	0045  05D8r			     dw	     _sc_fork
     91	0047  0C			     db	     12
     92	0048  01			     db	     1
     93	0049  00			     db	     0
     94	004A  0834r			     dw	     _sc_kill
     95	004C  0D			     db	     13
     96	004D  03			     db	     3
     97	004E  00			     db	     0
     98	004F  0B30r			     dw	     _sc_waitpid
     99	0051  0E			     db	     14
    100	0052  02			     db	     2
    101	0053  00			     db	     0
    102	0054  0D03r			     dw	     _sc_wait
    103	0056  0F			     db	     15
    104	0057  01			     db	     1
    105	0058  00			     db	     0
    106	0059  0E83r			     dw	     _sc_exit
    107	005B  10			     db	     16
    108	005C  00			     db	     0
    109	005D  00			     db	     0
    110	005E  1108r			     dw	     _sc_getpid
    111	0060  11			     db	     17
    112	0061  00			     db	     0
    113	0062  00			     db	     0
    114	0063  111Dr			     dw	     _sc_getppid
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 3
scall.ASM



    115	0065  12			     db	     18
    116	0066  02			     db	     2
    117	0067  00			     db	     0
    118	0068  1132r			     dw	     _sc_sendsignal
    119	006A  13			     db	     19
    120	006B  01			     db	     1
    121	006C  00			     db	     0
    122	006D  1232r			     dw	     _sc_waitsignal
    123	006F  14			     db	     20
    124	0070  01			     db	     1
    125	0071  00			     db	     0
    126	0072  1368r			     dw	     _sc_semcreate
    127	0074  15			     db	     21
    128	0075  02			     db	     2
    129	0076  00			     db	     0
    130	0077  13F3r			     dw	     _sc_semset
    131	0079  16			     db	     22
    132	007A  01			     db	     1
    133	007B  00			     db	     0
    134	007C  142Cr			     dw	     _sc_semup
    135	007E  17			     db	     23
    136	007F  01			     db	     1
    137	0080  00			     db	     0
    138	0081  1519r			     dw	     _sc_semdown
    139	0083  18			     db	     24
    140	0084  01			     db	     1
    141	0085  00			     db	     0
    142	0086  165Fr			     dw	     _sc_semdestroy
    143	0088  19			     db	     25
    144	0089  01			     db	     1
    145	008A  00			     db	     0
    146	008B  1697r			     dw	     _sc_stop
    147	008D  1A			     db	     26
    148	008E  01			     db	     1
    149	008F  00			     db	     0
    150	0090  173Er			     dw	     _sc_resume
    151	0092			     _DATA   ends
    152	0000			     _TEXT   segment byte public 'CODE'
    153					;
    154					;    int scall(unsigned	servico,unsigned bx,unsigned cx,unsigned dx)
    155					;
    156					     assume  cs:_TEXT
    157	0000			     _scall  proc    near
    158	0000  55			     push    bp
    159	0001  8B EC			     mov     bp,sp
    160	0003  56			     push    si
    161	0004  57			     push    di
    162	0005  8B 7E 06			     mov     di,word ptr [bp+6]
    163					;
    164					;    {
    165					;	     int     i;
    166					;
    167					;	     for     (i=0;i<miniSO_NUMSCALL;++i) {
    168					;
    169	0008  33 F6			     xor     si,si
    170	000A  EB 7C 90			     jmp     @1@338
    171	000D			     @1@58:
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 4
scall.ASM



    172					;
    173					;		     if	     (servico==(unsigned)miniSO_scall_table[i].ah) {
    174					;
    175	000D  8B C6			     mov     ax,si
    176	000F  BA 0005			     mov     dx,5
    177	0012  F7 EA			     imul    dx
    178	0014  8B D8			     mov     bx,ax
    179	0016  8A 87 000Br		     mov     al,byte ptr DGROUP:_miniSO_scall_table[bx]
    180	001A  98			     cbw
    181	001B  3B 46 04			     cmp     ax,word ptr [bp+4]
    182	001E  75 67			     jne     short @1@310
    183					;
    184					;			     switch  (miniSO_scall_table[i].numparam)  {
    185					;
    186	0020  8B C6			     mov     ax,si
    187	0022  BA 0005			     mov     dx,5
    188	0025  F7 EA			     imul    dx
    189	0027  8B D8			     mov     bx,ax
    190	0029  8B 9F 000Cr		     mov     bx,word ptr DGROUP:_miniSO_scall_table[bx+1]
    191	002D  83 FB 03			     cmp     bx,3
    192	0030  77 55			     ja	     short @1@310
    193	0032  D1 E3			     shl     bx,1
    194	0034  2E: FF A7	0098r		     jmp     word ptr cs:@1@C434[bx]
    195	0039			     @1@170:
    196					;
    197					;				     case    0:
    198					;					     return miniSO_scall_table[i].function.p0();
    199					;
    200	0039  8B C6			     mov     ax,si
    201	003B  BA 0005			     mov     dx,5
    202	003E  F7 EA			     imul    dx
    203	0040  8B D8			     mov     bx,ax
    204	0042  FF 97 000Er		     call    word ptr DGROUP:_miniSO_scall_table[bx+3]
    205	0046			     @1@198:
    206	0046  EB 4C			     jmp     short @1@394
    207	0048			     @1@226:
    208					;
    209					;				     case    1:
    210					;					     return miniSO_scall_table[i].function.p1(bx);
    211					;
    212	0048  57			     push    di
    213	0049  8B C6			     mov     ax,si
    214	004B  BA 0005			     mov     dx,5
    215	004E  F7 EA			     imul    dx
    216	0050  8B D8			     mov     bx,ax
    217	0052  FF 97 000Er		     call    word ptr DGROUP:_miniSO_scall_table[bx+3]
    218	0056  59			     pop     cx
    219	0057  EB ED			     jmp     short @1@198
    220	0059			     @1@254:
    221					;
    222					;				     case    2:
    223					;					     return miniSO_scall_table[i].function.p2(bx,cx);
    224					;
    225	0059  FF 76 08			     push    word ptr [bp+8]
    226	005C  57			     push    di
    227	005D  8B C6			     mov     ax,si
    228	005F  BA 0005			     mov     dx,5
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 5
scall.ASM



    229	0062  F7 EA			     imul    dx
    230	0064  8B D8			     mov     bx,ax
    231	0066  FF 97 000Er		     call    word ptr DGROUP:_miniSO_scall_table[bx+3]
    232	006A  59			     pop     cx
    233	006B  59			     pop     cx
    234	006C  EB D8			     jmp     short @1@198
    235	006E			     @1@282:
    236					;
    237					;				     case    3:
    238					;					     return miniSO_scall_table[i].function.p3(bx,cx,+
    239				     dx);
    240					;
    241	006E  FF 76 0A			     push    word ptr [bp+10]
    242	0071  FF 76 08			     push    word ptr [bp+8]
    243	0074  57			     push    di
    244	0075  8B C6			     mov     ax,si
    245	0077  BA 0005			     mov     dx,5
    246	007A  F7 EA			     imul    dx
    247	007C  8B D8			     mov     bx,ax
    248	007E  FF 97 000Er		     call    word ptr DGROUP:_miniSO_scall_table[bx+3]
    249	0082  83 C4 06			     add     sp,6
    250	0085  EB BF			     jmp     short @1@198
    251	0087			     @1@310:
    252	0087  46			     inc     si
    253	0088			     @1@338:
    254	0088  83 FE 1B			     cmp     si,27
    255	008B  7D 03			     jge     @@0
    256	008D  E9 FF7D			     jmp     @1@58
    257	0090			     @@0:
    258					;
    259					;			     }
    260					;		     }
    261					;	     }
    262					;	     return 0;
    263					;
    264	0090  33 C0			     xor     ax,ax
    265	0092  EB B2			     jmp     short @1@198
    266	0094			     @1@394:
    267					;
    268					;    }
    269					;
    270	0094  5F			     pop     di
    271	0095  5E			     pop     si
    272	0096  5D			     pop     bp
    273	0097  C3			     ret
    274	0098			     _scall  endp
    275	0098			     @1@C434 label   word
    276	0098  0039r			     dw	     @1@170
    277	009A  0048r			     dw	     @1@226
    278	009C  0059r			     dw	     @1@254
    279	009E  006Er			     dw	     @1@282
    280					;
    281					;    void setCursorPosition(int	pos)
    282					;
    283					     assume  cs:_TEXT
    284	00A0			     setCursorPosition	     proc    near
    285	00A0  55			     push    bp
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 6
scall.ASM



    286	00A1  8B EC			     mov     bp,sp
    287					;
    288					;    {
    289					;	     mov_dx(pos);
    290					;
    291	00A3  8B 56 04			     mov     dx,word ptr [bp+4]
    292					;
    293					;	     mov_bh(miniSO_pag);
    294					;
    295	00A6  8A 3E 0002r		     mov     bh,byte ptr DGROUP:miniSO_pag
    296					;
    297					;	     mov_ah(2);
    298					;
    299	00AA  B4 02			     mov     ah,2
    300					;
    301					;	     int_10h();
    302					;
    303	00AC  CD 10			     int      10h
    304					;
    305					;    }
    306					;
    307	00AE  5D			     pop     bp
    308	00AF  C3			     ret
    309	00B0			     setCursorPosition	     endp
    310					;
    311					;    int getCursorPosition()
    312					;
    313					     assume  cs:_TEXT
    314	00B0			     getCursorPosition	     proc    near
    315	00B0  55			     push    bp
    316	00B1  8B EC			     mov     bp,sp
    317					;
    318					;    {
    319					;	     mov_bh(miniSO_pag);
    320					;
    321	00B3  8A 3E 0002r		     mov     bh,byte ptr DGROUP:miniSO_pag
    322					;
    323					;	     mov_ah(3);
    324					;
    325	00B7  B4 03			     mov     ah,3
    326					;
    327					;	     int_10h();
    328					;
    329	00B9  CD 10			     int      10h
    330					;
    331					;	     return _DX;
    332					;
    333	00BB  8B C2			     mov     ax,dx
    334	00BD  EB 00			     jmp     short @3@114
    335	00BF			     @3@114:
    336					;
    337					;    }
    338					;
    339	00BF  5D			     pop     bp
    340	00C0  C3			     ret
    341	00C1			     getCursorPosition	     endp
    342					;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 7
scall.ASM



    343					;    void scroll()
    344					;
    345					     assume  cs:_TEXT
    346	00C1			     scroll  proc    near
    347	00C1  55			     push    bp
    348	00C2  8B EC			     mov     bp,sp
    349					;
    350					;    {
    351					;	     mov_al(1);	/* número de linhas para scroll	*/
    352					;
    353	00C4  B0 01			     mov     al,1
    354					;
    355					;	     mov_cx(0);
    356					;
    357	00C6  33 C9			     xor     cx,cx
    358					;
    359					;	     mov_ah(6);
    360					;
    361	00C8  B4 06			     mov     ah,6
    362					;
    363					;	     mov_dh(24);
    364					;
    365	00CA  B6 18			     mov     dh,24
    366					;
    367					;	     mov_dl(miniSO_col);
    368					;
    369	00CC  8A 16 0000r		     mov     dl,byte ptr DGROUP:miniSO_col
    370					;
    371					;	     dec_dl();
    372					;
    373	00D0  FE CA			     dec      dl
    374					;
    375					;	     mov_bh(miniSO_cor);
    376					;
    377	00D2  8A 3E 0001r		     mov     bh,byte ptr DGROUP:miniSO_cor
    378					;
    379					;	     int_10h();
    380					;
    381	00D6  CD 10			     int      10h
    382					;
    383					;    }
    384					;
    385	00D8  5D			     pop     bp
    386	00D9  C3			     ret
    387	00DA			     scroll  endp
    388					;
    389					;    int sc_putch(int car)
    390					;
    391					     assume  cs:_TEXT
    392	00DA			     _sc_putch	     proc    near
    393	00DA  55			     push    bp
    394	00DB  8B EC			     mov     bp,sp
    395	00DD  83 EC 02			     sub     sp,2
    396	00E0  56			     push    si
    397	00E1  57			     push    di
    398					;
    399					;    {
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 8
scall.ASM



    400					;	     int     curpos,lin,col;
    401					;
    402					;	     car = car & 0x00ff;
    403					;
    404	00E2  8B 46 04			     mov     ax,word ptr [bp+4]
    405	00E5  25 00FF			     and     ax,255
    406	00E8  89 46 04			     mov     word ptr [bp+4],ax
    407					;
    408					;	     if	     (car==10)	{
    409					;
    410	00EB  83 7E 04 0A		     cmp     word ptr [bp+4],10
    411	00EF  75 22			     jne     short @5@170
    412					;
    413					;		     curpos = getCursorPosition();
    414					;
    415	00F1  E8 FFBC			     call    near ptr getCursorPosition
    416	00F4  8B F8			     mov     di,ax
    417					;
    418					;		     lin = (curpos >> 8) & 0x00ff;
    419					;
    420	00F6  8B C7			     mov     ax,di
    421	00F8  B1 08			     mov     cl,8
    422	00FA  D3 F8			     sar     ax,cl
    423	00FC  25 00FF			     and     ax,255
    424	00FF  8B F0			     mov     si,ax
    425					;
    426					;		     col = 0;
    427					;
    428	0101  C7 46 FE 0000		     mov     word ptr [bp-2],0
    429					;
    430					;		     if	     (lin<24)
    431					;
    432	0106  83 FE 18			     cmp     si,24
    433	0109  7D 03			     jge     short @5@114
    434					;
    435					;			     ++lin;
    436					;
    437	010B  46			     inc     si
    438	010C  EB 03			     jmp     short @5@142
    439	010E			     @5@114:
    440					;
    441					;		     else
    442					;			     scroll();
    443					;
    444	010E  E8 FFB0			     call    near ptr scroll
    445	0111			     @5@142:
    446					;
    447					;	     }
    448					;
    449	0111  EB 43			     jmp     short @5@338
    450	0113			     @5@170:
    451					;
    452					;	     else    {
    453					;		     /*	Imprime	o caracter */
    454					;		     mov_bl(miniSO_cor);
    455					;
    456	0113  8A 1E 0001r		     mov     bl,byte ptr DGROUP:miniSO_cor
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 9
scall.ASM



    457					;
    458					;		     mov_bh(miniSO_pag);
    459					;
    460	0117  8A 3E 0002r		     mov     bh,byte ptr DGROUP:miniSO_pag
    461					;
    462					;		     mov_cx(1);
    463					;
    464	011B  B9 0001			     mov     cx,1
    465					;
    466					;		     mov_ah(0x9);
    467					;
    468	011E  B4 09			     mov     ah,9
    469					;
    470					;		     int_10h();
    471					;
    472	0120  CD 10			     int      10h
    473					;
    474					;		     curpos = getCursorPosition();
    475					;
    476	0122  E8 FF8B			     call    near ptr getCursorPosition
    477	0125  8B F8			     mov     di,ax
    478					;
    479					;		     lin = (curpos >> 8) & 0x00ff;
    480					;
    481	0127  8B C7			     mov     ax,di
    482	0129  B1 08			     mov     cl,8
    483	012B  D3 F8			     sar     ax,cl
    484	012D  25 00FF			     and     ax,255
    485	0130  8B F0			     mov     si,ax
    486					;
    487					;		     col = curpos & 0x00ff;
    488					;
    489	0132  8B C7			     mov     ax,di
    490	0134  25 00FF			     and     ax,255
    491	0137  89 46 FE			     mov     word ptr [bp-2],ax
    492					;
    493					;		     ++col;
    494					;
    495	013A  FF 46 FE			     inc     word ptr [bp-2]
    496					;
    497					;		     if	     (col==miniSO_col)	{
    498					;
    499	013D  A0 0000r			     mov     al,byte ptr DGROUP:miniSO_col
    500	0140  98			     cbw
    501	0141  3B 46 FE			     cmp     ax,word ptr [bp-2]
    502	0144  75 10			     jne     short @5@338
    503					;
    504					;			     col = 0;
    505					;
    506	0146  C7 46 FE 0000		     mov     word ptr [bp-2],0
    507					;
    508					;			     if	     (lin<24)
    509					;
    510	014B  83 FE 18			     cmp     si,24
    511	014E  7D 03			     jge     short @5@310
    512					;
    513					;				     ++lin;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 10
scall.ASM



    514					;
    515	0150  46			     inc     si
    516	0151  EB 03			     jmp     short @5@338
    517	0153			     @5@310:
    518					;
    519					;			     else
    520					;				     scroll();
    521					;
    522	0153  E8 FF6B			     call    near ptr scroll
    523	0156			     @5@338:
    524					;
    525					;		     }
    526					;	     }
    527					;	     curpos = (lin << 8)|col;
    528					;
    529	0156  8B C6			     mov     ax,si
    530	0158  B1 08			     mov     cl,8
    531	015A  D3 E0			     shl     ax,cl
    532	015C  0B 46 FE			     or	     ax,word ptr [bp-2]
    533	015F  8B F8			     mov     di,ax
    534					;
    535					;	     setCursorPosition(curpos);
    536					;
    537	0161  57			     push    di
    538	0162  E8 FF3B			     call    near ptr setCursorPosition
    539	0165  59			     pop     cx
    540					;
    541					;	     return 0;
    542					;
    543	0166  33 C0			     xor     ax,ax
    544	0168  EB 00			     jmp     short @5@366
    545	016A			     @5@366:
    546					;
    547					;    }
    548					;
    549	016A  5F			     pop     di
    550	016B  5E			     pop     si
    551	016C  8B E5			     mov     sp,bp
    552	016E  5D			     pop     bp
    553	016F  C3			     ret
    554	0170			     _sc_putch	     endp
    555					;
    556					;    int sc_getch()
    557					;
    558					     assume  cs:_TEXT
    559	0170			     _sc_getch	     proc    near
    560	0170  55			     push    bp
    561	0171  8B EC			     mov     bp,sp
    562	0173  83 EC 02			     sub     sp,2
    563					;
    564					;    {
    565					;      int ax,al,ah;
    566					;
    567					;      if (miniSO_iskey!=0)  {
    568					;
    569	0176  80 3E 0003r 00		     cmp     byte ptr DGROUP:miniSO_iskey,0
    570	017B  74 0B			     je	     short @6@114
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 11
scall.ASM



    571					;
    572					;	  miniSO_iskey = 0;
    573					;
    574	017D  C6 06 0003r 00		     mov     byte ptr DGROUP:miniSO_iskey,0
    575					;
    576					;	  return miniSO_key;
    577					;
    578	0182  A0 0004r			     mov     al,byte ptr DGROUP:miniSO_key
    579	0185  98			     cbw
    580	0186			     @6@86:
    581	0186  EB 34			     jmp     short @6@282
    582	0188			     @6@114:
    583					;
    584					;      }
    585					;
    586					;      mov_ah(0x10);
    587					;
    588	0188  B4 10			     mov     ah,16
    589					;
    590					;      int_16h();
    591					;
    592	018A  CD 16			     int      16h
    593					;
    594					;
    595					;      ax = get_ax();
    596					;
    597	018C  8B D8			     mov     bx,ax
    598					;
    599					;      ah = (ax	>> 8) &	0x00ff;
    600					;
    601	018E  8B C3			     mov     ax,bx
    602	0190  B1 08			     mov     cl,8
    603	0192  D3 F8			     sar     ax,cl
    604	0194  25 00FF			     and     ax,255
    605	0197  89 46 FE			     mov     word ptr [bp-2],ax
    606					;
    607					;      al = 0x00ff & ax;
    608					;
    609	019A  B8 00FF			     mov     ax,255
    610	019D  23 C3			     and     ax,bx
    611	019F  8B D0			     mov     dx,ax
    612					;
    613					;
    614					;      if (al==0xe0 || al==0x00)  {
    615					;
    616	01A1  81 FA 00E0		     cmp     dx,224
    617	01A5  74 04			     je	     short @6@226
    618	01A7  0B D2			     or	     dx,dx
    619	01A9  75 0D			     jne     short @6@254
    620	01AB			     @6@226:
    621					;
    622					;	  miniSO_iskey = 1;
    623					;
    624	01AB  C6 06 0003r 01		     mov     byte ptr DGROUP:miniSO_iskey,1
    625					;
    626					;	  miniSO_key = ah;
    627					;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 12
scall.ASM



    628	01B0  8A 46 FE			     mov     al,byte ptr [bp-2]
    629	01B3  A2 0004r			     mov     byte ptr DGROUP:miniSO_key,al
    630					;
    631					;	  al = 0;
    632					;
    633	01B6  33 D2			     xor     dx,dx
    634	01B8			     @6@254:
    635					;
    636					;      }
    637					;      return al;
    638					;
    639	01B8  8B C2			     mov     ax,dx
    640	01BA  EB CA			     jmp     short @6@86
    641	01BC			     @6@282:
    642					;
    643					;    }
    644					;
    645	01BC  8B E5			     mov     sp,bp
    646	01BE  5D			     pop     bp
    647	01BF  C3			     ret
    648	01C0			     _sc_getch	     endp
    649					;
    650					;    int sc_clrscr()
    651					;
    652					     assume  cs:_TEXT
    653	01C0			     _sc_clrscr	     proc    near
    654	01C0  55			     push    bp
    655	01C1  8B EC			     mov     bp,sp
    656					;
    657					;    {
    658					;      mov_al(0);
    659					;
    660	01C3  B0 00			     mov     al,0
    661					;
    662					;      mov_cx(0);
    663					;
    664	01C5  33 C9			     xor     cx,cx
    665					;
    666					;      mov_dh(24);
    667					;
    668	01C7  B6 18			     mov     dh,24
    669					;
    670					;      mov_dl(miniSO_col);
    671					;
    672	01C9  8A 16 0000r		     mov     dl,byte ptr DGROUP:miniSO_col
    673					;
    674					;      dec_dl();
    675					;
    676	01CD  FE CA			     dec      dl
    677					;
    678					;      mov_ah(6);
    679					;
    680	01CF  B4 06			     mov     ah,6
    681					;
    682					;      mov_bh(7);
    683					;
    684	01D1  B7 07			     mov     bh,7
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 13
scall.ASM



    685					;
    686					;      int_10h();
    687					;
    688	01D3  CD 10			     int      10h
    689					;
    690					;      setCursorPosition(0);
    691					;
    692	01D5  33 C0			     xor     ax,ax
    693	01D7  50			     push    ax
    694	01D8  E8 FEC5			     call    near ptr setCursorPosition
    695	01DB  59			     pop     cx
    696					;
    697					;      return 0;
    698					;
    699	01DC  33 C0			     xor     ax,ax
    700	01DE  EB 00			     jmp     short @7@170
    701	01E0			     @7@170:
    702					;
    703					;    }
    704					;
    705	01E0  5D			     pop     bp
    706	01E1  C3			     ret
    707	01E2			     _sc_clrscr	     endp
    708					;
    709					;    int sc_getcolor()
    710					;
    711					     assume  cs:_TEXT
    712	01E2			     _sc_getcolor    proc    near
    713	01E2  55			     push    bp
    714	01E3  8B EC			     mov     bp,sp
    715					;
    716					;    {
    717					;      return miniSO_cor;
    718					;
    719	01E5  A0 0001r			     mov     al,byte ptr DGROUP:miniSO_cor
    720	01E8  98			     cbw
    721	01E9  EB 00			     jmp     short @8@58
    722	01EB			     @8@58:
    723					;
    724					;    }
    725					;
    726	01EB  5D			     pop     bp
    727	01EC  C3			     ret
    728	01ED			     _sc_getcolor    endp
    729					;
    730					;    int sc_setcolor(int cor)
    731					;
    732					     assume  cs:_TEXT
    733	01ED			     _sc_setcolor    proc    near
    734	01ED  55			     push    bp
    735	01EE  8B EC			     mov     bp,sp
    736					;
    737					;    {
    738					;      miniSO_cor = cor;
    739					;
    740	01F0  8A 46 04			     mov     al,byte ptr [bp+4]
    741	01F3  A2 0001r			     mov     byte ptr DGROUP:miniSO_cor,al
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 14
scall.ASM



    742					;
    743					;      return 0;
    744					;
    745	01F6  33 C0			     xor     ax,ax
    746	01F8  EB 00			     jmp     short @9@58
    747	01FA			     @9@58:
    748					;
    749					;    }
    750					;
    751	01FA  5D			     pop     bp
    752	01FB  C3			     ret
    753	01FC			     _sc_setcolor    endp
    754					;
    755					;    int sc_wherex()
    756					;
    757					     assume  cs:_TEXT
    758	01FC			     _sc_wherex	     proc    near
    759	01FC  55			     push    bp
    760	01FD  8B EC			     mov     bp,sp
    761					;
    762					;    {
    763					;      return getCursorPosition() & 0x00ff;
    764					;
    765	01FF  E8 FEAE			     call    near ptr getCursorPosition
    766	0202  25 00FF			     and     ax,255
    767	0205  EB 00			     jmp     short @10@58
    768	0207			     @10@58:
    769					;
    770					;    }
    771					;
    772	0207  5D			     pop     bp
    773	0208  C3			     ret
    774	0209			     _sc_wherex	     endp
    775					;
    776					;    int sc_wherey()
    777					;
    778					     assume  cs:_TEXT
    779	0209			     _sc_wherey	     proc    near
    780	0209  55			     push    bp
    781	020A  8B EC			     mov     bp,sp
    782					;
    783					;    {
    784					;      return (getCursorPosition()>>8) & 0x00ff;
    785					;
    786	020C  E8 FEA1			     call    near ptr getCursorPosition
    787	020F  B1 08			     mov     cl,8
    788	0211  D3 F8			     sar     ax,cl
    789	0213  25 00FF			     and     ax,255
    790	0216  EB 00			     jmp     short @11@58
    791	0218			     @11@58:
    792					;
    793					;    }
    794					;
    795	0218  5D			     pop     bp
    796	0219  C3			     ret
    797	021A			     _sc_wherey	     endp
    798					;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 15
scall.ASM



    799					;    int sc_gotoxy(int x, int y)
    800					;
    801					     assume  cs:_TEXT
    802	021A			     _sc_gotoxy	     proc    near
    803	021A  55			     push    bp
    804	021B  8B EC			     mov     bp,sp
    805	021D  56			     push    si
    806	021E  57			     push    di
    807	021F  8B 76 04			     mov     si,word ptr [bp+4]
    808	0222  8B 7E 06			     mov     di,word ptr [bp+6]
    809					;
    810					;    {
    811					;      x = x & 0x00ff;
    812					;
    813	0225  8B C6			     mov     ax,si
    814	0227  25 00FF			     and     ax,255
    815	022A  8B F0			     mov     si,ax
    816					;
    817					;      y = (y<<8) & 0xff00;
    818					;
    819	022C  8B C7			     mov     ax,di
    820	022E  B1 08			     mov     cl,8
    821	0230  D3 E0			     shl     ax,cl
    822	0232  25 FF00			     and     ax,-256
    823	0235  8B F8			     mov     di,ax
    824					;
    825					;      setCursorPosition(x|y);
    826					;
    827	0237  8B C6			     mov     ax,si
    828	0239  0B C7			     or	     ax,di
    829	023B  50			     push    ax
    830	023C  E8 FE61			     call    near ptr setCursorPosition
    831	023F  59			     pop     cx
    832					;
    833					;      return 0;
    834					;
    835	0240  33 C0			     xor     ax,ax
    836	0242  EB 00			     jmp     short @12@58
    837	0244			     @12@58:
    838					;
    839					;    }
    840					;
    841	0244  5F			     pop     di
    842	0245  5E			     pop     si
    843	0246  5D			     pop     bp
    844	0247  C3			     ret
    845	0248			     _sc_gotoxy	     endp
    846					;
    847					;    int sc_getdate(unsigned seg, unsigned off)
    848					;
    849					     assume  cs:_TEXT
    850	0248			     _sc_getdate     proc    near
    851	0248  55			     push    bp
    852	0249  8B EC			     mov     bp,sp
    853	024B  83 EC 08			     sub     sp,8
    854	024E  56			     push    si
    855					;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 16
scall.ASM



    856					;    {
    857					;      struct date far *dt;
    858					;      unsigned	d,m,a;
    859					;
    860					;      dt = MK_FP(seg,off);
    861					;
    862	024F  FF 76 06			     push    word ptr [bp+6]
    863	0252  FF 76 04			     push    word ptr [bp+4]
    864	0255  E8 0000e			     call    near ptr _MK_FP
    865	0258  59			     pop     cx
    866	0259  59			     pop     cx
    867	025A  89 56 FE			     mov     word ptr [bp-2],dx
    868	025D  89 46 FC			     mov     word ptr [bp-4],ax
    869					;
    870					;      mov_ah(4);
    871					;
    872	0260  B4 04			     mov     ah,4
    873					;
    874					;      int_1ah();
    875					;
    876	0262  CD 1A			     int      1ah
    877					;
    878					;      d=get_dl();
    879					;
    880	0264  8A C2			     mov     al,dl
    881	0266  B4 00			     mov     ah,0
    882	0268  89 46 FA			     mov     word ptr [bp-6],ax
    883					;
    884					;      m=get_dh();
    885					;
    886	026B  8A C6			     mov     al,dh
    887	026D  B4 00			     mov     ah,0
    888	026F  89 46 F8			     mov     word ptr [bp-8],ax
    889					;
    890					;      a=get_cx();
    891					;
    892	0272  8B F1			     mov     si,cx
    893					;
    894					;      dt->da_day  = 10*((d & 0xf0)>>4)	+ (d & 0x0f);
    895					;
    896	0274  8B 46 FA			     mov     ax,word ptr [bp-6]
    897	0277  25 00F0			     and     ax,240
    898	027A  B1 04			     mov     cl,4
    899	027C  D3 E8			     shr     ax,cl
    900	027E  BA 000A			     mov     dx,10
    901	0281  F7 EA			     imul    dx
    902	0283  8A 56 FA			     mov     dl,byte ptr [bp-6]
    903	0286  80 E2 0F			     and     dl,15
    904	0289  02 C2			     add     al,dl
    905	028B  C4 5E FC			     les     bx,dword ptr [bp-4]
    906	028E  26: 88 47	02		     mov     byte ptr es:[bx+2],al
    907					;
    908					;      dt->da_mon  = 10*((m & 0xf0)>>4)	+ (m & 0x0f);
    909					;
    910	0292  8B 46 F8			     mov     ax,word ptr [bp-8]
    911	0295  25 00F0			     and     ax,240
    912	0298  B1 04			     mov     cl,4
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 17
scall.ASM



    913	029A  D3 E8			     shr     ax,cl
    914	029C  BA 000A			     mov     dx,10
    915	029F  F7 EA			     imul    dx
    916	02A1  8A 56 F8			     mov     dl,byte ptr [bp-8]
    917	02A4  80 E2 0F			     and     dl,15
    918	02A7  02 C2			     add     al,dl
    919	02A9  C4 5E FC			     les     bx,dword ptr [bp-4]
    920	02AC  26: 88 47	03		     mov     byte ptr es:[bx+3],al
    921					;
    922					;      dt->da_year = 1000*((a &	0xf000)>>12) + 100*((a & 0x0f00)>>8) + 10*((a &	0x00f0)>>4) +
    923				     + (a & 0x000f);
    924					;
    925	02B0  8B C6			     mov     ax,si
    926	02B2  25 F000			     and     ax,-4096
    927	02B5  B1 0C			     mov     cl,12
    928	02B7  D3 E8			     shr     ax,cl
    929	02B9  BA 03E8			     mov     dx,1000
    930	02BC  F7 EA			     imul    dx
    931	02BE  50			     push    ax
    932	02BF  8B C6			     mov     ax,si
    933	02C1  25 0F00			     and     ax,3840
    934	02C4  B1 08			     mov     cl,8
    935	02C6  D3 E8			     shr     ax,cl
    936	02C8  BA 0064			     mov     dx,100
    937	02CB  F7 EA			     imul    dx
    938	02CD  5A			     pop     dx
    939	02CE  03 D0			     add     dx,ax
    940	02D0  8B C6			     mov     ax,si
    941	02D2  25 00F0			     and     ax,240
    942	02D5  B1 04			     mov     cl,4
    943	02D7  D3 E8			     shr     ax,cl
    944	02D9  BB 000A			     mov     bx,10
    945	02DC  52			     push    dx
    946	02DD  F7 EB			     imul    bx
    947	02DF  5A			     pop     dx
    948	02E0  03 D0			     add     dx,ax
    949	02E2  8B C6			     mov     ax,si
    950	02E4  25 000F			     and     ax,15
    951	02E7  03 D0			     add     dx,ax
    952	02E9  C4 5E FC			     les     bx,dword ptr [bp-4]
    953	02EC  26: 89 17			     mov     word ptr es:[bx],dx
    954					;
    955					;      return 0;
    956					;
    957	02EF  33 C0			     xor     ax,ax
    958	02F1  EB 00			     jmp     short @13@114
    959	02F3			     @13@114:
    960					;
    961					;    }
    962					;
    963	02F3  5E			     pop     si
    964	02F4  8B E5			     mov     sp,bp
    965	02F6  5D			     pop     bp
    966	02F7  C3			     ret
    967	02F8			     _sc_getdate     endp
    968					;
    969					;    int sc_gettime(unsigned seg,unsigned off)
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 18
scall.ASM



    970					;
    971					     assume  cs:_TEXT
    972	02F8			     _sc_gettime     proc    near
    973	02F8  55			     push    bp
    974	02F9  8B EC			     mov     bp,sp
    975	02FB  83 EC 0A			     sub     sp,10
    976					;
    977					;    {
    978					;      struct time far *tm;
    979					;      unsigned	h,m,s;
    980					;
    981					;      tm = MK_FP(seg,off);
    982					;
    983	02FE  FF 76 06			     push    word ptr [bp+6]
    984	0301  FF 76 04			     push    word ptr [bp+4]
    985	0304  E8 0000e			     call    near ptr _MK_FP
    986	0307  59			     pop     cx
    987	0308  59			     pop     cx
    988	0309  89 56 FE			     mov     word ptr [bp-2],dx
    989	030C  89 46 FC			     mov     word ptr [bp-4],ax
    990					;
    991					;      mov_ah(2);
    992					;
    993	030F  B4 02			     mov     ah,2
    994					;
    995					;      int_1ah();
    996					;
    997	0311  CD 1A			     int      1ah
    998					;
    999					;      h=get_ch();
   1000					;
   1001	0313  8A C5			     mov     al,ch
   1002	0315  B4 00			     mov     ah,0
   1003	0317  89 46 FA			     mov     word ptr [bp-6],ax
   1004					;
   1005					;      m=get_cl();
   1006					;
   1007	031A  8A C1			     mov     al,cl
   1008	031C  B4 00			     mov     ah,0
   1009	031E  89 46 F8			     mov     word ptr [bp-8],ax
   1010					;
   1011					;      s=get_dh();
   1012					;
   1013	0321  8A C6			     mov     al,dh
   1014	0323  B4 00			     mov     ah,0
   1015	0325  89 46 F6			     mov     word ptr [bp-10],ax
   1016					;
   1017					;      tm->ti_hour = 10*((h & 0xf0)>>4)	+ (h & 0x0f);
   1018					;
   1019	0328  8B 46 FA			     mov     ax,word ptr [bp-6]
   1020	032B  25 00F0			     and     ax,240
   1021	032E  B1 04			     mov     cl,4
   1022	0330  D3 E8			     shr     ax,cl
   1023	0332  BA 000A			     mov     dx,10
   1024	0335  F7 EA			     imul    dx
   1025	0337  8A 56 FA			     mov     dl,byte ptr [bp-6]
   1026	033A  80 E2 0F			     and     dl,15
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 19
scall.ASM



   1027	033D  02 C2			     add     al,dl
   1028	033F  C4 5E FC			     les     bx,dword ptr [bp-4]
   1029	0342  26: 88 47	01		     mov     byte ptr es:[bx+1],al
   1030					;
   1031					;      tm->ti_min  = 10*((m & 0xf0)>>4)	+ (m & 0x0f);
   1032					;
   1033	0346  8B 46 F8			     mov     ax,word ptr [bp-8]
   1034	0349  25 00F0			     and     ax,240
   1035	034C  B1 04			     mov     cl,4
   1036	034E  D3 E8			     shr     ax,cl
   1037	0350  BA 000A			     mov     dx,10
   1038	0353  F7 EA			     imul    dx
   1039	0355  8A 56 F8			     mov     dl,byte ptr [bp-8]
   1040	0358  80 E2 0F			     and     dl,15
   1041	035B  02 C2			     add     al,dl
   1042	035D  C4 5E FC			     les     bx,dword ptr [bp-4]
   1043	0360  26: 88 07			     mov     byte ptr es:[bx],al
   1044					;
   1045					;      tm->ti_sec  = 10*((s & 0xf0)>>4)	+ (s & 0x0f);
   1046					;
   1047	0363  8B 46 F6			     mov     ax,word ptr [bp-10]
   1048	0366  25 00F0			     and     ax,240
   1049	0369  B1 04			     mov     cl,4
   1050	036B  D3 E8			     shr     ax,cl
   1051	036D  BA 000A			     mov     dx,10
   1052	0370  F7 EA			     imul    dx
   1053	0372  8A 56 F6			     mov     dl,byte ptr [bp-10]
   1054	0375  80 E2 0F			     and     dl,15
   1055	0378  02 C2			     add     al,dl
   1056	037A  C4 5E FC			     les     bx,dword ptr [bp-4]
   1057	037D  26: 88 47	03		     mov     byte ptr es:[bx+3],al
   1058					;
   1059					;      tm->ti_hund = 0;
   1060					;
   1061	0381  C4 5E FC			     les     bx,dword ptr [bp-4]
   1062	0384  26: C6 47	02 00		     mov     byte ptr es:[bx+2],0
   1063					;
   1064					;      return 0;
   1065					;
   1066	0389  33 C0			     xor     ax,ax
   1067	038B  EB 00			     jmp     short @14@114
   1068	038D			     @14@114:
   1069					;
   1070					;    }
   1071					;
   1072	038D  8B E5			     mov     sp,bp
   1073	038F  5D			     pop     bp
   1074	0390  C3			     ret
   1075	0391			     _sc_gettime     endp
   1076					;
   1077					;    void miniSO_contextswitch ()
   1078					;
   1079					     assume  cs:_TEXT
   1080	0391			     _miniSO_contextswitch   proc    near
   1081	0391  55			     push    bp
   1082	0392  8B EC			     mov     bp,sp
   1083					;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 20
scall.ASM



   1084					;    {
   1085					;      if ( miniSO_nextthread == miniSO_NONE )
   1086					;
   1087	0394  83 3E 0004r FF		     cmp     word ptr DGROUP:_miniSO_nextthread,-1
   1088	0399  75 11			     jne     short @15@86
   1089					;
   1090					;	  miniSO_nextthread=miniSO_thread[miniSO_ready].next;
   1091					;
   1092	039B  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1093	039E  BA 001A			     mov     dx,26
   1094	03A1  F7 EA			     imul    dx
   1095	03A3  8B D8			     mov     bx,ax
   1096	03A5  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   1097	03A9  A3 0004r			     mov     word ptr DGROUP:_miniSO_nextthread,ax
   1098	03AC			     @15@86:
   1099					;
   1100					;      /* Se houve alteracao de	thread corrente	... */
   1101					;      if (miniSO_nextthread!=miniSO_ready)  {
   1102					;
   1103	03AC  A1 0004r			     mov     ax,word ptr DGROUP:_miniSO_nextthread
   1104	03AF  3B 06 0007r		     cmp     ax,word ptr DGROUP:_miniSO_ready
   1105	03B3  75 03			     jne     @@1
   1106	03B5  EB 7E 90			     jmp     @15@254
   1107	03B8			     @@1:
   1108					;
   1109					;	  if (miniSO_delcurthread)	    /* Se a thread corrente foi	excluida ... */
   1110					;
   1111	03B8  80 3E 0006r 00		     cmp     byte ptr DGROUP:_miniSO_delcurthread,0
   1112	03BD  74 07			     je	     short @15@170
   1113					;
   1114					;	     miniSO_delcurthread=0;	   /* zera o flag para deletado	e nao captura SS:SP +
   1115				     */
   1116					;
   1117	03BF  C6 06 0006r 00		     mov     byte ptr DGROUP:_miniSO_delcurthread,0
   1118	03C4  EB 3D			     jmp     short @15@226
   1119	03C6			     @15@170:
   1120					;
   1121					;	  else	{
   1122					;	     /*	Salva SS:SP da thread corrente no BCP */
   1123					;	     miniSO_thread[miniSO_ready].ss=_SS;
   1124					;
   1125	03C6  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1126	03C9  BA 001A			     mov     dx,26
   1127	03CC  F7 EA			     imul    dx
   1128	03CE  8B D8			     mov     bx,ax
   1129	03D0  8C 97 000Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+6],ss
   1130					;
   1131					;	     miniSO_thread[miniSO_ready].sp=_SP;
   1132					;
   1133	03D4  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1134	03D7  BA 001A			     mov     dx,26
   1135	03DA  F7 EA			     imul    dx
   1136	03DC  8B D8			     mov     bx,ax
   1137	03DE  89 A7 000Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+8],sp
   1138					;
   1139					;	     if	(miniSO_thread[miniSO_ready].status==RUNNING)
   1140					;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 21
scall.ASM



   1141	03E2  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1142	03E5  BA 001A			     mov     dx,26
   1143	03E8  F7 EA			     imul    dx
   1144	03EA  8B D8			     mov     bx,ax
   1145	03EC  83 BF 000Br 01		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],1
   1146	03F1  75 10			     jne     short @15@226
   1147					;
   1148					;		miniSO_thread[miniSO_ready].status=READY;
   1149					;
   1150	03F3  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1151	03F6  BA 001A			     mov     dx,26
   1152	03F9  F7 EA			     imul    dx
   1153	03FB  8B D8			     mov     bx,ax
   1154	03FD  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   1155	0403			     @15@226:
   1156					;
   1157					;	  }
   1158					;	  /* Atualiza thread corrente */
   1159					;	  miniSO_ready=miniSO_nextthread;
   1160					;
   1161	0403  A1 0004r			     mov     ax,word ptr DGROUP:_miniSO_nextthread
   1162	0406  A3 0007r			     mov     word ptr DGROUP:_miniSO_ready,ax
   1163					;
   1164					;	  miniSO_thread[miniSO_ready].status=RUNNING;
   1165					;
   1166	0409  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1167	040C  BA 001A			     mov     dx,26
   1168	040F  F7 EA			     imul    dx
   1169	0411  8B D8			     mov     bx,ax
   1170	0413  C7 87 000Br 0001		     mov     word ptr DGROUP:_miniSO_thread[bx+4],1
   1171					;
   1172					;	  /* Define SS:SP para a thread	corrente */
   1173					;	  _SS=miniSO_thread[miniSO_ready].ss;
   1174					;
   1175	0419  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1176	041C  BA 001A			     mov     dx,26
   1177	041F  F7 EA			     imul    dx
   1178	0421  8B D8			     mov     bx,ax
   1179	0423  8E 97 000Dr		     mov     ss,word ptr DGROUP:_miniSO_thread[bx+6]
   1180					;
   1181					;	  _SP=miniSO_thread[miniSO_ready].sp;
   1182					;
   1183	0427  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1184	042A  BA 001A			     mov     dx,26
   1185	042D  F7 EA			     imul    dx
   1186	042F  8B D8			     mov     bx,ax
   1187	0431  8B A7 000Fr		     mov     sp,word ptr DGROUP:_miniSO_thread[bx+8]
   1188	0435			     @15@254:
   1189					;
   1190					;
   1191					;      }
   1192					;      miniSO_nextthread = miniSO_NONE;
   1193					;
   1194	0435  C7 06 0004r FFFF		     mov     word ptr DGROUP:_miniSO_nextthread,-1
   1195					;
   1196					;    }
   1197					;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 22
scall.ASM



   1198	043B  5D			     pop     bp
   1199	043C  C3			     ret
   1200	043D			     _miniSO_contextswitch   endp
   1201					;
   1202					;    static void end_mso(char *msg)
   1203					;
   1204					     assume  cs:_TEXT
   1205	043D			     end_mso proc    near
   1206	043D  55			     push    bp
   1207	043E  8B EC			     mov     bp,sp
   1208					;
   1209					;    {
   1210					;      /* Restaura a interrupção do relógio original */
   1211					;      setvect(miniSO_CLOCKINT,miniSO_oldisr);
   1212					;
   1213	0440  FF 36 0002r		     push    word ptr DGROUP:_miniSO_oldisr+2
   1214	0444  FF 36 0000r		     push    word ptr DGROUP:_miniSO_oldisr
   1215	0448  B8 001C			     mov     ax,28
   1216	044B  50			     push    ax
   1217	044C  E8 0000e			     call    near ptr _setvect
   1218	044F  83 C4 06			     add     sp,6
   1219					;
   1220					;      enable();
   1221					;
   1222	0452  E8 0000e			     call    near ptr _enable
   1223					;
   1224					;      putstr("\n\n");
   1225					;
   1226	0455  1E			     push    ds
   1227	0456  B8 0094r			     mov     ax,offset DGROUP:s@
   1228	0459  50			     push    ax
   1229	045A  E8 0000e			     call    near ptr _putstr
   1230	045D  59			     pop     cx
   1231	045E  59			     pop     cx
   1232					;
   1233					;      putstr(msg);
   1234					;
   1235	045F  1E			     push    ds
   1236	0460  FF 76 04			     push    word ptr [bp+4]
   1237	0463  E8 0000e			     call    near ptr _putstr
   1238	0466  59			     pop     cx
   1239	0467  59			     pop     cx
   1240					;
   1241					;      putch('\n');
   1242					;
   1243	0468  B8 000A			     mov     ax,10
   1244	046B  50			     push    ax
   1245	046C  E8 0000e			     call    near ptr _putch
   1246	046F  59			     pop     cx
   1247					;
   1248					;      putstr("Pressione uma tecla para	reiniciar...\n");
   1249					;
   1250	0470  1E			     push    ds
   1251	0471  B8 0097r			     mov     ax,offset DGROUP:s@+3
   1252	0474  50			     push    ax
   1253	0475  E8 0000e			     call    near ptr _putstr
   1254	0478  59			     pop     cx
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 23
scall.ASM



   1255	0479  59			     pop     cx
   1256					;
   1257					;      getch();
   1258					;
   1259	047A  E8 0000e			     call    near ptr _getch
   1260					;
   1261					;      /* Reinicializa a máquina */
   1262					;      sc_reboot();
   1263					;
   1264	047D  E8 0138			     call    near ptr _sc_reboot
   1265					;
   1266					;    }
   1267					;
   1268	0480  5D			     pop     bp
   1269	0481  C3			     ret
   1270	0482			     end_mso endp
   1271					;
   1272					;    static pcb_t get_pcb(pid_t	pid)
   1273					;
   1274					     assume  cs:_TEXT
   1275	0482			     get_pcb proc    near
   1276	0482  55			     push    bp
   1277	0483  8B EC			     mov     bp,sp
   1278					;
   1279					;    {
   1280					;	     pcb_t   pcb;
   1281					;
   1282					;	     for     (pcb=0;pcb<miniSO_MAXTHREADS;++pcb)  {
   1283					;
   1284	0485  33 C9			     xor     cx,cx
   1285	0487  EB 27			     jmp     short @17@198
   1286	0489			     @17@58:
   1287					;
   1288					;		     if	     ( miniSO_thread[pcb].status!=FREE && miniSO_thread		    +
   1289				     [pcb].pid==pid )
   1290					;
   1291	0489  8B C1			     mov     ax,cx
   1292	048B  BA 001A			     mov     dx,26
   1293	048E  F7 EA			     imul    dx
   1294	0490  8B D8			     mov     bx,ax
   1295	0492  83 BF 000Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],-1
   1296	0497  74 16			     je	     short @17@170
   1297	0499  8B C1			     mov     ax,cx
   1298	049B  BA 001A			     mov     dx,26
   1299	049E  F7 EA			     imul    dx
   1300	04A0  8B D8			     mov     bx,ax
   1301	04A2  8B 87 0007r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx]
   1302	04A6  3B 46 04			     cmp     ax,word ptr [bp+4]
   1303	04A9  75 04			     jne     short @17@170
   1304					;
   1305					;			     return pcb;
   1306					;
   1307	04AB  8B C1			     mov     ax,cx
   1308	04AD			     @17@142:
   1309	04AD  EB 0B			     jmp     short @17@254
   1310	04AF			     @17@170:
   1311	04AF  41			     inc     cx
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 24
scall.ASM



   1312	04B0			     @17@198:
   1313	04B0  83 F9 10			     cmp     cx,16
   1314	04B3  7C D4			     jl	     short @17@58
   1315					;
   1316					;	     }
   1317					;	     return -1;
   1318					;
   1319	04B5  B8 FFFF			     mov     ax,-1
   1320	04B8  EB F3			     jmp     short @17@142
   1321	04BA			     @17@254:
   1322					;
   1323					;    }
   1324					;
   1325	04BA  5D			     pop     bp
   1326	04BB  C3			     ret
   1327	04BC			     get_pcb endp
   1328					;
   1329					;    void miniSO_init_semtable()
   1330					;
   1331					     assume  cs:_TEXT
   1332	04BC			     _miniSO_init_semtable   proc    near
   1333	04BC  55			     push    bp
   1334	04BD  8B EC			     mov     bp,sp
   1335					;
   1336					;    {
   1337					;	     int i;
   1338					;
   1339					;	     for     (i=0;i<miniSO_MAXSEMAPHORES;++i)
   1340					;
   1341	04BF  33 C0			     xor     ax,ax
   1342	04C1  EB 0D			     jmp     short @18@114
   1343	04C3			     @18@58:
   1344					;
   1345					;		     miniSO_sem[i].status = FREE;
   1346					;
   1347	04C3  8B D8			     mov     bx,ax
   1348	04C5  B1 03			     mov     cl,3
   1349	04C7  D3 E3			     shl     bx,cl
   1350	04C9  C7 87 01A7r FFFF		     mov     word ptr DGROUP:_miniSO_sem[bx],-1
   1351	04CF  40			     inc     ax
   1352	04D0			     @18@114:
   1353	04D0  3D 000A			     cmp     ax,10
   1354	04D3  7C EE			     jl	     short @18@58
   1355					;
   1356					;    }
   1357					;
   1358	04D5  5D			     pop     bp
   1359	04D6  C3			     ret
   1360	04D7			     _miniSO_init_semtable   endp
   1361					;
   1362					;    void miniSO_init_proctable()
   1363					;
   1364					     assume  cs:_TEXT
   1365	04D7			     _miniSO_init_proctable  proc    near
   1366	04D7  55			     push    bp
   1367	04D8  8B EC			     mov     bp,sp
   1368	04DA  56			     push    si
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 25
scall.ASM



   1369					;
   1370					;    {
   1371					;      pcb_t i;
   1372					;
   1373					;      disable();
   1374					;
   1375	04DB  E8 0000e			     call    near ptr _disable
   1376					;
   1377					;
   1378					;      /* Inicializa a tabela de semaforos */
   1379					;      miniSO_init_semtable();
   1380					;
   1381	04DE  E8 FFDB			     call    near ptr _miniSO_init_semtable
   1382					;
   1383					;      /* Inicializa tabela de threads */
   1384					;      miniSO_ready =  0;
   1385					;
   1386	04E1  C7 06 0007r 0000		     mov     word ptr DGROUP:_miniSO_ready,0
   1387					;
   1388					;      miniSO_thread[miniSO_ready].pid	    = 0;
   1389					;
   1390	04E7  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1391	04EA  BA 001A			     mov     dx,26
   1392	04ED  F7 EA			     imul    dx
   1393	04EF  8B D8			     mov     bx,ax
   1394	04F1  C7 87 0007r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx],0
   1395					;
   1396					;      miniSO_thread[miniSO_ready].ppid	    = -1;
   1397					;
   1398	04F7  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1399	04FA  BA 001A			     mov     dx,26
   1400	04FD  F7 EA			     imul    dx
   1401	04FF  8B D8			     mov     bx,ax
   1402	0501  C7 87 0009r FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+2],-1
   1403					;
   1404					;      miniSO_thread[miniSO_ready].next	    = miniSO_ready;
   1405					;
   1406	0507  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1407	050A  BA 001A			     mov     dx,26
   1408	050D  F7 EA			     imul    dx
   1409	050F  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   1410	0513  8B D8			     mov     bx,ax
   1411	0515  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   1412					;
   1413					;      miniSO_thread[miniSO_ready].prev	    = miniSO_ready;
   1414					;
   1415	0519  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1416	051C  BA 001A			     mov     dx,26
   1417	051F  F7 EA			     imul    dx
   1418	0521  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   1419	0525  8B D8			     mov     bx,ax
   1420	0527  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   1421					;
   1422					;      miniSO_thread[miniSO_ready].status   = RUNNING;
   1423					;
   1424	052B  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1425	052E  BA 001A			     mov     dx,26
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 26
scall.ASM



   1426	0531  F7 EA			     imul    dx
   1427	0533  8B D8			     mov     bx,ax
   1428	0535  C7 87 000Br 0001		     mov     word ptr DGROUP:_miniSO_thread[bx+4],1
   1429					;
   1430					;      miniSO_thread[miniSO_ready].recvsig  = 0;
   1431					;
   1432	053B  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1433	053E  BA 001A			     mov     dx,26
   1434	0541  F7 EA			     imul    dx
   1435	0543  8B D8			     mov     bx,ax
   1436	0545  C7 87 0011r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+10],0
   1437					;
   1438					;      miniSO_thread[miniSO_ready].wait	    = -1;
   1439					;
   1440	054B  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1441	054E  BA 001A			     mov     dx,26
   1442	0551  F7 EA			     imul    dx
   1443	0553  8B D8			     mov     bx,ax
   1444	0555  C7 87 0015r FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+14],-1
   1445					;
   1446					;      miniSO_thread[miniSO_ready].zombies  = -1;
   1447					;
   1448	055B  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1449	055E  BA 001A			     mov     dx,26
   1450	0561  F7 EA			     imul    dx
   1451	0563  8B D8			     mov     bx,ax
   1452	0565  C7 87 001Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+20],-1
   1453					;
   1454					;      /* O resto dos BCPs permanece na	lista de livres	*/
   1455					;      miniSO_free  =  1;
   1456					;
   1457	056B  C7 06 0009r 0001		     mov     word ptr DGROUP:_miniSO_free,1
   1458					;
   1459					;      for ( i=1 ; i<miniSO_MAXTHREADS-1 ; ++i)	 {
   1460					;
   1461	0571  BE 0001			     mov     si,1
   1462	0574  EB 20			     jmp     short @19@114
   1463	0576			     @19@58:
   1464					;
   1465					;	   miniSO_thread[i].next   = i+1;
   1466					;
   1467	0576  8B C6			     mov     ax,si
   1468	0578  BA 001A			     mov     dx,26
   1469	057B  F7 EA			     imul    dx
   1470	057D  8B D6			     mov     dx,si
   1471	057F  42			     inc     dx
   1472	0580  8B D8			     mov     bx,ax
   1473	0582  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   1474					;
   1475					;	   miniSO_thread[i].status = FREE;
   1476					;
   1477	0586  8B C6			     mov     ax,si
   1478	0588  BA 001A			     mov     dx,26
   1479	058B  F7 EA			     imul    dx
   1480	058D  8B D8			     mov     bx,ax
   1481	058F  C7 87 000Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+4],-1
   1482	0595  46			     inc     si
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 27
scall.ASM



   1483	0596			     @19@114:
   1484	0596  83 FE 0F			     cmp     si,15
   1485	0599  7C DB			     jl	     short @19@58
   1486					;
   1487					;      }
   1488					;      miniSO_thread[miniSO_MAXTHREADS-1].next	 = -1;
   1489					;
   1490	059B  C7 06 01A5r FFFF		     mov     word ptr DGROUP:_miniSO_thread+414,-1
   1491					;
   1492					;      miniSO_thread[miniSO_MAXTHREADS-1].status = FREE;
   1493					;
   1494	05A1  C7 06 0191r FFFF		     mov     word ptr DGROUP:_miniSO_thread+394,-1
   1495					;
   1496					;      /* Zera tempos do sistema */
   1497					;      miniSO_delcurthread  = 0;
   1498					;
   1499	05A7  C6 06 0006r 00		     mov     byte ptr DGROUP:_miniSO_delcurthread,0
   1500					;
   1501					;      miniSO_nextthread = miniSO_NONE;
   1502					;
   1503	05AC  C7 06 0004r FFFF		     mov     word ptr DGROUP:_miniSO_nextthread,-1
   1504					;
   1505					;      /* Habilita as interrupcoes e retorna */
   1506					;      enable();
   1507					;
   1508	05B2  E8 0000e			     call    near ptr _enable
   1509					;
   1510					;    }
   1511					;
   1512	05B5  5E			     pop     si
   1513	05B6  5D			     pop     bp
   1514	05B7  C3			     ret
   1515	05B8			     _miniSO_init_proctable  endp
   1516					;
   1517					;    int sc_reboot()
   1518					;
   1519					     assume  cs:_TEXT
   1520	05B8			     _sc_reboot	     proc    near
   1521	05B8  55			     push    bp
   1522	05B9  8B EC			     mov     bp,sp
   1523					;
   1524					;    {
   1525					;	     /*	Restaura a interrupção do relógio original */
   1526					;	     setvect(miniSO_CLOCKINT,miniSO_oldisr);
   1527					;
   1528	05BB  FF 36 0002r		     push    word ptr DGROUP:_miniSO_oldisr+2
   1529	05BF  FF 36 0000r		     push    word ptr DGROUP:_miniSO_oldisr
   1530	05C3  B8 001C			     mov     ax,28
   1531	05C6  50			     push    ax
   1532	05C7  E8 0000e			     call    near ptr _setvect
   1533	05CA  83 C4 06			     add     sp,6
   1534					;
   1535					;	     enable();
   1536					;
   1537	05CD  E8 0000e			     call    near ptr _enable
   1538					;
   1539					;	     asm     {
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 28
scall.ASM



   1540					;		     int     19h
   1541					;
   1542	05D0  CD 19			     int	     19h
   1543					;
   1544					;	     }
   1545					;	     return 0;
   1546					;
   1547	05D2  33 C0			     xor     ax,ax
   1548	05D4  EB 00			     jmp     short @20@114
   1549	05D6			     @20@114:
   1550					;
   1551					;    }
   1552					;
   1553	05D6  5D			     pop     bp
   1554	05D7  C3			     ret
   1555	05D8			     _sc_reboot	     endp
   1556	05D8			     _TEXT   ends
   1557	0092			     _DATA   segment word public 'DATA'
   1558	0092  01			     db	     1
   1559	0093  00			     db	     0
   1560	0094			     _DATA   ends
   1561	05D8			     _TEXT   segment byte public 'CODE'
   1562					;
   1563					;    int sc_fork(unsigned cs, unsigned ip)
   1564					;
   1565					     assume  cs:_TEXT
   1566	05D8			     _sc_fork	     proc    near
   1567	05D8  55			     push    bp
   1568	05D9  8B EC			     mov     bp,sp
   1569	05DB  83 EC 06			     sub     sp,6
   1570	05DE  56			     push    si
   1571	05DF  57			     push    di
   1572					;
   1573					;    {
   1574					;	     pid_t	     pid;
   1575					;	     pcb_t	     pcb,last;
   1576					;	     unsigned far *  stack;
   1577					;	     static pid_t    nextpid=1;	/* Número do próximo pid */
   1578					;	     extern void     miniSO_return_addr(void);
   1579					;
   1580					;	     /*	Se o nucleo esta' instalado e existem BCPs livres insere no fim	da lista ...+
   1581				     */
   1582					;	     if	     (miniSO_free == -1)
   1583					;
   1584	05E0  83 3E 0009r FF		     cmp     word ptr DGROUP:_miniSO_free,-1
   1585	05E5  75 06			     jne     short @21@114
   1586					;
   1587					;		     return miniSO_ERROR;
   1588					;
   1589	05E7  B8 FFFF			     mov     ax,-1
   1590	05EA			     @21@86:
   1591	05EA  E9 0241			     jmp     @21@338
   1592	05ED			     @21@114:
   1593					;
   1594					;	     disable();
   1595					;
   1596	05ED  E8 0000e			     call    near ptr _disable
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 29
scall.ASM



   1597					;
   1598					;	     /*	Gera um	pid para a thread */
   1599					;	     pcb = 0;
   1600					;
   1601	05F0  33 F6			     xor     si,si
   1602	05F2  EB 27			     jmp     short @21@282
   1603	05F4			     @21@142:
   1604					;
   1605					;	     while   (pcb!=-1)	{
   1606					;		     pcb = get_pcb (nextpid);
   1607					;
   1608	05F4  FF 36 0092r		     push    word ptr DGROUP:d@w+146
   1609	05F8  E8 FE87			     call    near ptr get_pcb
   1610	05FB  59			     pop     cx
   1611	05FC  8B F0			     mov     si,ax
   1612					;
   1613					;		     if	     (pcb==-1)
   1614					;
   1615	05FE  83 FE FF			     cmp     si,-1
   1616	0601  75 04			     jne     short @21@198
   1617					;
   1618					;			     pid = nextpid;
   1619					;
   1620	0603  8B 3E 0092r		     mov     di,word ptr DGROUP:d@w+146
   1621	0607			     @21@198:
   1622					;
   1623					;		     if	     (nextpid==32767)
   1624					;
   1625	0607  81 3E 0092r 7FFF		     cmp     word ptr DGROUP:d@w+146,32767
   1626	060D  75 08			     jne     short @21@254
   1627					;
   1628					;			     nextpid=1;
   1629					;
   1630	060F  C7 06 0092r 0001		     mov     word ptr DGROUP:d@w+146,1
   1631	0615  EB 04			     jmp     short @21@282
   1632	0617			     @21@254:
   1633					;
   1634					;		     else
   1635					;			     nextpid++;
   1636					;
   1637	0617  FF 06 0092r		     inc     word ptr DGROUP:d@w+146
   1638	061B			     @21@282:
   1639	061B  83 FE FF			     cmp     si,-1
   1640	061E  75 D4			     jne     short @21@142
   1641					;
   1642					;	     }
   1643					;	     /*	Retira um BCP da lista de BCPs livres */
   1644					;	     pcb     = miniSO_free;
   1645					;
   1646	0620  8B 36 0009r		     mov     si,word ptr DGROUP:_miniSO_free
   1647					;
   1648					;	     miniSO_free = miniSO_thread[miniSO_free].next;
   1649					;
   1650	0624  A1 0009r			     mov     ax,word ptr DGROUP:_miniSO_free
   1651	0627  BA 001A			     mov     dx,26
   1652	062A  F7 EA			     imul    dx
   1653	062C  8B D8			     mov     bx,ax
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 30
scall.ASM



   1654	062E  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   1655	0632  A3 0009r			     mov     word ptr DGROUP:_miniSO_free,ax
   1656					;
   1657					;	     miniSO_thread[pcb].pid = pid;
   1658					;
   1659	0635  8B C6			     mov     ax,si
   1660	0637  BA 001A			     mov     dx,26
   1661	063A  F7 EA			     imul    dx
   1662	063C  8B D8			     mov     bx,ax
   1663	063E  89 BF 0007r		     mov     word ptr DGROUP:_miniSO_thread[bx],di
   1664					;
   1665					;	     miniSO_thread[pcb].ppid = miniSO_thread[miniSO_ready].pid;
   1666					;
   1667	0642  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1668	0645  BA 001A			     mov     dx,26
   1669	0648  F7 EA			     imul    dx
   1670	064A  8B D8			     mov     bx,ax
   1671	064C  8B 87 0007r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx]
   1672	0650  50			     push    ax
   1673	0651  8B C6			     mov     ax,si
   1674	0653  BA 001A			     mov     dx,26
   1675	0656  F7 EA			     imul    dx
   1676	0658  8B D8			     mov     bx,ax
   1677	065A  58			     pop     ax
   1678	065B  89 87 0009r		     mov     word ptr DGROUP:_miniSO_thread[bx+2],ax
   1679					;
   1680					;	     /*	Cria pilha da thread */
   1681					;	     stack=(unsigned far *)MK_FP(miniSO_INITSTACKS+(miniSO_STACKSIZE>>4)*	    +
   1682				     (miniSO_MAXTHREADS-1-pcb),miniSO_STACKSIZE);
   1683					;
   1684	065F  B8 0600			     mov     ax,1536
   1685	0662  50			     push    ax
   1686	0663  B8 000F			     mov     ax,15
   1687	0666  2B C6			     sub     ax,si
   1688	0668  BA 0060			     mov     dx,96
   1689	066B  F7 EA			     imul    dx
   1690	066D  05 0D00			     add     ax,3328
   1691	0670  50			     push    ax
   1692	0671  E8 0000e			     call    near ptr _MK_FP
   1693	0674  59			     pop     cx
   1694	0675  59			     pop     cx
   1695	0676  89 56 FC			     mov     word ptr [bp-4],dx
   1696	0679  89 46 FA			     mov     word ptr [bp-6],ax
   1697					;
   1698					;	     /*	Empilha	o endereco da funcao sc_exit, de modo que se	*/
   1699					;	     /*	 a thread sair da funcao sem chamar sc_exit, a thread */
   1700					;	     /*	 seja automaticamente excluida */
   1701					;	     *(--stack)=0; /* Empilha código de	fim a ser enviado para sc_exit */
   1702					;
   1703	067C  83 6E FA 02		     sub     word ptr [bp-6],2
   1704	0680  C4 5E FA			     les     bx,dword ptr [bp-6]
   1705	0683  26: C7 07	0000		     mov     word ptr es:[bx],0
   1706					;
   1707					;	     *(--stack)=miniSO_CODESEGMENT;
   1708					;
   1709	0688  83 6E FA 02		     sub     word ptr [bp-6],2
   1710	068C  C4 5E FA			     les     bx,dword ptr [bp-6]
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 31
scall.ASM



   1711	068F  26: C7 07	07E0		     mov     word ptr es:[bx],2016
   1712					;
   1713					;	     *(--stack)=(unsigned)sc_exit;
   1714					;
   1715	0694  83 6E FA 02		     sub     word ptr [bp-6],2
   1716	0698  C4 5E FA			     les     bx,dword ptr [bp-6]
   1717	069B  26: C7 07	0E83r		     mov     word ptr es:[bx],offset _sc_exit
   1718					;
   1719					;	     *(--stack)=0x0200 ;       /* FLAGS	*/
   1720					;
   1721	06A0  83 6E FA 02		     sub     word ptr [bp-6],2
   1722	06A4  C4 5E FA			     les     bx,dword ptr [bp-6]
   1723	06A7  26: C7 07	0200		     mov     word ptr es:[bx],512
   1724					;
   1725					;	     *(--stack)=cs;	       /* CS */
   1726					;
   1727	06AC  83 6E FA 02		     sub     word ptr [bp-6],2
   1728	06B0  C4 5E FA			     les     bx,dword ptr [bp-6]
   1729	06B3  8B 46 04			     mov     ax,word ptr [bp+4]
   1730	06B6  26: 89 07			     mov     word ptr es:[bx],ax
   1731					;
   1732					;	     *(--stack)=ip;	       /* IP */
   1733					;
   1734	06B9  83 6E FA 02		     sub     word ptr [bp-6],2
   1735	06BD  C4 5E FA			     les     bx,dword ptr [bp-6]
   1736	06C0  8B 46 06			     mov     ax,word ptr [bp+6]
   1737	06C3  26: 89 07			     mov     word ptr es:[bx],ax
   1738					;
   1739					;	     *(--stack)=0;	       /* AX */
   1740					;
   1741	06C6  83 6E FA 02		     sub     word ptr [bp-6],2
   1742	06CA  C4 5E FA			     les     bx,dword ptr [bp-6]
   1743	06CD  26: C7 07	0000		     mov     word ptr es:[bx],0
   1744					;
   1745					;	     *(--stack)=0;	       /* BX */
   1746					;
   1747	06D2  83 6E FA 02		     sub     word ptr [bp-6],2
   1748	06D6  C4 5E FA			     les     bx,dword ptr [bp-6]
   1749	06D9  26: C7 07	0000		     mov     word ptr es:[bx],0
   1750					;
   1751					;	     *(--stack)=0;	       /* CX */
   1752					;
   1753	06DE  83 6E FA 02		     sub     word ptr [bp-6],2
   1754	06E2  C4 5E FA			     les     bx,dword ptr [bp-6]
   1755	06E5  26: C7 07	0000		     mov     word ptr es:[bx],0
   1756					;
   1757					;	     *(--stack)=0;	       /* DX */
   1758					;
   1759	06EA  83 6E FA 02		     sub     word ptr [bp-6],2
   1760	06EE  C4 5E FA			     les     bx,dword ptr [bp-6]
   1761	06F1  26: C7 07	0000		     mov     word ptr es:[bx],0
   1762					;
   1763					;	     *(--stack)=0;	       /* ES */
   1764					;
   1765	06F6  83 6E FA 02		     sub     word ptr [bp-6],2
   1766	06FA  C4 5E FA			     les     bx,dword ptr [bp-6]
   1767	06FD  26: C7 07	0000		     mov     word ptr es:[bx],0
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 32
scall.ASM



   1768					;
   1769					;	     *(--stack)=miniSO_DATASEGMENT;/* DS */
   1770					;
   1771	0702  83 6E FA 02		     sub     word ptr [bp-6],2
   1772	0706  C4 5E FA			     les     bx,dword ptr [bp-6]
   1773	0709  26: C7 07	0B9B		     mov     word ptr es:[bx],2971
   1774					;
   1775					;	     *(--stack)=0;	       /* SI */
   1776					;
   1777	070E  83 6E FA 02		     sub     word ptr [bp-6],2
   1778	0712  C4 5E FA			     les     bx,dword ptr [bp-6]
   1779	0715  26: C7 07	0000		     mov     word ptr es:[bx],0
   1780					;
   1781					;	     *(--stack)=0;	       /* DI */
   1782					;
   1783	071A  83 6E FA 02		     sub     word ptr [bp-6],2
   1784	071E  C4 5E FA			     les     bx,dword ptr [bp-6]
   1785	0721  26: C7 07	0000		     mov     word ptr es:[bx],0
   1786					;
   1787					;	     *(--stack)=0;	       /* BP */
   1788					;
   1789	0726  83 6E FA 02		     sub     word ptr [bp-6],2
   1790	072A  C4 5E FA			     les     bx,dword ptr [bp-6]
   1791	072D  26: C7 07	0000		     mov     word ptr es:[bx],0
   1792					;
   1793					;	     *(--stack)=(unsigned)miniSO_return_addr;
   1794					;
   1795	0732  83 6E FA 02		     sub     word ptr [bp-6],2
   1796	0736  C4 5E FA			     les     bx,dword ptr [bp-6]
   1797	0739  26: C7 07	0000e		     mov     word ptr es:[bx],offset _miniSO_return_addr
   1798					;
   1799					;	     *(--stack)=0;	       /* BP */
   1800					;
   1801	073E  83 6E FA 02		     sub     word ptr [bp-6],2
   1802	0742  C4 5E FA			     les     bx,dword ptr [bp-6]
   1803	0745  26: C7 07	0000		     mov     word ptr es:[bx],0
   1804					;
   1805					;	     /*	Inicializa campos da nova thread */
   1806					;	     miniSO_thread[pcb].ss	 = FP_SEG(stack);
   1807					;
   1808	074A  FF 76 FC			     push    word ptr [bp-4]
   1809	074D  FF 76 FA			     push    word ptr [bp-6]
   1810	0750  E8 0000e			     call    near ptr _FP_SEG
   1811	0753  59			     pop     cx
   1812	0754  59			     pop     cx
   1813	0755  50			     push    ax
   1814	0756  8B C6			     mov     ax,si
   1815	0758  BA 001A			     mov     dx,26
   1816	075B  F7 EA			     imul    dx
   1817	075D  8B D8			     mov     bx,ax
   1818	075F  58			     pop     ax
   1819	0760  89 87 000Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+6],ax
   1820					;
   1821					;	     miniSO_thread[pcb].sp	 = FP_OFF(stack);
   1822					;
   1823	0764  FF 76 FC			     push    word ptr [bp-4]
   1824	0767  FF 76 FA			     push    word ptr [bp-6]
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 33
scall.ASM



   1825	076A  E8 0000e			     call    near ptr _FP_OFF
   1826	076D  59			     pop     cx
   1827	076E  59			     pop     cx
   1828	076F  50			     push    ax
   1829	0770  8B C6			     mov     ax,si
   1830	0772  BA 001A			     mov     dx,26
   1831	0775  F7 EA			     imul    dx
   1832	0777  8B D8			     mov     bx,ax
   1833	0779  58			     pop     ax
   1834	077A  89 87 000Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+8],ax
   1835					;
   1836					;	     miniSO_thread[pcb].status	 = READY;
   1837					;
   1838	077E  8B C6			     mov     ax,si
   1839	0780  BA 001A			     mov     dx,26
   1840	0783  F7 EA			     imul    dx
   1841	0785  8B D8			     mov     bx,ax
   1842	0787  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   1843					;
   1844					;	     miniSO_thread[pcb].recvsig	 = 0;
   1845					;
   1846	078D  8B C6			     mov     ax,si
   1847	078F  BA 001A			     mov     dx,26
   1848	0792  F7 EA			     imul    dx
   1849	0794  8B D8			     mov     bx,ax
   1850	0796  C7 87 0011r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+10],0
   1851					;
   1852					;	     miniSO_thread[pcb].waitsig	 = 0;
   1853					;
   1854	079C  8B C6			     mov     ax,si
   1855	079E  BA 001A			     mov     dx,26
   1856	07A1  F7 EA			     imul    dx
   1857	07A3  8B D8			     mov     bx,ax
   1858	07A5  C7 87 0013r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+12],0
   1859					;
   1860					;	     miniSO_thread[pcb].wait	 = -1;
   1861					;
   1862	07AB  8B C6			     mov     ax,si
   1863	07AD  BA 001A			     mov     dx,26
   1864	07B0  F7 EA			     imul    dx
   1865	07B2  8B D8			     mov     bx,ax
   1866	07B4  C7 87 0015r FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+14],-1
   1867					;
   1868					;	     miniSO_thread[pcb].waitfor	 = -1;
   1869					;
   1870	07BA  8B C6			     mov     ax,si
   1871	07BC  BA 001A			     mov     dx,26
   1872	07BF  F7 EA			     imul    dx
   1873	07C1  8B D8			     mov     bx,ax
   1874	07C3  C7 87 0017r FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+16],-1
   1875					;
   1876					;	     miniSO_thread[pcb].zombies	 = -1;
   1877					;
   1878	07C9  8B C6			     mov     ax,si
   1879	07CB  BA 001A			     mov     dx,26
   1880	07CE  F7 EA			     imul    dx
   1881	07D0  8B D8			     mov     bx,ax
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 34
scall.ASM



   1882	07D2  C7 87 001Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+20],-1
   1883					;
   1884					;	     /*	Descobre qual a	ultima thread */
   1885					;	     last = miniSO_thread[miniSO_ready].prev;
   1886					;
   1887	07D8  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1888	07DB  BA 001A			     mov     dx,26
   1889	07DE  F7 EA			     imul    dx
   1890	07E0  8B D8			     mov     bx,ax
   1891	07E2  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   1892	07E6  89 46 FE			     mov     word ptr [bp-2],ax
   1893					;
   1894					;	     /*	Acerta links para incluir a nova thread	*/
   1895					;	     miniSO_thread[pcb].prev	  = last;
   1896					;
   1897	07E9  8B C6			     mov     ax,si
   1898	07EB  BA 001A			     mov     dx,26
   1899	07EE  F7 EA			     imul    dx
   1900	07F0  8B 56 FE			     mov     dx,word ptr [bp-2]
   1901	07F3  8B D8			     mov     bx,ax
   1902	07F5  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   1903					;
   1904					;	     miniSO_thread[pcb].next	  = miniSO_ready;
   1905					;
   1906	07F9  8B C6			     mov     ax,si
   1907	07FB  BA 001A			     mov     dx,26
   1908	07FE  F7 EA			     imul    dx
   1909	0800  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   1910	0804  8B D8			     mov     bx,ax
   1911	0806  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   1912					;
   1913					;	     miniSO_thread[last].next	  = pcb;
   1914					;
   1915	080A  8B 46 FE			     mov     ax,word ptr [bp-2]
   1916	080D  BA 001A			     mov     dx,26
   1917	0810  F7 EA			     imul    dx
   1918	0812  8B D8			     mov     bx,ax
   1919	0814  89 B7 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],si
   1920					;
   1921					;	     miniSO_thread[miniSO_ready].prev =	pcb;
   1922					;
   1923	0818  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   1924	081B  BA 001A			     mov     dx,26
   1925	081E  F7 EA			     imul    dx
   1926	0820  8B D8			     mov     bx,ax
   1927	0822  89 B7 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],si
   1928					;
   1929					;	     enable();
   1930					;
   1931	0826  E8 0000e			     call    near ptr _enable
   1932					;
   1933					;	     return pid;
   1934					;
   1935	0829  8B C7			     mov     ax,di
   1936	082B  E9 FDBC			     jmp     @21@86
   1937	082E			     @21@338:
   1938					;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 35
scall.ASM



   1939					;    }
   1940					;
   1941	082E  5F			     pop     di
   1942	082F  5E			     pop     si
   1943	0830  8B E5			     mov     sp,bp
   1944	0832  5D			     pop     bp
   1945	0833  C3			     ret
   1946	0834			     _sc_fork	     endp
   1947					;
   1948					;    int sc_kill(pid_t pid)
   1949					;
   1950					     assume  cs:_TEXT
   1951	0834			     _sc_kill	     proc    near
   1952	0834  55			     push    bp
   1953	0835  8B EC			     mov     bp,sp
   1954	0837  83 EC 08			     sub     sp,8
   1955	083A  56			     push    si
   1956	083B  57			     push    di
   1957					;
   1958					;    {
   1959					;	     pcb_t pcb,pcbw,last,prevthread,nextthread,pai,i,ant;
   1960					;
   1961					;	     disable();
   1962					;
   1963	083C  E8 0000e			     call    near ptr _disable
   1964					;
   1965					;	     /*	Se remover a thread 0 ... */
   1966					;	     if	     (pid==0)
   1967					;
   1968	083F  83 7E 04 00		     cmp     word ptr [bp+4],0
   1969	0843  75 08			     jne     short @22@86
   1970					;
   1971					;		     end_mso("kill(): thread 0 excluida!");
   1972					;
   1973	0845  B8 00BEr			     mov     ax,offset DGROUP:s@+42
   1974	0848  50			     push    ax
   1975	0849  E8 FBF1			     call    near ptr end_mso
   1976	084C  59			     pop     cx
   1977	084D			     @22@86:
   1978					;
   1979					;	     /*	Tem que	verificar se existe a thread */
   1980					;	     pcb = get_pcb(pid);
   1981					;
   1982	084D  FF 76 04			     push    word ptr [bp+4]
   1983	0850  E8 FC2F			     call    near ptr get_pcb
   1984	0853  59			     pop     cx
   1985	0854  8B F0			     mov     si,ax
   1986					;
   1987					;	     /*	Se nao existe uma thread com este numero, entao	retorna	*/
   1988					;	     if	     (pcb==-1)	{
   1989					;
   1990	0856  83 FE FF			     cmp     si,-1
   1991	0859  75 09			     jne     short @22@170
   1992	085B			     @22@114:
   1993					;
   1994					;		     enable();
   1995					;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 36
scall.ASM



   1996	085B  E8 0000e			     call    near ptr _enable
   1997					;
   1998					;		     return miniSO_ERROR;
   1999					;
   2000	085E  B8 FFFF			     mov     ax,-1
   2001	0861			     @22@142:
   2002	0861  E9 02B8			     jmp     @22@1206
   2003	0864			     @22@170:
   2004	0864  EB 40			     jmp     short @22@226
   2005	0866			     @22@198:
   2006					;
   2007					;	     }
   2008					;	     /*	Trata os zumbis	do processo, colocando-os na lista de livres */
   2009					;	     i = miniSO_thread[pcb].zombies;
   2010					;	     while   (i!= -1)  {
   2011					;		     miniSO_thread[pcb].zombies	= miniSO_thread[i].next;
   2012					;
   2013	0866  8B C7			     mov     ax,di
   2014	0868  BA 001A			     mov     dx,26
   2015	086B  F7 EA			     imul    dx
   2016	086D  8B D8			     mov     bx,ax
   2017	086F  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   2018	0873  50			     push    ax
   2019	0874  8B C6			     mov     ax,si
   2020	0876  BA 001A			     mov     dx,26
   2021	0879  F7 EA			     imul    dx
   2022	087B  8B D8			     mov     bx,ax
   2023	087D  58			     pop     ax
   2024	087E  89 87 001Br		     mov     word ptr DGROUP:_miniSO_thread[bx+20],ax
   2025					;
   2026					;		     miniSO_thread[i].next   = miniSO_free;
   2027					;
   2028	0882  8B C7			     mov     ax,di
   2029	0884  BA 001A			     mov     dx,26
   2030	0887  F7 EA			     imul    dx
   2031	0889  8B 16 0009r		     mov     dx,word ptr DGROUP:_miniSO_free
   2032	088D  8B D8			     mov     bx,ax
   2033	088F  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2034					;
   2035					;		     miniSO_free	     = i;
   2036					;
   2037	0893  89 3E 0009r		     mov     word ptr DGROUP:_miniSO_free,di
   2038					;
   2039					;		     miniSO_thread[i].status = FREE;
   2040					;
   2041	0897  8B C7			     mov     ax,di
   2042	0899  BA 001A			     mov     dx,26
   2043	089C  F7 EA			     imul    dx
   2044	089E  8B D8			     mov     bx,ax
   2045	08A0  C7 87 000Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+4],-1
   2046					;
   2047					;		     i = miniSO_thread[pcb].zombies;
   2048					;
   2049	08A6			     @22@226:
   2050	08A6  8B C6			     mov     ax,si
   2051	08A8  BA 001A			     mov     dx,26
   2052	08AB  F7 EA			     imul    dx
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 37
scall.ASM



   2053	08AD  8B D8			     mov     bx,ax
   2054	08AF  8B BF 001Br		     mov     di,word ptr DGROUP:_miniSO_thread[bx+20]
   2055	08B3  83 FF FF			     cmp     di,-1
   2056	08B6  75 AE			     jne     short @22@198
   2057					;
   2058					;	     }
   2059					;	     /*	Passa os filhos	do processo para o avo */
   2060					;	     for     (i=0;i<miniSO_MAXTHREADS;++i)  {
   2061					;
   2062	08B8  33 FF			     xor     di,di
   2063	08BA  EB 4B			     jmp     short @22@422
   2064	08BC			     @22@310:
   2065					;
   2066					;		     if	     (miniSO_thread[i].status!=FREE && miniSO_thread[i].ppid ==	    +
   2067				     miniSO_thread[pcb].pid)
   2068					;
   2069	08BC  8B C7			     mov     ax,di
   2070	08BE  BA 001A			     mov     dx,26
   2071	08C1  F7 EA			     imul    dx
   2072	08C3  8B D8			     mov     bx,ax
   2073	08C5  83 BF 000Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],-1
   2074	08CA  74 3A			     je	     short @22@394
   2075	08CC  8B C7			     mov     ax,di
   2076	08CE  BA 001A			     mov     dx,26
   2077	08D1  F7 EA			     imul    dx
   2078	08D3  8B D8			     mov     bx,ax
   2079	08D5  8B 87 0009r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+2]
   2080	08D9  50			     push    ax
   2081	08DA  8B C6			     mov     ax,si
   2082	08DC  BA 001A			     mov     dx,26
   2083	08DF  F7 EA			     imul    dx
   2084	08E1  8B D8			     mov     bx,ax
   2085	08E3  58			     pop     ax
   2086	08E4  3B 87 0007r		     cmp     ax,word ptr DGROUP:_miniSO_thread[bx]
   2087	08E8  75 1C			     jne     short @22@394
   2088					;
   2089					;			     miniSO_thread[i].ppid = miniSO_thread[pcb].ppid;
   2090					;
   2091	08EA  8B C6			     mov     ax,si
   2092	08EC  BA 001A			     mov     dx,26
   2093	08EF  F7 EA			     imul    dx
   2094	08F1  8B D8			     mov     bx,ax
   2095	08F3  8B 87 0009r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+2]
   2096	08F7  50			     push    ax
   2097	08F8  8B C7			     mov     ax,di
   2098	08FA  BA 001A			     mov     dx,26
   2099	08FD  F7 EA			     imul    dx
   2100	08FF  8B D8			     mov     bx,ax
   2101	0901  58			     pop     ax
   2102	0902  89 87 0009r		     mov     word ptr DGROUP:_miniSO_thread[bx+2],ax
   2103	0906			     @22@394:
   2104	0906  47			     inc     di
   2105	0907			     @22@422:
   2106	0907  83 FF 10			     cmp     di,16
   2107	090A  7C B0			     jl	     short @22@310
   2108					;
   2109					;	     }
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 38
scall.ASM



   2110					;	     /*	Salva anterior e proximo da thread que sera deletada */
   2111					;	     prevthread	= miniSO_thread[pcb].prev;
   2112					;
   2113	090C  8B C6			     mov     ax,si
   2114	090E  BA 001A			     mov     dx,26
   2115	0911  F7 EA			     imul    dx
   2116	0913  8B D8			     mov     bx,ax
   2117	0915  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   2118	0919  89 46 FC			     mov     word ptr [bp-4],ax
   2119					;
   2120					;	     nextthread	= miniSO_thread[pcb].next;
   2121					;
   2122	091C  8B C6			     mov     ax,si
   2123	091E  BA 001A			     mov     dx,26
   2124	0921  F7 EA			     imul    dx
   2125	0923  8B D8			     mov     bx,ax
   2126	0925  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   2127	0929  89 46 FA			     mov     word ptr [bp-6],ax
   2128					;
   2129					;	     /*	A thread pode estar em um de varios estados... */
   2130					;	     switch  (miniSO_thread[pcb].status)  {
   2131					;
   2132	092C  8B C6			     mov     ax,si
   2133	092E  BA 001A			     mov     dx,26
   2134	0931  F7 EA			     imul    dx
   2135	0933  8B D8			     mov     bx,ax
   2136	0935  8B 9F 000Br		     mov     bx,word ptr DGROUP:_miniSO_thread[bx+4]
   2137	0939  83 FB 06			     cmp     bx,6
   2138	093C  77 53			     ja	     short @22@758
   2139	093E  D1 E3			     shl     bx,1
   2140	0940  2E: FF A7	0B22r		     jmp     word ptr cs:@22@C1266[bx]
   2141	0945			     @22@562:
   2142					;
   2143					;		     case    READY:
   2144					;		     case    RUNNING:
   2145					;			     /*	Exclui o nodo da lista de prontos */
   2146					;			     miniSO_thread[prevthread].next=nextthread;
   2147					;
   2148	0945  8B 46 FC			     mov     ax,word ptr [bp-4]
   2149	0948  BA 001A			     mov     dx,26
   2150	094B  F7 EA			     imul    dx
   2151	094D  8B 56 FA			     mov     dx,word ptr [bp-6]
   2152	0950  8B D8			     mov     bx,ax
   2153	0952  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2154					;
   2155					;			     miniSO_thread[nextthread].prev=prevthread;
   2156					;
   2157	0956  8B 46 FA			     mov     ax,word ptr [bp-6]
   2158	0959  BA 001A			     mov     dx,26
   2159	095C  F7 EA			     imul    dx
   2160	095E  8B 56 FC			     mov     dx,word ptr [bp-4]
   2161	0961  8B D8			     mov     bx,ax
   2162	0963  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   2163					;
   2164					;			     if	     (pcb==miniSO_ready)  {
   2165					;
   2166	0967  3B 36 0007r		     cmp     si,word ptr DGROUP:_miniSO_ready
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 39
scall.ASM



   2167	096B  75 1E			     jne     short @22@674
   2168					;
   2169					;				     if	     (nextthread==miniSO_ready)
   2170					;
   2171	096D  8B 46 FA			     mov     ax,word ptr [bp-6]
   2172	0970  3B 06 0007r		     cmp     ax,word ptr DGROUP:_miniSO_ready
   2173	0974  75 0A			     jne     short @22@646
   2174					;
   2175					;					     end_mso("kill(): nao ha' mais threads	    +
   2176				     executando!");
   2177					;
   2178	0976  B8 00D9r			     mov     ax,offset DGROUP:s@+69
   2179	0979  50			     push    ax
   2180	097A  E8 FAC0			     call    near ptr end_mso
   2181	097D  59			     pop     cx
   2182	097E  EB 0B			     jmp     short @22@674
   2183	0980			     @22@646:
   2184					;
   2185					;				     else  {
   2186					;					     miniSO_nextthread=nextthread;
   2187					;
   2188	0980  8B 46 FA			     mov     ax,word ptr [bp-6]
   2189	0983  A3 0004r			     mov     word ptr DGROUP:_miniSO_nextthread,ax
   2190					;
   2191					;					     miniSO_delcurthread=1;
   2192					;
   2193	0986  C6 06 0006r 01		     mov     byte ptr DGROUP:_miniSO_delcurthread,1
   2194	098B			     @22@674:
   2195					;
   2196					;				     }
   2197					;			     }
   2198					;			     break;
   2199					;
   2200	098B  EB 07			     jmp     short @22@786
   2201	098D			     @22@702:
   2202					;
   2203					;		     case    WAITSEM:
   2204					;			     /*	Exclui o nodo da lista do semaforo */
   2205					;			     break;
   2206					;
   2207	098D  EB 05			     jmp     short @22@786
   2208	098F			     @22@730:
   2209					;
   2210					;		     case    WAIT:
   2211					;		     case    WAITSIG:
   2212					;	     case    STOPPED:
   2213					;			     break;
   2214					;
   2215	098F  EB 03			     jmp     short @22@786
   2216	0991			     @22@758:
   2217	0991  E9 FEC7			     jmp     @22@114
   2218	0994			     @22@786:
   2219					;
   2220					;		     case    ZOMBIE:
   2221					;		     default:
   2222					;			     enable();
   2223					;			     return miniSO_ERROR;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 40
scall.ASM



   2224					;	     }
   2225					;	     /*	Coloca o BCP da	thread na lista	de filhos zumbis do pai	*/
   2226					;	     pai = get_pcb(miniSO_thread[pcb].ppid);
   2227					;
   2228	0994  8B C6			     mov     ax,si
   2229	0996  BA 001A			     mov     dx,26
   2230	0999  F7 EA			     imul    dx
   2231	099B  8B D8			     mov     bx,ax
   2232	099D  FF B7 0009r		     push    word ptr DGROUP:_miniSO_thread[bx+2]
   2233	09A1  E8 FADE			     call    near ptr get_pcb
   2234	09A4  59			     pop     cx
   2235	09A5  89 46 F8			     mov     word ptr [bp-8],ax
   2236					;
   2237					;	     if	     (pai==-1) { /* Se nao encontrou o pai, */
   2238					;
   2239	09A8  83 7E F8 FF		     cmp     word ptr [bp-8],-1
   2240	09AC  75 27			     jne     short @22@842
   2241					;
   2242					;		     /*	coloca o processo na lista de livres */
   2243					;		     miniSO_thread[pcb].status = FREE;
   2244					;
   2245	09AE  8B C6			     mov     ax,si
   2246	09B0  BA 001A			     mov     dx,26
   2247	09B3  F7 EA			     imul    dx
   2248	09B5  8B D8			     mov     bx,ax
   2249	09B7  C7 87 000Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+4],-1
   2250					;
   2251					;		     miniSO_thread[pcb].next = miniSO_free;
   2252					;
   2253	09BD  8B C6			     mov     ax,si
   2254	09BF  BA 001A			     mov     dx,26
   2255	09C2  F7 EA			     imul    dx
   2256	09C4  8B 16 0009r		     mov     dx,word ptr DGROUP:_miniSO_free
   2257	09C8  8B D8			     mov     bx,ax
   2258	09CA  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2259					;
   2260					;		     miniSO_free=pcb;
   2261					;
   2262	09CE  89 36 0009r		     mov     word ptr DGROUP:_miniSO_free,si
   2263					;
   2264					;	     }
   2265					;
   2266	09D2  E9 0095			     jmp     @22@1038
   2267	09D5			     @22@842:
   2268					;
   2269					;	     else  {
   2270					;		     /*	senao, coloca o	processo na lista de zumbis do pai */
   2271					;		     miniSO_thread[pcb].status = ZOMBIE;
   2272					;
   2273	09D5  8B C6			     mov     ax,si
   2274	09D7  BA 001A			     mov     dx,26
   2275	09DA  F7 EA			     imul    dx
   2276	09DC  8B D8			     mov     bx,ax
   2277	09DE  C7 87 000Br 0002		     mov     word ptr DGROUP:_miniSO_thread[bx+4],2
   2278					;
   2279					;		     if	     (miniSO_thread[pai].zombies==-1) {	/* Se a	lista esta vazia */
   2280					;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 41
scall.ASM



   2281	09E4  8B 46 F8			     mov     ax,word ptr [bp-8]
   2282	09E7  BA 001A			     mov     dx,26
   2283	09EA  F7 EA			     imul    dx
   2284	09EC  8B D8			     mov     bx,ax
   2285	09EE  83 BF 001Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+20],-1
   2286	09F3  75 1F			     jne     short @22@898
   2287					;
   2288					;			     /*	Insere no inicio */
   2289					;			     miniSO_thread[pai].zombies	= pcb;
   2290					;
   2291	09F5  8B 46 F8			     mov     ax,word ptr [bp-8]
   2292	09F8  BA 001A			     mov     dx,26
   2293	09FB  F7 EA			     imul    dx
   2294	09FD  8B D8			     mov     bx,ax
   2295	09FF  89 B7 001Br		     mov     word ptr DGROUP:_miniSO_thread[bx+20],si
   2296					;
   2297					;			     miniSO_thread[pcb].prev = -1;
   2298					;
   2299	0A03  8B C6			     mov     ax,si
   2300	0A05  BA 001A			     mov     dx,26
   2301	0A08  F7 EA			     imul    dx
   2302	0A0A  8B D8			     mov     bx,ax
   2303	0A0C  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   2304					;
   2305					;		     }
   2306					;
   2307	0A12  EB 47			     jmp     short @22@1010
   2308	0A14			     @22@898:
   2309					;
   2310					;		     else {
   2311					;			     /*	Senao insere no	final */
   2312					;			     i = miniSO_thread[pai].zombies;
   2313					;
   2314	0A14  8B 46 F8			     mov     ax,word ptr [bp-8]
   2315	0A17  BA 001A			     mov     dx,26
   2316	0A1A  F7 EA			     imul    dx
   2317	0A1C  8B D8			     mov     bx,ax
   2318	0A1E  8B BF 001Br		     mov     di,word ptr DGROUP:_miniSO_thread[bx+20]
   2319	0A22  EB 0D			     jmp     short @22@954
   2320	0A24			     @22@926:
   2321					;
   2322					;			     while   (miniSO_thread[i].next!=-1)
   2323					;				     i = miniSO_thread[i].next;
   2324					;
   2325	0A24  8B C7			     mov     ax,di
   2326	0A26  BA 001A			     mov     dx,26
   2327	0A29  F7 EA			     imul    dx
   2328	0A2B  8B D8			     mov     bx,ax
   2329	0A2D  8B BF 001Fr		     mov     di,word ptr DGROUP:_miniSO_thread[bx+24]
   2330	0A31			     @22@954:
   2331	0A31  8B C7			     mov     ax,di
   2332	0A33  BA 001A			     mov     dx,26
   2333	0A36  F7 EA			     imul    dx
   2334	0A38  8B D8			     mov     bx,ax
   2335	0A3A  83 BF 001Fr FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+24],-1
   2336	0A3F  75 E3			     jne     short @22@926
   2337					;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 42
scall.ASM



   2338					;			     miniSO_thread[i].next = pcb;
   2339					;
   2340	0A41  8B C7			     mov     ax,di
   2341	0A43  BA 001A			     mov     dx,26
   2342	0A46  F7 EA			     imul    dx
   2343	0A48  8B D8			     mov     bx,ax
   2344	0A4A  89 B7 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],si
   2345					;
   2346					;			     miniSO_thread[pcb].prev = i;
   2347					;
   2348	0A4E  8B C6			     mov     ax,si
   2349	0A50  BA 001A			     mov     dx,26
   2350	0A53  F7 EA			     imul    dx
   2351	0A55  8B D8			     mov     bx,ax
   2352	0A57  89 BF 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],di
   2353	0A5B			     @22@1010:
   2354					;
   2355					;		     }
   2356					;		     miniSO_thread[pcb].next = -1;
   2357					;
   2358	0A5B  8B C6			     mov     ax,si
   2359	0A5D  BA 001A			     mov     dx,26
   2360	0A60  F7 EA			     imul    dx
   2361	0A62  8B D8			     mov     bx,ax
   2362	0A64  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
   2363	0A6A			     @22@1038:
   2364					;
   2365					;	     }
   2366					;	     if	     (miniSO_thread[pai].status==WAIT) {
   2367					;
   2368	0A6A  8B 46 F8			     mov     ax,word ptr [bp-8]
   2369	0A6D  BA 001A			     mov     dx,26
   2370	0A70  F7 EA			     imul    dx
   2371	0A72  8B D8			     mov     bx,ax
   2372	0A74  83 BF 000Br 03		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],3
   2373	0A79  75 00			     jne     short @22@1066
   2374	0A7B			     @22@1066:
   2375					;
   2376					;	     }
   2377					;	     /*	REVISAR	*/
   2378					;      /* Se o processo-pai esta' esperando em wait, coloca ele	na lista de prontos */
   2379					;      nextthread = miniSO_thread[pcb].wait;
   2380					;
   2381	0A7B  8B C6			     mov     ax,si
   2382	0A7D  BA 001A			     mov     dx,26
   2383	0A80  F7 EA			     imul    dx
   2384	0A82  8B D8			     mov     bx,ax
   2385	0A84  8B 87 0015r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+14]
   2386	0A88  89 46 FA			     mov     word ptr [bp-6],ax
   2387					;
   2388					;      if (nextthread != -1)  {
   2389					;
   2390	0A8B  83 7E FA FF		     cmp     word ptr [bp-6],-1
   2391	0A8F  75 03			     jne     @@2
   2392	0A91  EB 77 90			     jmp     @22@1122
   2393	0A94			     @@2:
   2394					;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 43
scall.ASM



   2395					;	  /* Descobre qual a ultima thread */
   2396					;	  last = miniSO_thread[miniSO_ready].prev;
   2397					;
   2398	0A94  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   2399	0A97  BA 001A			     mov     dx,26
   2400	0A9A  F7 EA			     imul    dx
   2401	0A9C  8B D8			     mov     bx,ax
   2402	0A9E  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   2403	0AA2  89 46 FE			     mov     word ptr [bp-2],ax
   2404					;
   2405					;	  /* Acerta links para incluir a thread	no final da lista de prontos*/
   2406					;	  miniSO_thread[nextthread].prev    = last;
   2407					;
   2408	0AA5  8B 46 FA			     mov     ax,word ptr [bp-6]
   2409	0AA8  BA 001A			     mov     dx,26
   2410	0AAB  F7 EA			     imul    dx
   2411	0AAD  8B 56 FE			     mov     dx,word ptr [bp-2]
   2412	0AB0  8B D8			     mov     bx,ax
   2413	0AB2  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   2414					;
   2415					;	  miniSO_thread[nextthread].next    = miniSO_ready;
   2416					;
   2417	0AB6  8B 46 FA			     mov     ax,word ptr [bp-6]
   2418	0AB9  BA 001A			     mov     dx,26
   2419	0ABC  F7 EA			     imul    dx
   2420	0ABE  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   2421	0AC2  8B D8			     mov     bx,ax
   2422	0AC4  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2423					;
   2424					;	  miniSO_thread[last].next	    = nextthread;
   2425					;
   2426	0AC8  8B 46 FE			     mov     ax,word ptr [bp-2]
   2427	0ACB  BA 001A			     mov     dx,26
   2428	0ACE  F7 EA			     imul    dx
   2429	0AD0  8B 56 FA			     mov     dx,word ptr [bp-6]
   2430	0AD3  8B D8			     mov     bx,ax
   2431	0AD5  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2432					;
   2433					;	  miniSO_thread[miniSO_ready].prev  = nextthread;
   2434					;
   2435	0AD9  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   2436	0ADC  BA 001A			     mov     dx,26
   2437	0ADF  F7 EA			     imul    dx
   2438	0AE1  8B 56 FA			     mov     dx,word ptr [bp-6]
   2439	0AE4  8B D8			     mov     bx,ax
   2440	0AE6  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   2441					;
   2442					;	  miniSO_thread[nextthread].exitcode = miniSO_ERROR;
   2443					;
   2444	0AEA  8B 46 FA			     mov     ax,word ptr [bp-6]
   2445	0AED  BA 001A			     mov     dx,26
   2446	0AF0  F7 EA			     imul    dx
   2447	0AF2  8B D8			     mov     bx,ax
   2448	0AF4  C7 87 0019r FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+18],-1
   2449					;
   2450					;	  miniSO_thread[nextthread].status  = READY;
   2451					;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 44
scall.ASM



   2452	0AFA  8B 46 FA			     mov     ax,word ptr [bp-6]
   2453	0AFD  BA 001A			     mov     dx,26
   2454	0B00  F7 EA			     imul    dx
   2455	0B02  8B D8			     mov     bx,ax
   2456	0B04  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   2457	0B0A			     @22@1122:
   2458					;
   2459					;      }
   2460					;
   2461					;	     enable();
   2462					;
   2463	0B0A  E8 0000e			     call    near ptr _enable
   2464					;
   2465					;	     if	     (miniSO_delcurthread)
   2466					;
   2467	0B0D  80 3E 0006r 00		     cmp     byte ptr DGROUP:_miniSO_delcurthread,0
   2468	0B12  74 02			     je	     short @22@1178
   2469	0B14			     @22@1150:
   2470	0B14  EB FE			     jmp     short @22@1150
   2471	0B16			     @22@1178:
   2472					;
   2473					;		     while   (1)
   2474					;			     ;
   2475					;	     return miniSO_OK;
   2476					;
   2477	0B16  B8 0001			     mov     ax,1
   2478	0B19  E9 FD45			     jmp     @22@142
   2479	0B1C			     @22@1206:
   2480					;
   2481					;    }
   2482					;
   2483	0B1C  5F			     pop     di
   2484	0B1D  5E			     pop     si
   2485	0B1E  8B E5			     mov     sp,bp
   2486	0B20  5D			     pop     bp
   2487	0B21  C3			     ret
   2488	0B22			     _sc_kill	     endp
   2489	0B22			     @22@C1266	     label   word
   2490	0B22  0945r			     dw	     @22@562
   2491	0B24  0945r			     dw	     @22@562
   2492	0B26  0991r			     dw	     @22@758
   2493	0B28  098Fr			     dw	     @22@730
   2494	0B2A  098Fr			     dw	     @22@730
   2495	0B2C  098Dr			     dw	     @22@702
   2496	0B2E  098Fr			     dw	     @22@730
   2497					;
   2498					;    int sc_waitpid(pid_t pid,unsigned seg,unsigned off)
   2499					;
   2500					     assume  cs:_TEXT
   2501	0B30			     _sc_waitpid     proc    near
   2502	0B30  55			     push    bp
   2503	0B31  8B EC			     mov     bp,sp
   2504	0B33  83 EC 08			     sub     sp,8
   2505	0B36  56			     push    si
   2506	0B37  57			     push    di
   2507					;
   2508					;    {
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 45
scall.ASM



   2509					;	     pcb_t pcb,pcbw,prevthread,nextthread,atual;
   2510					;	     int far *p_ref;
   2511					;
   2512					;	     disable();
   2513					;
   2514	0B38  E8 0000e			     call    near ptr _disable
   2515					;
   2516					;	     /*	Tem que	verificar se existe a thread */
   2517					;	     pcb = get_pcb(pid);
   2518					;
   2519	0B3B  FF 76 04			     push    word ptr [bp+4]
   2520	0B3E  E8 F941			     call    near ptr get_pcb
   2521	0B41  59			     pop     cx
   2522	0B42  89 46 FE			     mov     word ptr [bp-2],ax
   2523					;
   2524					;	     /*	Se nao existe uma thread com este numero ou se não é pai da thread, entao   +
   2525				     retorna */
   2526					;	     if	     (pcb==-1 || miniSO_thread[pcb].ppid != miniSO_thread[miniSO_ready].pid)+
   2527				     {
   2528					;
   2529	0B45  83 7E FE FF		     cmp     word ptr [bp-2],-1
   2530	0B49  74 20			     je	     short @23@86
   2531	0B4B  8B 46 FE			     mov     ax,word ptr [bp-2]
   2532	0B4E  BA 001A			     mov     dx,26
   2533	0B51  F7 EA			     imul    dx
   2534	0B53  8B D8			     mov     bx,ax
   2535	0B55  8B 87 0009r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+2]
   2536	0B59  50			     push    ax
   2537	0B5A  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   2538	0B5D  BA 001A			     mov     dx,26
   2539	0B60  F7 EA			     imul    dx
   2540	0B62  8B D8			     mov     bx,ax
   2541	0B64  58			     pop     ax
   2542	0B65  3B 87 0007r		     cmp     ax,word ptr DGROUP:_miniSO_thread[bx]
   2543	0B69  74 09			     je	     short @23@142
   2544	0B6B			     @23@86:
   2545					;
   2546					;		     enable();
   2547					;
   2548	0B6B  E8 0000e			     call    near ptr _enable
   2549					;
   2550					;		     return miniSO_ERROR;
   2551					;
   2552	0B6E  B8 FFFF			     mov     ax,-1
   2553	0B71			     @23@114:
   2554	0B71  E9 0189			     jmp     @23@534
   2555	0B74			     @23@142:
   2556					;
   2557					;	     }
   2558					;	     if	     (miniSO_thread[pcb].status!=ZOMBIE)  {
   2559					;
   2560	0B74  8B 46 FE			     mov     ax,word ptr [bp-2]
   2561	0B77  BA 001A			     mov     dx,26
   2562	0B7A  F7 EA			     imul    dx
   2563	0B7C  8B D8			     mov     bx,ax
   2564	0B7E  83 BF 000Br 02		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],2
   2565	0B83  75 03			     jne     @@3
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 46
scall.ASM



   2566	0B85  E9 00B2			     jmp     @23@310
   2567	0B88			     @@3:
   2568					;
   2569					;		     /*	O processo-filho ainda esta em execucao... */
   2570					;		     atual = miniSO_ready;
   2571					;
   2572	0B88  8B 36 0007r		     mov     si,word ptr DGROUP:_miniSO_ready
   2573					;
   2574					;		     prevthread	= miniSO_thread[atual].prev;
   2575					;
   2576	0B8C  8B C6			     mov     ax,si
   2577	0B8E  BA 001A			     mov     dx,26
   2578	0B91  F7 EA			     imul    dx
   2579	0B93  8B D8			     mov     bx,ax
   2580	0B95  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   2581	0B99  89 46 FC			     mov     word ptr [bp-4],ax
   2582					;
   2583					;		     nextthread	= miniSO_thread[atual].next;
   2584					;
   2585	0B9C  8B C6			     mov     ax,si
   2586	0B9E  BA 001A			     mov     dx,26
   2587	0BA1  F7 EA			     imul    dx
   2588	0BA3  8B D8			     mov     bx,ax
   2589	0BA5  8B BF 001Fr		     mov     di,word ptr DGROUP:_miniSO_thread[bx+24]
   2590					;
   2591					;		     /*	Se eh a	ultima thread ... */
   2592					;		     if	     (atual == nextthread)
   2593					;
   2594	0BA9  3B F7			     cmp     si,di
   2595	0BAB  75 08			     jne     short @23@226
   2596					;
   2597					;			     end_mso("waitpid(): nao ha' mais threads executando!");
   2598					;
   2599	0BAD  B8 0102r			     mov     ax,offset DGROUP:s@+110
   2600	0BB0  50			     push    ax
   2601	0BB1  E8 F889			     call    near ptr end_mso
   2602	0BB4  59			     pop     cx
   2603	0BB5			     @23@226:
   2604					;
   2605					;		     /*	Vincula	o BCP da thread	atual ao BCP da	thread "destino" */
   2606					;		     miniSO_thread[pcb].wait = atual;
   2607					;
   2608	0BB5  8B 46 FE			     mov     ax,word ptr [bp-2]
   2609	0BB8  BA 001A			     mov     dx,26
   2610	0BBB  F7 EA			     imul    dx
   2611	0BBD  8B D8			     mov     bx,ax
   2612	0BBF  89 B7 0015r		     mov     word ptr DGROUP:_miniSO_thread[bx+14],si
   2613					;
   2614					;		     miniSO_thread[atual].prev = -1;
   2615					;
   2616	0BC3  8B C6			     mov     ax,si
   2617	0BC5  BA 001A			     mov     dx,26
   2618	0BC8  F7 EA			     imul    dx
   2619	0BCA  8B D8			     mov     bx,ax
   2620	0BCC  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   2621					;
   2622					;		     miniSO_thread[atual].next = -1;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 47
scall.ASM



   2623					;
   2624	0BD2  8B C6			     mov     ax,si
   2625	0BD4  BA 001A			     mov     dx,26
   2626	0BD7  F7 EA			     imul    dx
   2627	0BD9  8B D8			     mov     bx,ax
   2628	0BDB  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
   2629					;
   2630					;		     miniSO_thread[atual].waitfor = pcb;
   2631					;
   2632	0BE1  8B C6			     mov     ax,si
   2633	0BE3  BA 001A			     mov     dx,26
   2634	0BE6  F7 EA			     imul    dx
   2635	0BE8  8B 56 FE			     mov     dx,word ptr [bp-2]
   2636	0BEB  8B D8			     mov     bx,ax
   2637	0BED  89 97 0017r		     mov     word ptr DGROUP:_miniSO_thread[bx+16],dx
   2638					;
   2639					;		     miniSO_thread[atual].status = WAIT;
   2640					;
   2641	0BF1  8B C6			     mov     ax,si
   2642	0BF3  BA 001A			     mov     dx,26
   2643	0BF6  F7 EA			     imul    dx
   2644	0BF8  8B D8			     mov     bx,ax
   2645	0BFA  C7 87 000Br 0003		     mov     word ptr DGROUP:_miniSO_thread[bx+4],3
   2646					;
   2647					;		     /*	Exclui o nodo da lista de prontos */
   2648					;		     miniSO_thread[prevthread].next=nextthread;
   2649					;
   2650	0C00  8B 46 FC			     mov     ax,word ptr [bp-4]
   2651	0C03  BA 001A			     mov     dx,26
   2652	0C06  F7 EA			     imul    dx
   2653	0C08  8B D8			     mov     bx,ax
   2654	0C0A  89 BF 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],di
   2655					;
   2656					;		     miniSO_thread[nextthread].prev=prevthread;
   2657					;
   2658	0C0E  8B C7			     mov     ax,di
   2659	0C10  BA 001A			     mov     dx,26
   2660	0C13  F7 EA			     imul    dx
   2661	0C15  8B 56 FC			     mov     dx,word ptr [bp-4]
   2662	0C18  8B D8			     mov     bx,ax
   2663	0C1A  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   2664					;
   2665					;		     miniSO_nextthread=nextthread;
   2666					;
   2667	0C1E  89 3E 0004r		     mov     word ptr DGROUP:_miniSO_nextthread,di
   2668					;
   2669					;		     enable();
   2670					;
   2671	0C22  E8 0000e			     call    near ptr _enable
   2672	0C25  EB 00			     jmp     short @23@254
   2673	0C27			     @23@254:
   2674					;
   2675					;		     while   (miniSO_thread[atual].status == WAIT)
   2676					;
   2677	0C27  8B C6			     mov     ax,si
   2678	0C29  BA 001A			     mov     dx,26
   2679	0C2C  F7 EA			     imul    dx
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 48
scall.ASM



   2680	0C2E  8B D8			     mov     bx,ax
   2681	0C30  83 BF 000Br 03		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],3
   2682	0C35  74 F0			     je	     short @23@254
   2683					;
   2684					;			     ;
   2685					;		     disable();
   2686					;
   2687	0C37  E8 0000e			     call    near ptr _disable
   2688	0C3A			     @23@310:
   2689					;
   2690					;	     }
   2691					;	     /*	O processo filho ja terminou...	*/
   2692					;	     /*	Retira o processo filho	da lista de zumbis do pai */
   2693					;	     atual = pcb;
   2694					;
   2695	0C3A  8B 76 FE			     mov     si,word ptr [bp-2]
   2696					;
   2697					;	     prevthread	= miniSO_thread[atual].prev;
   2698					;
   2699	0C3D  8B C6			     mov     ax,si
   2700	0C3F  BA 001A			     mov     dx,26
   2701	0C42  F7 EA			     imul    dx
   2702	0C44  8B D8			     mov     bx,ax
   2703	0C46  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   2704	0C4A  89 46 FC			     mov     word ptr [bp-4],ax
   2705					;
   2706					;	     nextthread	= miniSO_thread[atual].next;
   2707					;
   2708	0C4D  8B C6			     mov     ax,si
   2709	0C4F  BA 001A			     mov     dx,26
   2710	0C52  F7 EA			     imul    dx
   2711	0C54  8B D8			     mov     bx,ax
   2712	0C56  8B BF 001Fr		     mov     di,word ptr DGROUP:_miniSO_thread[bx+24]
   2713					;
   2714					;	     if	     (prevthread == -1)	 { /* E	o primeiro da lista */
   2715					;
   2716	0C5A  83 7E FC FF		     cmp     word ptr [bp-4],-1
   2717	0C5E  75 24			     jne     short @23@422
   2718					;
   2719					;		     miniSO_thread[miniSO_ready].zombies = nextthread;
   2720					;
   2721	0C60  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   2722	0C63  BA 001A			     mov     dx,26
   2723	0C66  F7 EA			     imul    dx
   2724	0C68  8B D8			     mov     bx,ax
   2725	0C6A  89 BF 001Br		     mov     word ptr DGROUP:_miniSO_thread[bx+20],di
   2726					;
   2727					;		     if	     (nextthread != -1)
   2728					;
   2729	0C6E  83 FF FF			     cmp     di,-1
   2730	0C71  74 0F			     je	     short @23@394
   2731					;
   2732					;			     miniSO_thread[nextthread].prev = -1;
   2733					;
   2734	0C73  8B C7			     mov     ax,di
   2735	0C75  BA 001A			     mov     dx,26
   2736	0C78  F7 EA			     imul    dx
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 49
scall.ASM



   2737	0C7A  8B D8			     mov     bx,ax
   2738	0C7C  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   2739	0C82			     @23@394:
   2740					;
   2741					;	     }
   2742					;
   2743	0C82  EB 0E			     jmp     short @23@450
   2744	0C84			     @23@422:
   2745					;
   2746					;	     else
   2747					;		     miniSO_thread[prevthread].next = nextthread;
   2748					;
   2749	0C84  8B 46 FC			     mov     ax,word ptr [bp-4]
   2750	0C87  BA 001A			     mov     dx,26
   2751	0C8A  F7 EA			     imul    dx
   2752	0C8C  8B D8			     mov     bx,ax
   2753	0C8E  89 BF 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],di
   2754	0C92			     @23@450:
   2755					;
   2756					;	     if	     (nextthread != -1)
   2757					;
   2758	0C92  83 FF FF			     cmp     di,-1
   2759	0C95  74 10			     je	     short @23@506
   2760					;
   2761					;		     miniSO_thread[nextthread].prev = prevthread;
   2762					;
   2763	0C97  8B C7			     mov     ax,di
   2764	0C99  BA 001A			     mov     dx,26
   2765	0C9C  F7 EA			     imul    dx
   2766	0C9E  8B 56 FC			     mov     dx,word ptr [bp-4]
   2767	0CA1  8B D8			     mov     bx,ax
   2768	0CA3  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   2769	0CA7			     @23@506:
   2770					;
   2771					;	     p_ref = MK_FP(seg,off);
   2772					;
   2773	0CA7  FF 76 08			     push    word ptr [bp+8]
   2774	0CAA  FF 76 06			     push    word ptr [bp+6]
   2775	0CAD  E8 0000e			     call    near ptr _MK_FP
   2776	0CB0  59			     pop     cx
   2777	0CB1  59			     pop     cx
   2778	0CB2  89 56 FA			     mov     word ptr [bp-6],dx
   2779	0CB5  89 46 F8			     mov     word ptr [bp-8],ax
   2780					;
   2781					;	     *p_ref = miniSO_thread[pcb].exitcode;
   2782					;
   2783	0CB8  8B 46 FE			     mov     ax,word ptr [bp-2]
   2784	0CBB  BA 001A			     mov     dx,26
   2785	0CBE  F7 EA			     imul    dx
   2786	0CC0  8B D8			     mov     bx,ax
   2787	0CC2  8B 87 0019r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+18]
   2788	0CC6  C4 5E F8			     les     bx,dword ptr [bp-8]
   2789	0CC9  26: 89 07			     mov     word ptr es:[bx],ax
   2790					;
   2791					;	     /*	Insere o processo na lista de BCPs livres */
   2792					;	     miniSO_thread[pcb].next = miniSO_free;
   2793					;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 50
scall.ASM



   2794	0CCC  8B 46 FE			     mov     ax,word ptr [bp-2]
   2795	0CCF  BA 001A			     mov     dx,26
   2796	0CD2  F7 EA			     imul    dx
   2797	0CD4  8B 16 0009r		     mov     dx,word ptr DGROUP:_miniSO_free
   2798	0CD8  8B D8			     mov     bx,ax
   2799	0CDA  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2800					;
   2801					;	     miniSO_free = pcb;
   2802					;
   2803	0CDE  8B 46 FE			     mov     ax,word ptr [bp-2]
   2804	0CE1  A3 0009r			     mov     word ptr DGROUP:_miniSO_free,ax
   2805					;
   2806					;	     miniSO_thread[pcb].status = FREE;
   2807					;
   2808	0CE4  8B 46 FE			     mov     ax,word ptr [bp-2]
   2809	0CE7  BA 001A			     mov     dx,26
   2810	0CEA  F7 EA			     imul    dx
   2811	0CEC  8B D8			     mov     bx,ax
   2812	0CEE  C7 87 000Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+4],-1
   2813					;
   2814					;	     enable();
   2815					;
   2816	0CF4  E8 0000e			     call    near ptr _enable
   2817					;
   2818					;	     return pid;
   2819					;
   2820	0CF7  8B 46 04			     mov     ax,word ptr [bp+4]
   2821	0CFA  E9 FE74			     jmp     @23@114
   2822	0CFD			     @23@534:
   2823					;
   2824					;    }
   2825					;
   2826	0CFD  5F			     pop     di
   2827	0CFE  5E			     pop     si
   2828	0CFF  8B E5			     mov     sp,bp
   2829	0D01  5D			     pop     bp
   2830	0D02  C3			     ret
   2831	0D03			     _sc_waitpid     endp
   2832					;
   2833					;    int sc_wait(unsigned seg,unsigned off)
   2834					;
   2835					     assume  cs:_TEXT
   2836	0D03			     _sc_wait	     proc    near
   2837	0D03  55			     push    bp
   2838	0D04  8B EC			     mov     bp,sp
   2839	0D06  83 EC 08			     sub     sp,8
   2840	0D09  56			     push    si
   2841	0D0A  57			     push    di
   2842					;
   2843					;    {
   2844					;	     pcb_t   zombie,next,atual,prevthread,nextthread;
   2845					;	     int far *p_ref;
   2846					;
   2847					;	     disable();
   2848					;
   2849	0D0B  E8 0000e			     call    near ptr _disable
   2850					;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 51
scall.ASM



   2851					;	     atual =miniSO_ready;
   2852					;
   2853	0D0E  8B 36 0007r		     mov     si,word ptr DGROUP:_miniSO_ready
   2854					;
   2855					;	     if	     (miniSO_thread[miniSO_ready].zombies==-1) {
   2856					;
   2857	0D12  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   2858	0D15  BA 001A			     mov     dx,26
   2859	0D18  F7 EA			     imul    dx
   2860	0D1A  8B D8			     mov     bx,ax
   2861	0D1C  83 BF 001Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+20],-1
   2862	0D21  74 03			     je	     @@4
   2863	0D23  E9 00AA			     jmp     @24@198
   2864	0D26			     @@4:
   2865					;
   2866					;		     /*	O pai nao tem filhos-zumbi e vai bloquear */
   2867					;		     prevthread	= miniSO_thread[atual].prev;
   2868					;
   2869	0D26  8B C6			     mov     ax,si
   2870	0D28  BA 001A			     mov     dx,26
   2871	0D2B  F7 EA			     imul    dx
   2872	0D2D  8B D8			     mov     bx,ax
   2873	0D2F  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   2874	0D33  89 46 FE			     mov     word ptr [bp-2],ax
   2875					;
   2876					;		     nextthread	= miniSO_thread[atual].next;
   2877					;
   2878	0D36  8B C6			     mov     ax,si
   2879	0D38  BA 001A			     mov     dx,26
   2880	0D3B  F7 EA			     imul    dx
   2881	0D3D  8B D8			     mov     bx,ax
   2882	0D3F  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   2883	0D43  89 46 FC			     mov     word ptr [bp-4],ax
   2884					;
   2885					;		     /*	Se eh a	ultima thread ... */
   2886					;		     if	     (miniSO_ready == nextthread)
   2887					;
   2888	0D46  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   2889	0D49  3B 46 FC			     cmp     ax,word ptr [bp-4]
   2890	0D4C  75 08			     jne     short @24@114
   2891					;
   2892					;			     end_mso("wait(): nao ha' mais threads executando!");
   2893					;
   2894	0D4E  B8 012Er			     mov     ax,offset DGROUP:s@+154
   2895	0D51  50			     push    ax
   2896	0D52  E8 F6E8			     call    near ptr end_mso
   2897	0D55  59			     pop     cx
   2898	0D56			     @24@114:
   2899					;
   2900					;		     /*	Vincula	o BCP da thread	atual ao BCP da	thread "destino" */
   2901					;		     miniSO_thread[atual].prev = -1;
   2902					;
   2903	0D56  8B C6			     mov     ax,si
   2904	0D58  BA 001A			     mov     dx,26
   2905	0D5B  F7 EA			     imul    dx
   2906	0D5D  8B D8			     mov     bx,ax
   2907	0D5F  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 52
scall.ASM



   2908					;
   2909					;		     miniSO_thread[atual].next = -1;
   2910					;
   2911	0D65  8B C6			     mov     ax,si
   2912	0D67  BA 001A			     mov     dx,26
   2913	0D6A  F7 EA			     imul    dx
   2914	0D6C  8B D8			     mov     bx,ax
   2915	0D6E  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
   2916					;
   2917					;		     miniSO_thread[atual].waitfor = -1;
   2918					;
   2919	0D74  8B C6			     mov     ax,si
   2920	0D76  BA 001A			     mov     dx,26
   2921	0D79  F7 EA			     imul    dx
   2922	0D7B  8B D8			     mov     bx,ax
   2923	0D7D  C7 87 0017r FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+16],-1
   2924					;
   2925					;		     miniSO_thread[atual].status = WAIT;
   2926					;
   2927	0D83  8B C6			     mov     ax,si
   2928	0D85  BA 001A			     mov     dx,26
   2929	0D88  F7 EA			     imul    dx
   2930	0D8A  8B D8			     mov     bx,ax
   2931	0D8C  C7 87 000Br 0003		     mov     word ptr DGROUP:_miniSO_thread[bx+4],3
   2932					;
   2933					;		     /*	Exclui o nodo da lista de prontos */
   2934					;		     miniSO_thread[atual].next=nextthread;
   2935					;
   2936	0D92  8B C6			     mov     ax,si
   2937	0D94  BA 001A			     mov     dx,26
   2938	0D97  F7 EA			     imul    dx
   2939	0D99  8B 56 FC			     mov     dx,word ptr [bp-4]
   2940	0D9C  8B D8			     mov     bx,ax
   2941	0D9E  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   2942					;
   2943					;		     miniSO_thread[atual].prev=prevthread;
   2944					;
   2945	0DA2  8B C6			     mov     ax,si
   2946	0DA4  BA 001A			     mov     dx,26
   2947	0DA7  F7 EA			     imul    dx
   2948	0DA9  8B 56 FE			     mov     dx,word ptr [bp-2]
   2949	0DAC  8B D8			     mov     bx,ax
   2950	0DAE  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   2951					;
   2952					;		     miniSO_nextthread=nextthread;
   2953					;
   2954	0DB2  8B 46 FC			     mov     ax,word ptr [bp-4]
   2955	0DB5  A3 0004r			     mov     word ptr DGROUP:_miniSO_nextthread,ax
   2956					;
   2957					;		     enable();
   2958					;
   2959	0DB8  E8 0000e			     call    near ptr _enable
   2960	0DBB  EB 00			     jmp     short @24@142
   2961	0DBD			     @24@142:
   2962					;
   2963					;		     while   (miniSO_thread[atual].status == WAIT)
   2964					;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 53
scall.ASM



   2965	0DBD  8B C6			     mov     ax,si
   2966	0DBF  BA 001A			     mov     dx,26
   2967	0DC2  F7 EA			     imul    dx
   2968	0DC4  8B D8			     mov     bx,ax
   2969	0DC6  83 BF 000Br 03		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],3
   2970	0DCB  74 F0			     je	     short @24@142
   2971					;
   2972					;			     ;
   2973					;		     disable();
   2974					;
   2975	0DCD  E8 0000e			     call    near ptr _disable
   2976	0DD0			     @24@198:
   2977					;
   2978					;	     }
   2979					;	     /*	O pai tem pelo menos um	filho zumbi... */
   2980					;	     zombie = miniSO_thread[atual].zombies;
   2981					;
   2982	0DD0  8B C6			     mov     ax,si
   2983	0DD2  BA 001A			     mov     dx,26
   2984	0DD5  F7 EA			     imul    dx
   2985	0DD7  8B D8			     mov     bx,ax
   2986	0DD9  8B BF 001Br		     mov     di,word ptr DGROUP:_miniSO_thread[bx+20]
   2987					;
   2988					;	     miniSO_thread[atual].zombies = miniSO_thread[zombie].next;
   2989					;
   2990	0DDD  8B C7			     mov     ax,di
   2991	0DDF  BA 001A			     mov     dx,26
   2992	0DE2  F7 EA			     imul    dx
   2993	0DE4  8B D8			     mov     bx,ax
   2994	0DE6  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   2995	0DEA  50			     push    ax
   2996	0DEB  8B C6			     mov     ax,si
   2997	0DED  BA 001A			     mov     dx,26
   2998	0DF0  F7 EA			     imul    dx
   2999	0DF2  8B D8			     mov     bx,ax
   3000	0DF4  58			     pop     ax
   3001	0DF5  89 87 001Br		     mov     word ptr DGROUP:_miniSO_thread[bx+20],ax
   3002					;
   3003					;	     if	     (miniSO_thread[atual].zombies!=-1)
   3004					;
   3005	0DF9  8B C6			     mov     ax,si
   3006	0DFB  BA 001A			     mov     dx,26
   3007	0DFE  F7 EA			     imul    dx
   3008	0E00  8B D8			     mov     bx,ax
   3009	0E02  83 BF 001Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+20],-1
   3010	0E07  74 1A			     je	     short @24@254
   3011					;
   3012					;		     miniSO_thread[miniSO_thread[atual].zombies].prev =	-1;
   3013					;
   3014	0E09  8B C6			     mov     ax,si
   3015	0E0B  BA 001A			     mov     dx,26
   3016	0E0E  F7 EA			     imul    dx
   3017	0E10  8B D8			     mov     bx,ax
   3018	0E12  8B 87 001Br		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+20]
   3019	0E16  BA 001A			     mov     dx,26
   3020	0E19  F7 EA			     imul    dx
   3021	0E1B  8B D8			     mov     bx,ax
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 54
scall.ASM



   3022	0E1D  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   3023	0E23			     @24@254:
   3024					;
   3025					;	     miniSO_thread[zombie].next	= miniSO_free;
   3026					;
   3027	0E23  8B C7			     mov     ax,di
   3028	0E25  BA 001A			     mov     dx,26
   3029	0E28  F7 EA			     imul    dx
   3030	0E2A  8B 16 0009r		     mov     dx,word ptr DGROUP:_miniSO_free
   3031	0E2E  8B D8			     mov     bx,ax
   3032	0E30  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3033					;
   3034					;	     miniSO_thread[zombie].status = FREE;
   3035					;
   3036	0E34  8B C7			     mov     ax,di
   3037	0E36  BA 001A			     mov     dx,26
   3038	0E39  F7 EA			     imul    dx
   3039	0E3B  8B D8			     mov     bx,ax
   3040	0E3D  C7 87 000Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+4],-1
   3041					;
   3042					;	     miniSO_free = zombie;
   3043					;
   3044	0E43  89 3E 0009r		     mov     word ptr DGROUP:_miniSO_free,di
   3045					;
   3046					;	     p_ref = MK_FP(seg,off);
   3047					;
   3048	0E47  FF 76 06			     push    word ptr [bp+6]
   3049	0E4A  FF 76 04			     push    word ptr [bp+4]
   3050	0E4D  E8 0000e			     call    near ptr _MK_FP
   3051	0E50  59			     pop     cx
   3052	0E51  59			     pop     cx
   3053	0E52  89 56 FA			     mov     word ptr [bp-6],dx
   3054	0E55  89 46 F8			     mov     word ptr [bp-8],ax
   3055					;
   3056					;	     *p_ref = miniSO_thread[zombie].exitcode;
   3057					;
   3058	0E58  8B C7			     mov     ax,di
   3059	0E5A  BA 001A			     mov     dx,26
   3060	0E5D  F7 EA			     imul    dx
   3061	0E5F  8B D8			     mov     bx,ax
   3062	0E61  8B 87 0019r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+18]
   3063	0E65  C4 5E F8			     les     bx,dword ptr [bp-8]
   3064	0E68  26: 89 07			     mov     word ptr es:[bx],ax
   3065					;
   3066					;	     enable();
   3067					;
   3068	0E6B  E8 0000e			     call    near ptr _enable
   3069					;
   3070					;	     return miniSO_thread[zombie].pid;
   3071					;
   3072	0E6E  8B C7			     mov     ax,di
   3073	0E70  BA 001A			     mov     dx,26
   3074	0E73  F7 EA			     imul    dx
   3075	0E75  8B D8			     mov     bx,ax
   3076	0E77  8B 87 0007r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx]
   3077	0E7B  EB 00			     jmp     short @24@282
   3078	0E7D			     @24@282:
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 55
scall.ASM



   3079					;
   3080					;    }
   3081					;
   3082	0E7D  5F			     pop     di
   3083	0E7E  5E			     pop     si
   3084	0E7F  8B E5			     mov     sp,bp
   3085	0E81  5D			     pop     bp
   3086	0E82  C3			     ret
   3087	0E83			     _sc_wait	     endp
   3088					;
   3089					;    void sc_exit(int codfim)
   3090					;
   3091					     assume  cs:_TEXT
   3092	0E83			     _sc_exit	     proc    near
   3093	0E83  55			     push    bp
   3094	0E84  8B EC			     mov     bp,sp
   3095	0E86  83 EC 06			     sub     sp,6
   3096	0E89  56			     push    si
   3097	0E8A  57			     push    di
   3098					;
   3099					;    {
   3100					;	     pcb_t pai,i,last,prevthread,nextthread;
   3101					;
   3102					;	     disable();
   3103					;
   3104	0E8B  E8 0000e			     call    near ptr _disable
   3105					;
   3106					;	     /*	Verifica se não	esta' encerrando a thread 0 */
   3107					;	     if	     (miniSO_ready == 0)
   3108					;
   3109	0E8E  83 3E 0007r 00		     cmp     word ptr DGROUP:_miniSO_ready,0
   3110	0E93  75 08			     jne     short @25@86
   3111					;
   3112					;		     end_mso("exit(): thread 0 encerrada!");
   3113					;
   3114	0E95  B8 0157r			     mov     ax,offset DGROUP:s@+195
   3115	0E98  50			     push    ax
   3116	0E99  E8 F5A1			     call    near ptr end_mso
   3117	0E9C  59			     pop     cx
   3118	0E9D			     @25@86:
   3119	0E9D  EB 41			     jmp     short @25@142
   3120	0E9F			     @25@114:
   3121					;
   3122					;	     /*	Trata os zumbis	do processo atual, colocando-os	na lista de livres */
   3123					;	     i = miniSO_thread[miniSO_ready].zombies;
   3124					;	     while   (i!= -1)  {
   3125					;		     miniSO_thread[miniSO_ready].zombies = miniSO_thread[i].next;
   3126					;
   3127	0E9F  8B C6			     mov     ax,si
   3128	0EA1  BA 001A			     mov     dx,26
   3129	0EA4  F7 EA			     imul    dx
   3130	0EA6  8B D8			     mov     bx,ax
   3131	0EA8  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   3132	0EAC  50			     push    ax
   3133	0EAD  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3134	0EB0  BA 001A			     mov     dx,26
   3135	0EB3  F7 EA			     imul    dx
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 56
scall.ASM



   3136	0EB5  8B D8			     mov     bx,ax
   3137	0EB7  58			     pop     ax
   3138	0EB8  89 87 001Br		     mov     word ptr DGROUP:_miniSO_thread[bx+20],ax
   3139					;
   3140					;		     miniSO_thread[i].next   = miniSO_free;
   3141					;
   3142	0EBC  8B C6			     mov     ax,si
   3143	0EBE  BA 001A			     mov     dx,26
   3144	0EC1  F7 EA			     imul    dx
   3145	0EC3  8B 16 0009r		     mov     dx,word ptr DGROUP:_miniSO_free
   3146	0EC7  8B D8			     mov     bx,ax
   3147	0EC9  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3148					;
   3149					;		     miniSO_thread[i].status = FREE;
   3150					;
   3151	0ECD  8B C6			     mov     ax,si
   3152	0ECF  BA 001A			     mov     dx,26
   3153	0ED2  F7 EA			     imul    dx
   3154	0ED4  8B D8			     mov     bx,ax
   3155	0ED6  C7 87 000Br FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+4],-1
   3156					;
   3157					;		     miniSO_free	     = i;
   3158					;
   3159	0EDC  89 36 0009r		     mov     word ptr DGROUP:_miniSO_free,si
   3160					;
   3161					;		     i = miniSO_thread[miniSO_ready].zombies;
   3162					;
   3163	0EE0			     @25@142:
   3164	0EE0  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3165	0EE3  BA 001A			     mov     dx,26
   3166	0EE6  F7 EA			     imul    dx
   3167	0EE8  8B D8			     mov     bx,ax
   3168	0EEA  8B B7 001Br		     mov     si,word ptr DGROUP:_miniSO_thread[bx+20]
   3169	0EEE  83 FE FF			     cmp     si,-1
   3170	0EF1  75 AC			     jne     short @25@114
   3171					;
   3172					;	     }
   3173					;	     /*	Passa os filhos	do atual para o	processo 0 */
   3174					;	     for     (i=0;i<miniSO_MAXTHREADS;++i)  {
   3175					;
   3176	0EF3  33 F6			     xor     si,si
   3177	0EF5  EB 3F			     jmp     short @25@338
   3178	0EF7			     @25@226:
   3179					;
   3180					;		     if	     (miniSO_thread[i].status!=FREE && miniSO_thread[i].ppid ==	    +
   3181				     miniSO_thread[miniSO_ready].pid)
   3182					;
   3183	0EF7  8B C6			     mov     ax,si
   3184	0EF9  BA 001A			     mov     dx,26
   3185	0EFC  F7 EA			     imul    dx
   3186	0EFE  8B D8			     mov     bx,ax
   3187	0F00  83 BF 000Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],-1
   3188	0F05  74 2E			     je	     short @25@310
   3189	0F07  8B C6			     mov     ax,si
   3190	0F09  BA 001A			     mov     dx,26
   3191	0F0C  F7 EA			     imul    dx
   3192	0F0E  8B D8			     mov     bx,ax
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 57
scall.ASM



   3193	0F10  8B 87 0009r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+2]
   3194	0F14  50			     push    ax
   3195	0F15  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3196	0F18  BA 001A			     mov     dx,26
   3197	0F1B  F7 EA			     imul    dx
   3198	0F1D  8B D8			     mov     bx,ax
   3199	0F1F  58			     pop     ax
   3200	0F20  3B 87 0007r		     cmp     ax,word ptr DGROUP:_miniSO_thread[bx]
   3201	0F24  75 0F			     jne     short @25@310
   3202					;
   3203					;			     miniSO_thread[i].ppid = 0;
   3204					;
   3205	0F26  8B C6			     mov     ax,si
   3206	0F28  BA 001A			     mov     dx,26
   3207	0F2B  F7 EA			     imul    dx
   3208	0F2D  8B D8			     mov     bx,ax
   3209	0F2F  C7 87 0009r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+2],0
   3210	0F35			     @25@310:
   3211	0F35  46			     inc     si
   3212	0F36			     @25@338:
   3213	0F36  83 FE 10			     cmp     si,16
   3214	0F39  7C BC			     jl	     short @25@226
   3215					;
   3216					;	     }
   3217					;	     pai = get_pcb(miniSO_thread[miniSO_ready].ppid);
   3218					;
   3219	0F3B  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3220	0F3E  BA 001A			     mov     dx,26
   3221	0F41  F7 EA			     imul    dx
   3222	0F43  8B D8			     mov     bx,ax
   3223	0F45  FF B7 0009r		     push    word ptr DGROUP:_miniSO_thread[bx+2]
   3224	0F49  E8 F536			     call    near ptr get_pcb
   3225	0F4C  59			     pop     cx
   3226	0F4D  8B F8			     mov     di,ax
   3227					;
   3228					;	     if	     (pai==-1)
   3229					;
   3230	0F4F  83 FF FF			     cmp     di,-1
   3231	0F52  75 08			     jne     short @25@422
   3232					;
   3233					;		     end_mso("exit(): pai nao encontrado!");
   3234					;
   3235	0F54  B8 0173r			     mov     ax,offset DGROUP:s@+223
   3236	0F57  50			     push    ax
   3237	0F58  E8 F4E2			     call    near ptr end_mso
   3238	0F5B  59			     pop     cx
   3239	0F5C			     @25@422:
   3240					;
   3241					;	     /*	Se o processo-pai esta'	esperando em wait/waitpid, coloca ele na lista de   +
   3242				     prontos */
   3243					;	     if	     ( miniSO_thread[pai].status==WAIT &&
   3244					;
   3245					;
   3246					;		       (miniSO_thread[pai].waitfor==-1 || miniSO_thread			    +
   3247				     [pai].waitfor==miniSO_ready) ) {
   3248					;
   3249	0F5C  8B C7			     mov     ax,di
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 58
scall.ASM



   3250	0F5E  BA 001A			     mov     dx,26
   3251	0F61  F7 EA			     imul    dx
   3252	0F63  8B D8			     mov     bx,ax
   3253	0F65  83 BF 000Br 03		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],3
   3254	0F6A  74 03			     je	     @@5
   3255	0F6C  E9 0080			     jmp     @25@534
   3256	0F6F			     @@5:
   3257	0F6F  8B C7			     mov     ax,di
   3258	0F71  BA 001A			     mov     dx,26
   3259	0F74  F7 EA			     imul    dx
   3260	0F76  8B D8			     mov     bx,ax
   3261	0F78  83 BF 0017r FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+16],-1
   3262	0F7D  74 13			     je	     short @25@506
   3263	0F7F  8B C7			     mov     ax,di
   3264	0F81  BA 001A			     mov     dx,26
   3265	0F84  F7 EA			     imul    dx
   3266	0F86  8B D8			     mov     bx,ax
   3267	0F88  8B 87 0017r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+16]
   3268	0F8C  3B 06 0007r		     cmp     ax,word ptr DGROUP:_miniSO_ready
   3269	0F90  75 5D			     jne     short @25@534
   3270	0F92			     @25@506:
   3271					;
   3272					;		     /*	Descobre qual a	ultima thread */
   3273					;		     last = miniSO_thread[miniSO_ready].prev;
   3274					;
   3275	0F92  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3276	0F95  BA 001A			     mov     dx,26
   3277	0F98  F7 EA			     imul    dx
   3278	0F9A  8B D8			     mov     bx,ax
   3279	0F9C  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   3280	0FA0  89 46 FE			     mov     word ptr [bp-2],ax
   3281					;
   3282					;		     /*	Acerta links para incluir a thread no final da lista de	prontos*/
   3283					;		     miniSO_thread[pai].prev	       = last;
   3284					;
   3285	0FA3  8B C7			     mov     ax,di
   3286	0FA5  BA 001A			     mov     dx,26
   3287	0FA8  F7 EA			     imul    dx
   3288	0FAA  8B 56 FE			     mov     dx,word ptr [bp-2]
   3289	0FAD  8B D8			     mov     bx,ax
   3290	0FAF  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   3291					;
   3292					;		     miniSO_thread[pai].next	       = miniSO_ready;
   3293					;
   3294	0FB3  8B C7			     mov     ax,di
   3295	0FB5  BA 001A			     mov     dx,26
   3296	0FB8  F7 EA			     imul    dx
   3297	0FBA  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   3298	0FBE  8B D8			     mov     bx,ax
   3299	0FC0  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3300					;
   3301					;		     miniSO_thread[last].next	       = pai;
   3302					;
   3303	0FC4  8B 46 FE			     mov     ax,word ptr [bp-2]
   3304	0FC7  BA 001A			     mov     dx,26
   3305	0FCA  F7 EA			     imul    dx
   3306	0FCC  8B D8			     mov     bx,ax
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 59
scall.ASM



   3307	0FCE  89 BF 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],di
   3308					;
   3309					;		     miniSO_thread[miniSO_ready].prev  = pai;
   3310					;
   3311	0FD2  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3312	0FD5  BA 001A			     mov     dx,26
   3313	0FD8  F7 EA			     imul    dx
   3314	0FDA  8B D8			     mov     bx,ax
   3315	0FDC  89 BF 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],di
   3316					;
   3317					;		     miniSO_thread[pai].status	       = READY;
   3318					;
   3319	0FE0  8B C7			     mov     ax,di
   3320	0FE2  BA 001A			     mov     dx,26
   3321	0FE5  F7 EA			     imul    dx
   3322	0FE7  8B D8			     mov     bx,ax
   3323	0FE9  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   3324	0FEF			     @25@534:
   3325					;
   3326					;	     }
   3327					;	     /*	Salva anterior e proximo da thread que sera deletada */
   3328					;	     prevthread	= miniSO_thread[miniSO_ready].prev;
   3329					;
   3330	0FEF  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3331	0FF2  BA 001A			     mov     dx,26
   3332	0FF5  F7 EA			     imul    dx
   3333	0FF7  8B D8			     mov     bx,ax
   3334	0FF9  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   3335	0FFD  89 46 FC			     mov     word ptr [bp-4],ax
   3336					;
   3337					;	     nextthread	= miniSO_thread[miniSO_ready].next;
   3338					;
   3339	1000  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3340	1003  BA 001A			     mov     dx,26
   3341	1006  F7 EA			     imul    dx
   3342	1008  8B D8			     mov     bx,ax
   3343	100A  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   3344	100E  89 46 FA			     mov     word ptr [bp-6],ax
   3345					;
   3346					;	     if	     (miniSO_ready == nextthread)
   3347					;
   3348	1011  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3349	1014  3B 46 FA			     cmp     ax,word ptr [bp-6]
   3350	1017  75 08			     jne     short @25@590
   3351					;
   3352					;		     end_mso("exit(): nao ha' mais threads executando!");
   3353					;
   3354	1019  B8 018Fr			     mov     ax,offset DGROUP:s@+251
   3355	101C  50			     push    ax
   3356	101D  E8 F41D			     call    near ptr end_mso
   3357	1020  59			     pop     cx
   3358	1021			     @25@590:
   3359					;
   3360					;	     /*	Exclui o nodo da lista de prontos */
   3361					;	     miniSO_thread[prevthread].next=nextthread;
   3362					;
   3363	1021  8B 46 FC			     mov     ax,word ptr [bp-4]
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 60
scall.ASM



   3364	1024  BA 001A			     mov     dx,26
   3365	1027  F7 EA			     imul    dx
   3366	1029  8B 56 FA			     mov     dx,word ptr [bp-6]
   3367	102C  8B D8			     mov     bx,ax
   3368	102E  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3369					;
   3370					;	     miniSO_thread[nextthread].prev=prevthread;
   3371					;
   3372	1032  8B 46 FA			     mov     ax,word ptr [bp-6]
   3373	1035  BA 001A			     mov     dx,26
   3374	1038  F7 EA			     imul    dx
   3375	103A  8B 56 FC			     mov     dx,word ptr [bp-4]
   3376	103D  8B D8			     mov     bx,ax
   3377	103F  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   3378					;
   3379					;	     if	     (miniSO_thread[pai].zombies==-1) {
   3380					;
   3381	1043  8B C7			     mov     ax,di
   3382	1045  BA 001A			     mov     dx,26
   3383	1048  F7 EA			     imul    dx
   3384	104A  8B D8			     mov     bx,ax
   3385	104C  83 BF 001Br FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+20],-1
   3386	1051  75 23			     jne     short @25@646
   3387					;
   3388					;		     miniSO_thread[pai].zombies	= miniSO_ready;
   3389					;
   3390	1053  8B C7			     mov     ax,di
   3391	1055  BA 001A			     mov     dx,26
   3392	1058  F7 EA			     imul    dx
   3393	105A  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   3394	105E  8B D8			     mov     bx,ax
   3395	1060  89 97 001Br		     mov     word ptr DGROUP:_miniSO_thread[bx+20],dx
   3396					;
   3397					;		     miniSO_thread[miniSO_ready].prev =	-1;
   3398					;
   3399	1064  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3400	1067  BA 001A			     mov     dx,26
   3401	106A  F7 EA			     imul    dx
   3402	106C  8B D8			     mov     bx,ax
   3403	106E  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   3404					;
   3405					;	     }
   3406					;
   3407	1074  EB 4B			     jmp     short @25@758
   3408	1076			     @25@646:
   3409					;
   3410					;	     else    {
   3411					;		     i = miniSO_thread[pai].zombies;
   3412					;
   3413	1076  8B C7			     mov     ax,di
   3414	1078  BA 001A			     mov     dx,26
   3415	107B  F7 EA			     imul    dx
   3416	107D  8B D8			     mov     bx,ax
   3417	107F  8B B7 001Br		     mov     si,word ptr DGROUP:_miniSO_thread[bx+20]
   3418	1083  EB 0D			     jmp     short @25@702
   3419	1085			     @25@674:
   3420					;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 61
scall.ASM



   3421					;		     while   (miniSO_thread[i].next!=-1)
   3422					;			     i = miniSO_thread[i].next;
   3423					;
   3424	1085  8B C6			     mov     ax,si
   3425	1087  BA 001A			     mov     dx,26
   3426	108A  F7 EA			     imul    dx
   3427	108C  8B D8			     mov     bx,ax
   3428	108E  8B B7 001Fr		     mov     si,word ptr DGROUP:_miniSO_thread[bx+24]
   3429	1092			     @25@702:
   3430	1092  8B C6			     mov     ax,si
   3431	1094  BA 001A			     mov     dx,26
   3432	1097  F7 EA			     imul    dx
   3433	1099  8B D8			     mov     bx,ax
   3434	109B  83 BF 001Fr FF		     cmp     word ptr DGROUP:_miniSO_thread[bx+24],-1
   3435	10A0  75 E3			     jne     short @25@674
   3436					;
   3437					;		     miniSO_thread[i].next = miniSO_ready;
   3438					;
   3439	10A2  8B C6			     mov     ax,si
   3440	10A4  BA 001A			     mov     dx,26
   3441	10A7  F7 EA			     imul    dx
   3442	10A9  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   3443	10AD  8B D8			     mov     bx,ax
   3444	10AF  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3445					;
   3446					;		     miniSO_thread[miniSO_ready].prev =	i;
   3447					;
   3448	10B3  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3449	10B6  BA 001A			     mov     dx,26
   3450	10B9  F7 EA			     imul    dx
   3451	10BB  8B D8			     mov     bx,ax
   3452	10BD  89 B7 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],si
   3453	10C1			     @25@758:
   3454					;
   3455					;	     }
   3456					;	     miniSO_thread[miniSO_ready].next =	-1;
   3457					;
   3458	10C1  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3459	10C4  BA 001A			     mov     dx,26
   3460	10C7  F7 EA			     imul    dx
   3461	10C9  8B D8			     mov     bx,ax
   3462	10CB  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
   3463					;
   3464					;	     miniSO_thread[miniSO_ready].status	= ZOMBIE;
   3465					;
   3466	10D1  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3467	10D4  BA 001A			     mov     dx,26
   3468	10D7  F7 EA			     imul    dx
   3469	10D9  8B D8			     mov     bx,ax
   3470	10DB  C7 87 000Br 0002		     mov     word ptr DGROUP:_miniSO_thread[bx+4],2
   3471					;
   3472					;	     miniSO_thread[miniSO_ready].exitcode = codfim;
   3473					;
   3474	10E1  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3475	10E4  BA 001A			     mov     dx,26
   3476	10E7  F7 EA			     imul    dx
   3477	10E9  8B 56 04			     mov     dx,word ptr [bp+4]
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 62
scall.ASM



   3478	10EC  8B D8			     mov     bx,ax
   3479	10EE  89 97 0019r		     mov     word ptr DGROUP:_miniSO_thread[bx+18],dx
   3480					;
   3481					;	     miniSO_nextthread=nextthread;
   3482					;
   3483	10F2  8B 46 FA			     mov     ax,word ptr [bp-6]
   3484	10F5  A3 0004r			     mov     word ptr DGROUP:_miniSO_nextthread,ax
   3485					;
   3486					;	     miniSO_delcurthread=1;
   3487					;
   3488	10F8  C6 06 0006r 01		     mov     byte ptr DGROUP:_miniSO_delcurthread,1
   3489					;
   3490					;	     enable();
   3491					;
   3492	10FD  E8 0000e			     call    near ptr _enable
   3493	1100			     @25@786:
   3494	1100  EB FE			     jmp     short @25@786
   3495					;
   3496					;	     while   (1)
   3497					;		     ;
   3498					;    }
   3499					;
   3500	1102  5F			     pop     di
   3501	1103  5E			     pop     si
   3502	1104  8B E5			     mov     sp,bp
   3503	1106  5D			     pop     bp
   3504	1107  C3			     ret
   3505	1108			     _sc_exit	     endp
   3506					;
   3507					;    pid_t sc_getpid()
   3508					;
   3509					     assume  cs:_TEXT
   3510	1108			     _sc_getpid	     proc    near
   3511	1108  55			     push    bp
   3512	1109  8B EC			     mov     bp,sp
   3513					;
   3514					;    {
   3515					;	     return miniSO_thread[miniSO_ready].pid;
   3516					;
   3517	110B  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3518	110E  BA 001A			     mov     dx,26
   3519	1111  F7 EA			     imul    dx
   3520	1113  8B D8			     mov     bx,ax
   3521	1115  8B 87 0007r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx]
   3522	1119  EB 00			     jmp     short @26@58
   3523	111B			     @26@58:
   3524					;
   3525					;    }
   3526					;
   3527	111B  5D			     pop     bp
   3528	111C  C3			     ret
   3529	111D			     _sc_getpid	     endp
   3530					;
   3531					;    pid_t sc_getppid()
   3532					;
   3533					     assume  cs:_TEXT
   3534	111D			     _sc_getppid     proc    near
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 63
scall.ASM



   3535	111D  55			     push    bp
   3536	111E  8B EC			     mov     bp,sp
   3537					;
   3538					;    {
   3539					;	     return miniSO_thread[miniSO_ready].ppid;
   3540					;
   3541	1120  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3542	1123  BA 001A			     mov     dx,26
   3543	1126  F7 EA			     imul    dx
   3544	1128  8B D8			     mov     bx,ax
   3545	112A  8B 87 0009r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+2]
   3546	112E  EB 00			     jmp     short @27@58
   3547	1130			     @27@58:
   3548					;
   3549					;    }
   3550					;
   3551	1130  5D			     pop     bp
   3552	1131  C3			     ret
   3553	1132			     _sc_getppid     endp
   3554					;
   3555					;    int sc_sendsignal(pid_t pid, signal_t signal)
   3556					;
   3557					     assume  cs:_TEXT
   3558	1132			     _sc_sendsignal  proc    near
   3559	1132  55			     push    bp
   3560	1133  8B EC			     mov     bp,sp
   3561	1135  56			     push    si
   3562	1136  57			     push    di
   3563					;
   3564					;    {
   3565					;	     pcb_t   pcb,last;
   3566					;
   3567					;	     disable();
   3568					;
   3569	1137  E8 0000e			     call    near ptr _disable
   3570					;
   3571					;	     /*	Tem que	verificar se existe a thread */
   3572					;	     pcb = get_pcb(pid);
   3573					;
   3574	113A  FF 76 04			     push    word ptr [bp+4]
   3575	113D  E8 F342			     call    near ptr get_pcb
   3576	1140  59			     pop     cx
   3577	1141  8B F0			     mov     si,ax
   3578					;
   3579					;	     /*	Se nao existe uma thread com este numero, entao	retorna	*/
   3580					;	     if	     (pcb==-1)	{
   3581					;
   3582	1143  83 FE FF			     cmp     si,-1
   3583	1146  75 09			     jne     short @28@114
   3584					;
   3585					;		     enable();
   3586					;
   3587	1148  E8 0000e			     call    near ptr _enable
   3588					;
   3589					;		     return miniSO_ERROR;
   3590					;
   3591	114B  B8 FFFF			     mov     ax,-1
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 64
scall.ASM



   3592	114E			     @28@86:
   3593	114E  E9 00DD			     jmp     @28@226
   3594	1151			     @28@114:
   3595					;
   3596					;	     }
   3597					;	     /*	Seta os	sinais recebidos */
   3598					;	     miniSO_thread[pcb].recvsig	|= signal;
   3599					;
   3600	1151  8B C6			     mov     ax,si
   3601	1153  BA 001A			     mov     dx,26
   3602	1156  F7 EA			     imul    dx
   3603	1158  8B 56 06			     mov     dx,word ptr [bp+6]
   3604	115B  8B D8			     mov     bx,ax
   3605	115D  09 97 0011r		     or	     word ptr DGROUP:_miniSO_thread[bx+10],dx
   3606					;
   3607					;	     /*	A thread pode estar esperando pelos sinais ou nao */
   3608					;	     if	     (miniSO_thread[pcb].status	== WAITSIG)  {
   3609					;
   3610	1161  8B C6			     mov     ax,si
   3611	1163  BA 001A			     mov     dx,26
   3612	1166  F7 EA			     imul    dx
   3613	1168  8B D8			     mov     bx,ax
   3614	116A  83 BF 000Br 04		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],4
   3615	116F  74 03			     je	     @@6
   3616	1171  E9 00B1			     jmp     @28@198
   3617	1174			     @@6:
   3618					;
   3619					;		     /*	Verifica se a thread estava esperando pelo sinal */
   3620					;		     if	     ( (miniSO_thread[pcb].recvsig & miniSO_thread[pcb].waitsig) == +
   3621				     miniSO_thread[pcb].waitsig	)  {
   3622					;
   3623	1174  8B C6			     mov     ax,si
   3624	1176  BA 001A			     mov     dx,26
   3625	1179  F7 EA			     imul    dx
   3626	117B  8B D8			     mov     bx,ax
   3627	117D  8B 87 0011r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+10]
   3628	1181  50			     push    ax
   3629	1182  8B C6			     mov     ax,si
   3630	1184  BA 001A			     mov     dx,26
   3631	1187  F7 EA			     imul    dx
   3632	1189  8B D8			     mov     bx,ax
   3633	118B  58			     pop     ax
   3634	118C  23 87 0013r		     and     ax,word ptr DGROUP:_miniSO_thread[bx+12]
   3635	1190  50			     push    ax
   3636	1191  8B C6			     mov     ax,si
   3637	1193  BA 001A			     mov     dx,26
   3638	1196  F7 EA			     imul    dx
   3639	1198  8B D8			     mov     bx,ax
   3640	119A  58			     pop     ax
   3641	119B  3B 87 0013r		     cmp     ax,word ptr DGROUP:_miniSO_thread[bx+12]
   3642	119F  74 03			     je	     @@7
   3643	11A1  E9 0081			     jmp     @28@198
   3644	11A4			     @@7:
   3645					;
   3646					;			     /*	O sinal	recebido e' suficiente para tirar a thread da espera+
   3647				     */
   3648					;			     last = miniSO_thread[miniSO_ready].prev;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 65
scall.ASM



   3649					;
   3650	11A4  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3651	11A7  BA 001A			     mov     dx,26
   3652	11AA  F7 EA			     imul    dx
   3653	11AC  8B D8			     mov     bx,ax
   3654	11AE  8B BF 001Dr		     mov     di,word ptr DGROUP:_miniSO_thread[bx+22]
   3655					;
   3656					;			     miniSO_thread[pcb].prev = last;
   3657					;
   3658	11B2  8B C6			     mov     ax,si
   3659	11B4  BA 001A			     mov     dx,26
   3660	11B7  F7 EA			     imul    dx
   3661	11B9  8B D8			     mov     bx,ax
   3662	11BB  89 BF 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],di
   3663					;
   3664					;			     miniSO_thread[last].next=pcb;
   3665					;
   3666	11BF  8B C7			     mov     ax,di
   3667	11C1  BA 001A			     mov     dx,26
   3668	11C4  F7 EA			     imul    dx
   3669	11C6  8B D8			     mov     bx,ax
   3670	11C8  89 B7 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],si
   3671					;
   3672					;			     miniSO_thread[miniSO_ready].prev=pcb;
   3673					;
   3674	11CC  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   3675	11CF  BA 001A			     mov     dx,26
   3676	11D2  F7 EA			     imul    dx
   3677	11D4  8B D8			     mov     bx,ax
   3678	11D6  89 B7 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],si
   3679					;
   3680					;			     miniSO_thread[pcb].next=miniSO_ready;
   3681					;
   3682	11DA  8B C6			     mov     ax,si
   3683	11DC  BA 001A			     mov     dx,26
   3684	11DF  F7 EA			     imul    dx
   3685	11E1  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   3686	11E5  8B D8			     mov     bx,ax
   3687	11E7  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3688					;
   3689					;			     miniSO_thread[pcb].status = READY;
   3690					;
   3691	11EB  8B C6			     mov     ax,si
   3692	11ED  BA 001A			     mov     dx,26
   3693	11F0  F7 EA			     imul    dx
   3694	11F2  8B D8			     mov     bx,ax
   3695	11F4  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   3696					;
   3697					;			     /*	Seta sinais recebidos e	sinais esperados */
   3698					;			     miniSO_thread[pcb].recvsig	^= miniSO_thread[pcb].waitsig;
   3699					;
   3700	11FA  8B C6			     mov     ax,si
   3701	11FC  BA 001A			     mov     dx,26
   3702	11FF  F7 EA			     imul    dx
   3703	1201  8B D8			     mov     bx,ax
   3704	1203  8B 87 0013r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+12]
   3705	1207  50			     push    ax
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 66
scall.ASM



   3706	1208  8B C6			     mov     ax,si
   3707	120A  BA 001A			     mov     dx,26
   3708	120D  F7 EA			     imul    dx
   3709	120F  8B D8			     mov     bx,ax
   3710	1211  58			     pop     ax
   3711	1212  31 87 0011r		     xor     word ptr DGROUP:_miniSO_thread[bx+10],ax
   3712					;
   3713					;			     miniSO_thread[pcb].waitsig	= 0;
   3714					;
   3715	1216  8B C6			     mov     ax,si
   3716	1218  BA 001A			     mov     dx,26
   3717	121B  F7 EA			     imul    dx
   3718	121D  8B D8			     mov     bx,ax
   3719	121F  C7 87 0013r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+12],0
   3720	1225			     @28@198:
   3721					;
   3722					;		     }
   3723					;	     }
   3724					;	     enable();
   3725					;
   3726	1225  E8 0000e			     call    near ptr _enable
   3727					;
   3728					;	     return miniSO_OK;
   3729					;
   3730	1228  B8 0001			     mov     ax,1
   3731	122B  E9 FF20			     jmp     @28@86
   3732	122E			     @28@226:
   3733					;
   3734					;    }
   3735					;
   3736	122E  5F			     pop     di
   3737	122F  5E			     pop     si
   3738	1230  5D			     pop     bp
   3739	1231  C3			     ret
   3740	1232			     _sc_sendsignal  endp
   3741					;
   3742					;    int sc_waitsignal(signal_t	signal)
   3743					;
   3744					     assume  cs:_TEXT
   3745	1232			     _sc_waitsignal  proc    near
   3746	1232  55			     push    bp
   3747	1233  8B EC			     mov     bp,sp
   3748	1235  83 EC 06			     sub     sp,6
   3749	1238  56			     push    si
   3750	1239  57			     push    di
   3751	123A  8B 7E 04			     mov     di,word ptr [bp+4]
   3752					;
   3753					;    {
   3754					;	     pcb_t   pcb,prevthread,nextthread;
   3755					;	     int     waitint=0;
   3756					;
   3757	123D  C7 46 FA 0000		     mov     word ptr [bp-6],0
   3758					;
   3759					;
   3760					;	     disable();
   3761					;
   3762	1242  E8 0000e			     call    near ptr _disable
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 67
scall.ASM



   3763					;
   3764					;	     pcb = miniSO_ready;
   3765					;
   3766	1245  8B 36 0007r		     mov     si,word ptr DGROUP:_miniSO_ready
   3767					;
   3768					;	     /*	Verifica se ja'	nao recebeu os sinais */
   3769					;	     if	     ( (miniSO_thread[pcb].recvsig & signal) ==	signal )  {
   3770					;
   3771	1249  8B C6			     mov     ax,si
   3772	124B  BA 001A			     mov     dx,26
   3773	124E  F7 EA			     imul    dx
   3774	1250  8B D8			     mov     bx,ax
   3775	1252  8B 87 0011r		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+10]
   3776	1256  23 C7			     and     ax,di
   3777	1258  3B C7			     cmp     ax,di
   3778	125A  75 1F			     jne     short @29@86
   3779					;
   3780					;		     /*	Ele ja'	recebeu	os sinais */
   3781					;		     miniSO_thread[pcb].recvsig	^= signal;
   3782					;
   3783	125C  8B C6			     mov     ax,si
   3784	125E  BA 001A			     mov     dx,26
   3785	1261  F7 EA			     imul    dx
   3786	1263  8B D8			     mov     bx,ax
   3787	1265  31 BF 0011r		     xor     word ptr DGROUP:_miniSO_thread[bx+10],di
   3788					;
   3789					;		     miniSO_thread[pcb].waitsig	= 0;
   3790					;
   3791	1269  8B C6			     mov     ax,si
   3792	126B  BA 001A			     mov     dx,26
   3793	126E  F7 EA			     imul    dx
   3794	1270  8B D8			     mov     bx,ax
   3795	1272  C7 87 0013r 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+12],0
   3796					;
   3797					;	     }
   3798					;
   3799	1278  E9 0094			     jmp     @29@170
   3800	127B			     @29@86:
   3801					;
   3802					;	     else    {
   3803					;		     /*	Ele ainda nao recebeu os sinais	e vai para a lista de espera */
   3804					;		     miniSO_thread[pcb].waitsig	= signal;
   3805					;
   3806	127B  8B C6			     mov     ax,si
   3807	127D  BA 001A			     mov     dx,26
   3808	1280  F7 EA			     imul    dx
   3809	1282  8B D8			     mov     bx,ax
   3810	1284  89 BF 0013r		     mov     word ptr DGROUP:_miniSO_thread[bx+12],di
   3811					;
   3812					;		     /*	Se eh a	ultima thread ... */
   3813					;		     prevthread	= miniSO_thread[pcb].prev;
   3814					;
   3815	1288  8B C6			     mov     ax,si
   3816	128A  BA 001A			     mov     dx,26
   3817	128D  F7 EA			     imul    dx
   3818	128F  8B D8			     mov     bx,ax
   3819	1291  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 68
scall.ASM



   3820	1295  89 46 FE			     mov     word ptr [bp-2],ax
   3821					;
   3822					;		     nextthread	= miniSO_thread[pcb].next;
   3823					;
   3824	1298  8B C6			     mov     ax,si
   3825	129A  BA 001A			     mov     dx,26
   3826	129D  F7 EA			     imul    dx
   3827	129F  8B D8			     mov     bx,ax
   3828	12A1  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   3829	12A5  89 46 FC			     mov     word ptr [bp-4],ax
   3830					;
   3831					;		     if	     (pcb == nextthread)
   3832					;
   3833	12A8  3B 76 FC			     cmp     si,word ptr [bp-4]
   3834	12AB  75 08			     jne     short @29@142
   3835					;
   3836					;			     end_mso("waitsignal(): nao	ha' mais threads executando!");
   3837					;
   3838	12AD  B8 01B8r			     mov     ax,offset DGROUP:s@+292
   3839	12B0  50			     push    ax
   3840	12B1  E8 F189			     call    near ptr end_mso
   3841	12B4  59			     pop     cx
   3842	12B5			     @29@142:
   3843					;
   3844					;		     /*	Retira o BCP da	thread corrente	da lista de prontos */
   3845					;		     miniSO_thread[pcb].next = -1;
   3846					;
   3847	12B5  8B C6			     mov     ax,si
   3848	12B7  BA 001A			     mov     dx,26
   3849	12BA  F7 EA			     imul    dx
   3850	12BC  8B D8			     mov     bx,ax
   3851	12BE  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
   3852					;
   3853					;		     miniSO_thread[pcb].prev  =	-1;
   3854					;
   3855	12C4  8B C6			     mov     ax,si
   3856	12C6  BA 001A			     mov     dx,26
   3857	12C9  F7 EA			     imul    dx
   3858	12CB  8B D8			     mov     bx,ax
   3859	12CD  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   3860					;
   3861					;		     /*	Exclui o nodo da lista de prontos */
   3862					;		     miniSO_thread[prevthread].next=nextthread;
   3863					;
   3864	12D3  8B 46 FE			     mov     ax,word ptr [bp-2]
   3865	12D6  BA 001A			     mov     dx,26
   3866	12D9  F7 EA			     imul    dx
   3867	12DB  8B 56 FC			     mov     dx,word ptr [bp-4]
   3868	12DE  8B D8			     mov     bx,ax
   3869	12E0  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   3870					;
   3871					;		     miniSO_thread[nextthread].prev=prevthread;
   3872					;
   3873	12E4  8B 46 FC			     mov     ax,word ptr [bp-4]
   3874	12E7  BA 001A			     mov     dx,26
   3875	12EA  F7 EA			     imul    dx
   3876	12EC  8B 56 FE			     mov     dx,word ptr [bp-2]
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 69
scall.ASM



   3877	12EF  8B D8			     mov     bx,ax
   3878	12F1  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   3879					;
   3880					;		     miniSO_thread[pcb].status = WAITSIG;
   3881					;
   3882	12F5  8B C6			     mov     ax,si
   3883	12F7  BA 001A			     mov     dx,26
   3884	12FA  F7 EA			     imul    dx
   3885	12FC  8B D8			     mov     bx,ax
   3886	12FE  C7 87 000Br 0004		     mov     word ptr DGROUP:_miniSO_thread[bx+4],4
   3887					;
   3888					;		     miniSO_nextthread=nextthread;
   3889					;
   3890	1304  8B 46 FC			     mov     ax,word ptr [bp-4]
   3891	1307  A3 0004r			     mov     word ptr DGROUP:_miniSO_nextthread,ax
   3892					;
   3893					;		     waitint=1;
   3894					;
   3895	130A  C7 46 FA 0001		     mov     word ptr [bp-6],1
   3896	130F			     @29@170:
   3897					;
   3898					;	     }
   3899					;	     enable();
   3900					;
   3901	130F  E8 0000e			     call    near ptr _enable
   3902					;
   3903					;	     if	     (waitint)
   3904					;
   3905	1312  83 7E FA 00		     cmp     word ptr [bp-6],0
   3906	1316  74 12			     je	     short @29@254
   3907	1318  EB 00			     jmp     short @29@226
   3908	131A			     @29@226:
   3909					;
   3910					;		     while   (miniSO_thread[pcb].status	== WAITSIG)
   3911					;
   3912	131A  8B C6			     mov     ax,si
   3913	131C  BA 001A			     mov     dx,26
   3914	131F  F7 EA			     imul    dx
   3915	1321  8B D8			     mov     bx,ax
   3916	1323  83 BF 000Br 04		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],4
   3917	1328  74 F0			     je	     short @29@226
   3918	132A			     @29@254:
   3919					;
   3920					;			     ;
   3921					;	     return 0;
   3922					;
   3923	132A  33 C0			     xor     ax,ax
   3924	132C  EB 00			     jmp     short @29@282
   3925	132E			     @29@282:
   3926					;
   3927					;    }
   3928					;
   3929	132E  5F			     pop     di
   3930	132F  5E			     pop     si
   3931	1330  8B E5			     mov     sp,bp
   3932	1332  5D			     pop     bp
   3933	1333  C3			     ret
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 70
scall.ASM



   3934	1334			     _sc_waitsignal  endp
   3935					;
   3936					;    static int	get_sem_pos(semid_t s)
   3937					;
   3938					     assume  cs:_TEXT
   3939	1334			     get_sem_pos     proc    near
   3940	1334  55			     push    bp
   3941	1335  8B EC			     mov     bp,sp
   3942					;
   3943					;    {
   3944					;	     int i;
   3945					;
   3946					;	     for     (i=0;i<miniSO_MAXSEMAPHORES;++i)
   3947					;
   3948	1337  33 D2			     xor     dx,dx
   3949	1339  EB 21			     jmp     short @30@198
   3950	133B			     @30@58:
   3951					;
   3952					;		     if	     (miniSO_sem[i].status!=FREE && miniSO_sem[i].semid==s)
   3953					;
   3954	133B  8B DA			     mov     bx,dx
   3955	133D  B1 03			     mov     cl,3
   3956	133F  D3 E3			     shl     bx,cl
   3957	1341  83 BF 01A7r FF		     cmp     word ptr DGROUP:_miniSO_sem[bx],-1
   3958	1346  74 13			     je	     short @30@170
   3959	1348  8B DA			     mov     bx,dx
   3960	134A  B1 03			     mov     cl,3
   3961	134C  D3 E3			     shl     bx,cl
   3962	134E  8B 87 01A9r		     mov     ax,word ptr DGROUP:_miniSO_sem[bx+2]
   3963	1352  3B 46 04			     cmp     ax,word ptr [bp+4]
   3964	1355  75 04			     jne     short @30@170
   3965					;
   3966					;			     return i;
   3967					;
   3968	1357  8B C2			     mov     ax,dx
   3969	1359			     @30@142:
   3970	1359  EB 0B			     jmp     short @30@254
   3971	135B			     @30@170:
   3972	135B  42			     inc     dx
   3973	135C			     @30@198:
   3974	135C  83 FA 0A			     cmp     dx,10
   3975	135F  7C DA			     jl	     short @30@58
   3976					;
   3977					;	     return miniSO_ERROR;
   3978					;
   3979	1361  B8 FFFF			     mov     ax,-1
   3980	1364  EB F3			     jmp     short @30@142
   3981	1366			     @30@254:
   3982					;
   3983					;    }
   3984					;
   3985	1366  5D			     pop     bp
   3986	1367  C3			     ret
   3987	1368			     get_sem_pos     endp
   3988					;
   3989					;    semid_t sc_semcreate (int value)
   3990					;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 71
scall.ASM



   3991					     assume  cs:_TEXT
   3992	1368			     _sc_semcreate   proc    near
   3993	1368  55			     push    bp
   3994	1369  8B EC			     mov     bp,sp
   3995	136B  56			     push    si
   3996					;
   3997					;    {
   3998					;	     int i;
   3999					;	     semid_t s;
   4000					;
   4001					;	     for     (i=0;i<miniSO_MAXSEMAPHORES;++i)
   4002					;
   4003	136C  33 F6			     xor     si,si
   4004	136E  EB 74 90			     jmp     @31@310
   4005	1371			     @31@58:
   4006					;
   4007					;		     if	     (miniSO_sem[i].status==FREE) {
   4008					;
   4009	1371  8B DE			     mov     bx,si
   4010	1373  B1 03			     mov     cl,3
   4011	1375  D3 E3			     shl     bx,cl
   4012	1377  83 BF 01A7r FF		     cmp     word ptr DGROUP:_miniSO_sem[bx],-1
   4013	137C  75 65			     jne     short @31@282
   4014	137E  EB 14			     jmp     short @31@198
   4015	1380			     @31@114:
   4016					;
   4017					;			     /*	Gera um	semid */
   4018					;			     while   (get_sem_pos(nextsemid)!=miniSO_ERROR) {
   4019					;				     if	     (nextsemid==32767)
   4020					;
   4021	1380  81 3E 0005r 7FFF		     cmp     word ptr DGROUP:nextsemid,32767
   4022	1386  75 08			     jne     short @31@170
   4023					;
   4024					;					     nextsemid = 0;
   4025					;
   4026	1388  C7 06 0005r 0000		     mov     word ptr DGROUP:nextsemid,0
   4027	138E  EB 04			     jmp     short @31@198
   4028	1390			     @31@170:
   4029					;
   4030					;				     else
   4031					;					     nextsemid++;
   4032					;
   4033	1390  FF 06 0005r		     inc     word ptr DGROUP:nextsemid
   4034	1394			     @31@198:
   4035	1394  FF 36 0005r		     push    word ptr DGROUP:nextsemid
   4036	1398  E8 FF99			     call    near ptr get_sem_pos
   4037	139B  59			     pop     cx
   4038	139C  3D FFFF			     cmp     ax,-1
   4039	139F  75 DF			     jne     short @31@114
   4040					;
   4041					;			     }
   4042					;			     miniSO_sem[i].status=READY;
   4043					;
   4044	13A1  8B DE			     mov     bx,si
   4045	13A3  B1 03			     mov     cl,3
   4046	13A5  D3 E3			     shl     bx,cl
   4047	13A7  C7 87 01A7r 0000		     mov     word ptr DGROUP:_miniSO_sem[bx],0
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 72
scall.ASM



   4048					;
   4049					;			     miniSO_sem[i].semid=nextsemid++;
   4050					;
   4051	13AD  8B DE			     mov     bx,si
   4052	13AF  B1 03			     mov     cl,3
   4053	13B1  D3 E3			     shl     bx,cl
   4054	13B3  A1 0005r			     mov     ax,word ptr DGROUP:nextsemid
   4055	13B6  89 87 01A9r		     mov     word ptr DGROUP:_miniSO_sem[bx+2],ax
   4056	13BA  FF 06 0005r		     inc     word ptr DGROUP:nextsemid
   4057					;
   4058					;			     miniSO_sem[i].value=value;
   4059					;
   4060	13BE  8B DE			     mov     bx,si
   4061	13C0  B1 03			     mov     cl,3
   4062	13C2  D3 E3			     shl     bx,cl
   4063	13C4  8B 46 04			     mov     ax,word ptr [bp+4]
   4064	13C7  89 87 01ABr		     mov     word ptr DGROUP:_miniSO_sem[bx+4],ax
   4065					;
   4066					;			     miniSO_sem[i].queue=-1;
   4067					;
   4068	13CB  8B DE			     mov     bx,si
   4069	13CD  B1 03			     mov     cl,3
   4070	13CF  D3 E3			     shl     bx,cl
   4071	13D1  C7 87 01ADr FFFF		     mov     word ptr DGROUP:_miniSO_sem[bx+6],-1
   4072					;
   4073					;			     return miniSO_sem[i].semid;
   4074					;
   4075	13D7  8B DE			     mov     bx,si
   4076	13D9  B1 03			     mov     cl,3
   4077	13DB  D3 E3			     shl     bx,cl
   4078	13DD  8B 87 01A9r		     mov     ax,word ptr DGROUP:_miniSO_sem[bx+2]
   4079	13E1			     @31@254:
   4080	13E1  EB 0D			     jmp     short @31@366
   4081	13E3			     @31@282:
   4082	13E3  46			     inc     si
   4083	13E4			     @31@310:
   4084	13E4  83 FE 0A			     cmp     si,10
   4085	13E7  7D 02			     jge     @@8
   4086	13E9  EB 86			     jmp     @31@58
   4087	13EB			     @@8:
   4088					;
   4089					;		     }
   4090					;	     return miniSO_ERROR;
   4091					;
   4092	13EB  B8 FFFF			     mov     ax,-1
   4093	13EE  EB F1			     jmp     short @31@254
   4094	13F0			     @31@366:
   4095					;
   4096					;    }
   4097					;
   4098	13F0  5E			     pop     si
   4099	13F1  5D			     pop     bp
   4100	13F2  C3			     ret
   4101	13F3			     _sc_semcreate   endp
   4102					;
   4103					;    int sc_semset (semid_t s,int value)
   4104					;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 73
scall.ASM



   4105					     assume  cs:_TEXT
   4106	13F3			     _sc_semset	     proc    near
   4107	13F3  55			     push    bp
   4108	13F4  8B EC			     mov     bp,sp
   4109	13F6  56			     push    si
   4110					;
   4111					;    {
   4112					;	     int sem;
   4113					;
   4114					;	     sem = get_sem_pos(s);
   4115					;
   4116	13F7  FF 76 04			     push    word ptr [bp+4]
   4117	13FA  E8 FF37			     call    near ptr get_sem_pos
   4118	13FD  59			     pop     cx
   4119	13FE  8B F0			     mov     si,ax
   4120					;
   4121					;	     if	     (sem==miniSO_ERROR	|| miniSO_sem[sem].queue!=-1)
   4122					;
   4123	1400  83 FE FF			     cmp     si,-1
   4124	1403  74 0D			     je	     short @32@86
   4125	1405  8B DE			     mov     bx,si
   4126	1407  B1 03			     mov     cl,3
   4127	1409  D3 E3			     shl     bx,cl
   4128	140B  83 BF 01ADr FF		     cmp     word ptr DGROUP:_miniSO_sem[bx+6],-1
   4129	1410  74 05			     je	     short @32@142
   4130	1412			     @32@86:
   4131					;
   4132					;		     return miniSO_ERROR;
   4133					;
   4134	1412  B8 FFFF			     mov     ax,-1
   4135	1415			     @32@114:
   4136	1415  EB 12			     jmp     short @32@170
   4137	1417			     @32@142:
   4138					;
   4139					;	     miniSO_sem[sem].value = value;
   4140					;
   4141	1417  8B DE			     mov     bx,si
   4142	1419  B1 03			     mov     cl,3
   4143	141B  D3 E3			     shl     bx,cl
   4144	141D  8B 46 06			     mov     ax,word ptr [bp+6]
   4145	1420  89 87 01ABr		     mov     word ptr DGROUP:_miniSO_sem[bx+4],ax
   4146					;
   4147					;	     return miniSO_OK;
   4148					;
   4149	1424  B8 0001			     mov     ax,1
   4150	1427  EB EC			     jmp     short @32@114
   4151	1429			     @32@170:
   4152					;
   4153					;    }
   4154					;
   4155	1429  5E			     pop     si
   4156	142A  5D			     pop     bp
   4157	142B  C3			     ret
   4158	142C			     _sc_semset	     endp
   4159					;
   4160					;    int sc_semup (semid_t s)
   4161					;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 74
scall.ASM



   4162					     assume  cs:_TEXT
   4163	142C			     _sc_semup	     proc    near
   4164	142C  55			     push    bp
   4165	142D  8B EC			     mov     bp,sp
   4166	142F  83 EC 02			     sub     sp,2
   4167	1432  56			     push    si
   4168	1433  57			     push    di
   4169					;
   4170					;    {
   4171					;	     int sem;
   4172					;	     pcb_t pcb,last,prevthread,nextthread;
   4173					;
   4174					;	     disable();
   4175					;
   4176	1434  E8 0000e			     call    near ptr _disable
   4177					;
   4178					;	     sem = get_sem_pos(s);
   4179					;
   4180	1437  FF 76 04			     push    word ptr [bp+4]
   4181	143A  E8 FEF7			     call    near ptr get_sem_pos
   4182	143D  59			     pop     cx
   4183	143E  8B F0			     mov     si,ax
   4184					;
   4185					;	     if	     (sem==miniSO_ERROR) {
   4186					;
   4187	1440  83 FE FF			     cmp     si,-1
   4188	1443  75 09			     jne     short @33@114
   4189					;
   4190					;		     enable();
   4191					;
   4192	1445  E8 0000e			     call    near ptr _enable
   4193					;
   4194					;		     return miniSO_ERROR;
   4195					;
   4196	1448  B8 FFFF			     mov     ax,-1
   4197	144B			     @33@86:
   4198	144B  E9 00C5			     jmp     @33@254
   4199	144E			     @33@114:
   4200					;
   4201					;	     }
   4202					;	     miniSO_sem[sem].value++;
   4203					;
   4204	144E  8B DE			     mov     bx,si
   4205	1450  B1 03			     mov     cl,3
   4206	1452  D3 E3			     shl     bx,cl
   4207	1454  FF 87 01ABr		     inc     word ptr DGROUP:_miniSO_sem[bx+4]
   4208					;
   4209					;	     if	     (miniSO_sem[sem].queue!=-1) {
   4210					;
   4211	1458  8B DE			     mov     bx,si
   4212	145A  B1 03			     mov     cl,3
   4213	145C  D3 E3			     shl     bx,cl
   4214	145E  83 BF 01ADr FF		     cmp     word ptr DGROUP:_miniSO_sem[bx+6],-1
   4215	1463  75 03			     jne     @@9
   4216	1465  E9 00A2			     jmp     @33@226
   4217	1468			     @@9:
   4218					;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 75
scall.ASM



   4219					;		     pcb = miniSO_sem[sem].queue;
   4220					;
   4221	1468  8B DE			     mov     bx,si
   4222	146A  B1 03			     mov     cl,3
   4223	146C  D3 E3			     shl     bx,cl
   4224	146E  8B BF 01ADr		     mov     di,word ptr DGROUP:_miniSO_sem[bx+6]
   4225					;
   4226					;		     miniSO_sem[sem].queue = miniSO_thread[pcb].next;
   4227					;
   4228	1472  8B C7			     mov     ax,di
   4229	1474  BA 001A			     mov     dx,26
   4230	1477  F7 EA			     imul    dx
   4231	1479  8B D8			     mov     bx,ax
   4232	147B  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   4233	147F  8B DE			     mov     bx,si
   4234	1481  B1 03			     mov     cl,3
   4235	1483  D3 E3			     shl     bx,cl
   4236	1485  89 87 01ADr		     mov     word ptr DGROUP:_miniSO_sem[bx+6],ax
   4237					;
   4238					;		     if	     (miniSO_sem[sem].queue!=-1)
   4239					;
   4240	1489  8B DE			     mov     bx,si
   4241	148B  B1 03			     mov     cl,3
   4242	148D  D3 E3			     shl     bx,cl
   4243	148F  83 BF 01ADr FF		     cmp     word ptr DGROUP:_miniSO_sem[bx+6],-1
   4244	1494  74 17			     je	     short @33@198
   4245					;
   4246					;			     miniSO_thread[miniSO_sem[sem].queue].prev = -1;
   4247					;
   4248	1496  8B DE			     mov     bx,si
   4249	1498  B1 03			     mov     cl,3
   4250	149A  D3 E3			     shl     bx,cl
   4251	149C  8B 87 01ADr		     mov     ax,word ptr DGROUP:_miniSO_sem[bx+6]
   4252	14A0  BA 001A			     mov     dx,26
   4253	14A3  F7 EA			     imul    dx
   4254	14A5  8B D8			     mov     bx,ax
   4255	14A7  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   4256	14AD			     @33@198:
   4257					;
   4258					;		     last = miniSO_thread[miniSO_ready].prev;
   4259					;
   4260	14AD  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   4261	14B0  BA 001A			     mov     dx,26
   4262	14B3  F7 EA			     imul    dx
   4263	14B5  8B D8			     mov     bx,ax
   4264	14B7  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   4265	14BB  89 46 FE			     mov     word ptr [bp-2],ax
   4266					;
   4267					;		     miniSO_thread[pcb].prev = last;
   4268					;
   4269	14BE  8B C7			     mov     ax,di
   4270	14C0  BA 001A			     mov     dx,26
   4271	14C3  F7 EA			     imul    dx
   4272	14C5  8B 56 FE			     mov     dx,word ptr [bp-2]
   4273	14C8  8B D8			     mov     bx,ax
   4274	14CA  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   4275					;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 76
scall.ASM



   4276					;		     miniSO_thread[last].next=pcb;
   4277					;
   4278	14CE  8B 46 FE			     mov     ax,word ptr [bp-2]
   4279	14D1  BA 001A			     mov     dx,26
   4280	14D4  F7 EA			     imul    dx
   4281	14D6  8B D8			     mov     bx,ax
   4282	14D8  89 BF 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],di
   4283					;
   4284					;		     miniSO_thread[miniSO_ready].prev=pcb;
   4285					;
   4286	14DC  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   4287	14DF  BA 001A			     mov     dx,26
   4288	14E2  F7 EA			     imul    dx
   4289	14E4  8B D8			     mov     bx,ax
   4290	14E6  89 BF 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],di
   4291					;
   4292					;		     miniSO_thread[pcb].next=miniSO_ready;
   4293					;
   4294	14EA  8B C7			     mov     ax,di
   4295	14EC  BA 001A			     mov     dx,26
   4296	14EF  F7 EA			     imul    dx
   4297	14F1  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   4298	14F5  8B D8			     mov     bx,ax
   4299	14F7  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   4300					;
   4301					;		     miniSO_thread[pcb].status = READY;
   4302					;
   4303	14FB  8B C7			     mov     ax,di
   4304	14FD  BA 001A			     mov     dx,26
   4305	1500  F7 EA			     imul    dx
   4306	1502  8B D8			     mov     bx,ax
   4307	1504  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   4308	150A			     @33@226:
   4309					;
   4310					;	     }
   4311					;	     enable();
   4312					;
   4313	150A  E8 0000e			     call    near ptr _enable
   4314					;
   4315					;	     return miniSO_OK;
   4316					;
   4317	150D  B8 0001			     mov     ax,1
   4318	1510  E9 FF38			     jmp     @33@86
   4319	1513			     @33@254:
   4320					;
   4321					;    }
   4322					;
   4323	1513  5F			     pop     di
   4324	1514  5E			     pop     si
   4325	1515  8B E5			     mov     sp,bp
   4326	1517  5D			     pop     bp
   4327	1518  C3			     ret
   4328	1519			     _sc_semup	     endp
   4329					;
   4330					;    int sc_semdown (semid_t s)
   4331					;
   4332					     assume  cs:_TEXT
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 77
scall.ASM



   4333	1519			     _sc_semdown     proc    near
   4334	1519  55			     push    bp
   4335	151A  8B EC			     mov     bp,sp
   4336	151C  83 EC 08			     sub     sp,8
   4337	151F  56			     push    si
   4338	1520  57			     push    di
   4339					;
   4340					;    {
   4341					;	     int sem;
   4342					;	     pcb_t pcb,ant,i,prevthread,nextthread;
   4343					;
   4344					;	     disable();
   4345					;
   4346	1521  E8 0000e			     call    near ptr _disable
   4347					;
   4348					;	     sem = get_sem_pos(s);
   4349					;
   4350	1524  FF 76 04			     push    word ptr [bp+4]
   4351	1527  E8 FE0A			     call    near ptr get_sem_pos
   4352	152A  59			     pop     cx
   4353	152B  8B F8			     mov     di,ax
   4354					;
   4355					;	     if	     (sem==miniSO_ERROR) {
   4356					;
   4357	152D  83 FF FF			     cmp     di,-1
   4358	1530  75 09			     jne     short @34@114
   4359					;
   4360					;		     enable();
   4361					;
   4362	1532  E8 0000e			     call    near ptr _enable
   4363					;
   4364					;		     return miniSO_ERROR;
   4365					;
   4366	1535  B8 FFFF			     mov     ax,-1
   4367	1538			     @34@86:
   4368	1538  E9 011E			     jmp     @34@534
   4369	153B			     @34@114:
   4370					;
   4371					;	     }
   4372					;	     miniSO_sem[sem].value--;
   4373					;
   4374	153B  8B DF			     mov     bx,di
   4375	153D  B1 03			     mov     cl,3
   4376	153F  D3 E3			     shl     bx,cl
   4377	1541  FF 8F 01ABr		     dec     word ptr DGROUP:_miniSO_sem[bx+4]
   4378					;
   4379					;	     if	     (miniSO_sem[sem].value<0) {
   4380					;
   4381	1545  8B DF			     mov     bx,di
   4382	1547  B1 03			     mov     cl,3
   4383	1549  D3 E3			     shl     bx,cl
   4384	154B  83 BF 01ABr 00		     cmp     word ptr DGROUP:_miniSO_sem[bx+4],0
   4385	1550  7C 03			     jl	     @@10
   4386	1552  E9 00FB			     jmp     @34@478
   4387	1555			     @@10:
   4388					;
   4389					;		     pcb = miniSO_ready;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 78
scall.ASM



   4390					;
   4391	1555  8B 36 0007r		     mov     si,word ptr DGROUP:_miniSO_ready
   4392					;
   4393					;		     prevthread	= miniSO_thread[pcb].prev;
   4394					;
   4395	1559  8B C6			     mov     ax,si
   4396	155B  BA 001A			     mov     dx,26
   4397	155E  F7 EA			     imul    dx
   4398	1560  8B D8			     mov     bx,ax
   4399	1562  8B 87 001Dr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+22]
   4400	1566  89 46 FA			     mov     word ptr [bp-6],ax
   4401					;
   4402					;		     nextthread	= miniSO_thread[pcb].next;
   4403					;
   4404	1569  8B C6			     mov     ax,si
   4405	156B  BA 001A			     mov     dx,26
   4406	156E  F7 EA			     imul    dx
   4407	1570  8B D8			     mov     bx,ax
   4408	1572  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   4409	1576  89 46 F8			     mov     word ptr [bp-8],ax
   4410					;
   4411					;		     /*	Se eh a	ultima thread ... */
   4412					;		     if	     (pcb == nextthread)
   4413					;
   4414	1579  3B 76 F8			     cmp     si,word ptr [bp-8]
   4415	157C  75 08			     jne     short @34@198
   4416					;
   4417					;			     end_mso("semdown(): nao ha' mais threads executando!");
   4418					;
   4419	157E  B8 01E7r			     mov     ax,offset DGROUP:s@+339
   4420	1581  50			     push    ax
   4421	1582  E8 EEB8			     call    near ptr end_mso
   4422	1585  59			     pop     cx
   4423	1586			     @34@198:
   4424					;
   4425					;		     /*	Coloca o BCP da	thread no final	da lista de espera do semaforo */
   4426					;		     ant = -1;
   4427					;
   4428	1586  C7 46 FE FFFF		     mov     word ptr [bp-2],-1
   4429					;
   4430					;		     i = miniSO_sem[sem].queue;
   4431					;
   4432	158B  8B DF			     mov     bx,di
   4433	158D  B1 03			     mov     cl,3
   4434	158F  D3 E3			     shl     bx,cl
   4435	1591  8B 87 01ADr		     mov     ax,word ptr DGROUP:_miniSO_sem[bx+6]
   4436	1595  EB 14			     jmp     short @34@254
   4437	1597			     @34@226:
   4438					;
   4439					;		     while   (i!=-1) {
   4440					;			     ant = i;
   4441					;
   4442	1597  8B 46 FC			     mov     ax,word ptr [bp-4]
   4443	159A  89 46 FE			     mov     word ptr [bp-2],ax
   4444					;
   4445					;			     i = miniSO_thread[i].next;
   4446					;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 79
scall.ASM



   4447	159D  8B 46 FC			     mov     ax,word ptr [bp-4]
   4448	15A0  BA 001A			     mov     dx,26
   4449	15A3  F7 EA			     imul    dx
   4450	15A5  8B D8			     mov     bx,ax
   4451	15A7  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   4452	15AB			     @34@254:
   4453	15AB  89 46 FC			     mov     word ptr [bp-4],ax
   4454	15AE  83 7E FC FF		     cmp     word ptr [bp-4],-1
   4455	15B2  75 E3			     jne     short @34@226
   4456					;
   4457					;		     }
   4458					;		     if	     (ant==-1) {
   4459					;
   4460	15B4  83 7E FE FF		     cmp     word ptr [bp-2],-1
   4461	15B8  75 1B			     jne     short @34@366
   4462					;
   4463					;			     miniSO_sem[sem].queue = pcb;
   4464					;
   4465	15BA  8B DF			     mov     bx,di
   4466	15BC  B1 03			     mov     cl,3
   4467	15BE  D3 E3			     shl     bx,cl
   4468	15C0  89 B7 01ADr		     mov     word ptr DGROUP:_miniSO_sem[bx+6],si
   4469					;
   4470					;			     miniSO_thread[pcb].prev = -1;
   4471					;
   4472	15C4  8B C6			     mov     ax,si
   4473	15C6  BA 001A			     mov     dx,26
   4474	15C9  F7 EA			     imul    dx
   4475	15CB  8B D8			     mov     bx,ax
   4476	15CD  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   4477					;
   4478					;		     }
   4479					;
   4480	15D3  EB 1E			     jmp     short @34@394
   4481	15D5			     @34@366:
   4482					;
   4483					;		     else {
   4484					;			     miniSO_thread[ant].next = pcb;
   4485					;
   4486	15D5  8B 46 FE			     mov     ax,word ptr [bp-2]
   4487	15D8  BA 001A			     mov     dx,26
   4488	15DB  F7 EA			     imul    dx
   4489	15DD  8B D8			     mov     bx,ax
   4490	15DF  89 B7 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],si
   4491					;
   4492					;			     miniSO_thread[pcb].prev = ant;
   4493					;
   4494	15E3  8B C6			     mov     ax,si
   4495	15E5  BA 001A			     mov     dx,26
   4496	15E8  F7 EA			     imul    dx
   4497	15EA  8B 56 FE			     mov     dx,word ptr [bp-2]
   4498	15ED  8B D8			     mov     bx,ax
   4499	15EF  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   4500	15F3			     @34@394:
   4501					;
   4502					;		     }
   4503					;		     miniSO_thread[pcb].next = -1;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 80
scall.ASM



   4504					;
   4505	15F3  8B C6			     mov     ax,si
   4506	15F5  BA 001A			     mov     dx,26
   4507	15F8  F7 EA			     imul    dx
   4508	15FA  8B D8			     mov     bx,ax
   4509	15FC  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
   4510					;
   4511					;		     /*	Exclui o nodo da lista de prontos */
   4512					;		     miniSO_thread[prevthread].next=nextthread;
   4513					;
   4514	1602  8B 46 FA			     mov     ax,word ptr [bp-6]
   4515	1605  BA 001A			     mov     dx,26
   4516	1608  F7 EA			     imul    dx
   4517	160A  8B 56 F8			     mov     dx,word ptr [bp-8]
   4518	160D  8B D8			     mov     bx,ax
   4519	160F  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   4520					;
   4521					;		     miniSO_thread[nextthread].prev=prevthread;
   4522					;
   4523	1613  8B 46 F8			     mov     ax,word ptr [bp-8]
   4524	1616  BA 001A			     mov     dx,26
   4525	1619  F7 EA			     imul    dx
   4526	161B  8B 56 FA			     mov     dx,word ptr [bp-6]
   4527	161E  8B D8			     mov     bx,ax
   4528	1620  89 97 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],dx
   4529					;
   4530					;		     miniSO_thread[pcb].status = WAITSEM;
   4531					;
   4532	1624  8B C6			     mov     ax,si
   4533	1626  BA 001A			     mov     dx,26
   4534	1629  F7 EA			     imul    dx
   4535	162B  8B D8			     mov     bx,ax
   4536	162D  C7 87 000Br 0005		     mov     word ptr DGROUP:_miniSO_thread[bx+4],5
   4537					;
   4538					;		     miniSO_nextthread=nextthread;
   4539					;
   4540	1633  8B 46 F8			     mov     ax,word ptr [bp-8]
   4541	1636  A3 0004r			     mov     word ptr DGROUP:_miniSO_nextthread,ax
   4542					;
   4543					;		     enable();
   4544					;
   4545	1639  E8 0000e			     call    near ptr _enable
   4546	163C  EB 00			     jmp     short @34@422
   4547	163E			     @34@422:
   4548					;
   4549					;		     while   (miniSO_thread[pcb].status	== WAITSEM)
   4550					;
   4551	163E  8B C6			     mov     ax,si
   4552	1640  BA 001A			     mov     dx,26
   4553	1643  F7 EA			     imul    dx
   4554	1645  8B D8			     mov     bx,ax
   4555	1647  83 BF 000Br 05		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],5
   4556	164C  74 F0			     je	     short @34@422
   4557					;
   4558					;			     ;
   4559					;	     }
   4560					;
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 81
scall.ASM



   4561	164E  EB 03			     jmp     short @34@506
   4562	1650			     @34@478:
   4563					;
   4564					;	     else
   4565					;		     enable();
   4566					;
   4567	1650  E8 0000e			     call    near ptr _enable
   4568	1653			     @34@506:
   4569					;
   4570					;	     return miniSO_OK;
   4571					;
   4572	1653  B8 0001			     mov     ax,1
   4573	1656  E9 FEDF			     jmp     @34@86
   4574	1659			     @34@534:
   4575					;
   4576					;    }
   4577					;
   4578	1659  5F			     pop     di
   4579	165A  5E			     pop     si
   4580	165B  8B E5			     mov     sp,bp
   4581	165D  5D			     pop     bp
   4582	165E  C3			     ret
   4583	165F			     _sc_semdown     endp
   4584					;
   4585					;    int sc_semdestroy (semid_t	s)
   4586					;
   4587					     assume  cs:_TEXT
   4588	165F			     _sc_semdestroy  proc    near
   4589	165F  55			     push    bp
   4590	1660  8B EC			     mov     bp,sp
   4591	1662  56			     push    si
   4592					;
   4593					;    {
   4594					;	     int sem;
   4595					;
   4596					;	     sem = get_sem_pos(s);
   4597					;
   4598	1663  FF 76 04			     push    word ptr [bp+4]
   4599	1666  E8 FCCB			     call    near ptr get_sem_pos
   4600	1669  59			     pop     cx
   4601	166A  8B F0			     mov     si,ax
   4602					;
   4603					;	     if	     (sem==miniSO_ERROR	|| miniSO_sem[sem].queue!=-1)
   4604					;
   4605	166C  83 FE FF			     cmp     si,-1
   4606	166F  74 0D			     je	     short @35@86
   4607	1671  8B DE			     mov     bx,si
   4608	1673  B1 03			     mov     cl,3
   4609	1675  D3 E3			     shl     bx,cl
   4610	1677  83 BF 01ADr FF		     cmp     word ptr DGROUP:_miniSO_sem[bx+6],-1
   4611	167C  74 05			     je	     short @35@142
   4612	167E			     @35@86:
   4613					;
   4614					;		     return miniSO_ERROR;
   4615					;
   4616	167E  B8 FFFF			     mov     ax,-1
   4617	1681			     @35@114:
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 82
scall.ASM



   4618	1681  EB 11			     jmp     short @35@170
   4619	1683			     @35@142:
   4620					;
   4621					;	     miniSO_sem[sem].status = FREE;
   4622					;
   4623	1683  8B DE			     mov     bx,si
   4624	1685  B1 03			     mov     cl,3
   4625	1687  D3 E3			     shl     bx,cl
   4626	1689  C7 87 01A7r FFFF		     mov     word ptr DGROUP:_miniSO_sem[bx],-1
   4627					;
   4628					;	     return miniSO_OK;
   4629					;
   4630	168F  B8 0001			     mov     ax,1
   4631	1692  EB ED			     jmp     short @35@114
   4632	1694			     @35@170:
   4633					;
   4634					;    }
   4635					;
   4636	1694  5E			     pop     si
   4637	1695  5D			     pop     bp
   4638	1696  C3			     ret
   4639	1697			     _sc_semdestroy  endp
   4640					;
   4641					;    int sc_stop(pid_t pid){
   4642					;
   4643					     assume  cs:_TEXT
   4644	1697			     _sc_stop	     proc    near
   4645	1697  55			     push    bp
   4646	1698  8B EC			     mov     bp,sp
   4647	169A  83 EC 02			     sub     sp,2
   4648	169D  56			     push    si
   4649	169E  57			     push    di
   4650					;
   4651					;	 pcb_t pcb,prevthread,nextthread;
   4652					;	 disable();
   4653					;
   4654	169F  E8 0000e			     call    near ptr _disable
   4655					;
   4656					;	 /* Tem	que verificar se existe	a thread */
   4657					;	 pcb = get_pcb(pid);
   4658					;
   4659	16A2  FF 76 04			     push    word ptr [bp+4]
   4660	16A5  E8 EDDA			     call    near ptr get_pcb
   4661	16A8  59			     pop     cx
   4662	16A9  8B F0			     mov     si,ax
   4663					;
   4664					;	 /* Se nao existe uma thread com este numero ou	se o estado dela n
   4665					;	 READY,	retorna	erro */
   4666					;	 if(pcb==-1||miniSO_thread[pcb].status!=READY){
   4667					;
   4668	16AB  83 FE FF			     cmp     si,-1
   4669	16AE  74 10			     je	     short @36@86
   4670	16B0  8B C6			     mov     ax,si
   4671	16B2  BA 001A			     mov     dx,26
   4672	16B5  F7 EA			     imul    dx
   4673	16B7  8B D8			     mov     bx,ax
   4674	16B9  83 BF 000Br 00		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],0
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 83
scall.ASM



   4675	16BE  74 08			     je	     short @36@142
   4676	16C0			     @36@86:
   4677					;
   4678					;	 enable();
   4679					;
   4680	16C0  E8 0000e			     call    near ptr _enable
   4681					;
   4682					;	 return	miniSO_ERROR;
   4683					;
   4684	16C3  B8 FFFF			     mov     ax,-1
   4685	16C6			     @36@114:
   4686	16C6  EB 70			     jmp     short @36@170
   4687	16C8			     @36@142:
   4688					;
   4689					;	 }
   4690					;	 prevthread = miniSO_thread[pcb].prev;
   4691					;
   4692	16C8  8B C6			     mov     ax,si
   4693	16CA  BA 001A			     mov     dx,26
   4694	16CD  F7 EA			     imul    dx
   4695	16CF  8B D8			     mov     bx,ax
   4696	16D1  8B BF 001Dr		     mov     di,word ptr DGROUP:_miniSO_thread[bx+22]
   4697					;
   4698					;	 nextthread = miniSO_thread[pcb].next;
   4699					;
   4700	16D5  8B C6			     mov     ax,si
   4701	16D7  BA 001A			     mov     dx,26
   4702	16DA  F7 EA			     imul    dx
   4703	16DC  8B D8			     mov     bx,ax
   4704	16DE  8B 87 001Fr		     mov     ax,word ptr DGROUP:_miniSO_thread[bx+24]
   4705	16E2  89 46 FE			     mov     word ptr [bp-2],ax
   4706					;
   4707					;	 miniSO_thread[pcb].next =-1;
   4708					;
   4709	16E5  8B C6			     mov     ax,si
   4710	16E7  BA 001A			     mov     dx,26
   4711	16EA  F7 EA			     imul    dx
   4712	16EC  8B D8			     mov     bx,ax
   4713	16EE  C7 87 001Fr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+24],-1
   4714					;
   4715					;	 miniSO_thread[pcb].prev = -1;
   4716					;
   4717	16F4  8B C6			     mov     ax,si
   4718	16F6  BA 001A			     mov     dx,26
   4719	16F9  F7 EA			     imul    dx
   4720	16FB  8B D8			     mov     bx,ax
   4721	16FD  C7 87 001Dr FFFF		     mov     word ptr DGROUP:_miniSO_thread[bx+22],-1
   4722					;
   4723					;	 /* Exclui o nodo da lista de prontos */
   4724					;	 miniSO_thread[prevthread].next=nextthread;
   4725					;
   4726	1703  8B C7			     mov     ax,di
   4727	1705  BA 001A			     mov     dx,26
   4728	1708  F7 EA			     imul    dx
   4729	170A  8B 56 FE			     mov     dx,word ptr [bp-2]
   4730	170D  8B D8			     mov     bx,ax
   4731	170F  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 84
scall.ASM



   4732					;
   4733					;	 miniSO_thread[nextthread].prev=prevthread;
   4734					;
   4735	1713  8B 46 FE			     mov     ax,word ptr [bp-2]
   4736	1716  BA 001A			     mov     dx,26
   4737	1719  F7 EA			     imul    dx
   4738	171B  8B D8			     mov     bx,ax
   4739	171D  89 BF 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],di
   4740					;
   4741					;	 miniSO_thread[pcb].status = STOPPED;
   4742					;
   4743	1721  8B C6			     mov     ax,si
   4744	1723  BA 001A			     mov     dx,26
   4745	1726  F7 EA			     imul    dx
   4746	1728  8B D8			     mov     bx,ax
   4747	172A  C7 87 000Br 0006		     mov     word ptr DGROUP:_miniSO_thread[bx+4],6
   4748					;
   4749					;	 enable();
   4750					;
   4751	1730  E8 0000e			     call    near ptr _enable
   4752					;
   4753					;	 return	miniSO_OK;
   4754					;
   4755	1733  B8 0001			     mov     ax,1
   4756	1736  EB 8E			     jmp     short @36@114
   4757	1738			     @36@170:
   4758					;
   4759					;    }
   4760					;
   4761	1738  5F			     pop     di
   4762	1739  5E			     pop     si
   4763	173A  8B E5			     mov     sp,bp
   4764	173C  5D			     pop     bp
   4765	173D  C3			     ret
   4766	173E			     _sc_stop	     endp
   4767					;
   4768					;    int sc_resume(pid_t pid) {
   4769					;
   4770					     assume  cs:_TEXT
   4771	173E			     _sc_resume	     proc    near
   4772	173E  55			     push    bp
   4773	173F  8B EC			     mov     bp,sp
   4774	1741  56			     push    si
   4775	1742  57			     push    di
   4776					;
   4777					;	 pcb_t pcb,prevthread,nextthread,last;
   4778					;	 disable();
   4779					;
   4780	1743  E8 0000e			     call    near ptr _disable
   4781					;
   4782					;	 /* Tem	que verificar se existe	a thread */
   4783					;	 pcb = get_pcb(pid);
   4784					;
   4785	1746  FF 76 04			     push    word ptr [bp+4]
   4786	1749  E8 ED36			     call    near ptr get_pcb
   4787	174C  59			     pop     cx
   4788	174D  8B F0			     mov     si,ax
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 85
scall.ASM



   4789					;
   4790					;	 /* Se nao existe uma thread com este numero ou	se o estado dela não
   4791					;	 é
   4792					;	 STOPPED */
   4793					;	 if(pcb==-1 || miniSO_thread[pcb].status != STOPPED)  {
   4794					;
   4795	174F  83 FE FF			     cmp     si,-1
   4796	1752  74 10			     je	     short @37@86
   4797	1754  8B C6			     mov     ax,si
   4798	1756  BA 001A			     mov     dx,26
   4799	1759  F7 EA			     imul    dx
   4800	175B  8B D8			     mov     bx,ax
   4801	175D  83 BF 000Br 06		     cmp     word ptr DGROUP:_miniSO_thread[bx+4],6
   4802	1762  74 08			     je	     short @37@142
   4803	1764			     @37@86:
   4804					;
   4805					;	 enable();
   4806					;
   4807	1764  E8 0000e			     call    near ptr _enable
   4808					;
   4809					;	 return	miniSO_ERROR;
   4810					;
   4811	1767  B8 FFFF			     mov     ax,-1
   4812	176A			     @37@114:
   4813	176A  EB 5E			     jmp     short @37@170
   4814	176C			     @37@142:
   4815					;
   4816					;	 }
   4817					;	 last =	miniSO_thread[miniSO_ready].prev;
   4818					;
   4819	176C  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   4820	176F  BA 001A			     mov     dx,26
   4821	1772  F7 EA			     imul    dx
   4822	1774  8B D8			     mov     bx,ax
   4823	1776  8B BF 001Dr		     mov     di,word ptr DGROUP:_miniSO_thread[bx+22]
   4824					;
   4825					;	 miniSO_thread[pcb].prev = last;
   4826					;
   4827	177A  8B C6			     mov     ax,si
   4828	177C  BA 001A			     mov     dx,26
   4829	177F  F7 EA			     imul    dx
   4830	1781  8B D8			     mov     bx,ax
   4831	1783  89 BF 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],di
   4832					;
   4833					;	 miniSO_thread[last].next=pcb;
   4834					;
   4835	1787  8B C7			     mov     ax,di
   4836	1789  BA 001A			     mov     dx,26
   4837	178C  F7 EA			     imul    dx
   4838	178E  8B D8			     mov     bx,ax
   4839	1790  89 B7 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],si
   4840					;
   4841					;	 miniSO_thread[miniSO_ready].prev=pcb;
   4842					;
   4843	1794  A1 0007r			     mov     ax,word ptr DGROUP:_miniSO_ready
   4844	1797  BA 001A			     mov     dx,26
   4845	179A  F7 EA			     imul    dx
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 86
scall.ASM



   4846	179C  8B D8			     mov     bx,ax
   4847	179E  89 B7 001Dr		     mov     word ptr DGROUP:_miniSO_thread[bx+22],si
   4848					;
   4849					;	 miniSO_thread[pcb].next=miniSO_ready;
   4850					;
   4851	17A2  8B C6			     mov     ax,si
   4852	17A4  BA 001A			     mov     dx,26
   4853	17A7  F7 EA			     imul    dx
   4854	17A9  8B 16 0007r		     mov     dx,word ptr DGROUP:_miniSO_ready
   4855	17AD  8B D8			     mov     bx,ax
   4856	17AF  89 97 001Fr		     mov     word ptr DGROUP:_miniSO_thread[bx+24],dx
   4857					;
   4858					;	 miniSO_thread[pcb].status = READY;
   4859					;
   4860	17B3  8B C6			     mov     ax,si
   4861	17B5  BA 001A			     mov     dx,26
   4862	17B8  F7 EA			     imul    dx
   4863	17BA  8B D8			     mov     bx,ax
   4864	17BC  C7 87 000Br 0000		     mov     word ptr DGROUP:_miniSO_thread[bx+4],0
   4865					;
   4866					;	 enable();
   4867					;
   4868	17C2  E8 0000e			     call    near ptr _enable
   4869					;
   4870					;	 return	miniSO_OK;
   4871					;
   4872	17C5  B8 0001			     mov     ax,1
   4873	17C8  EB A0			     jmp     short @37@114
   4874	17CA			     @37@170:
   4875					;
   4876					;    }
   4877					;
   4878	17CA  5F			     pop     di
   4879	17CB  5E			     pop     si
   4880	17CC  5D			     pop     bp
   4881	17CD  C3			     ret
   4882	17CE			     _sc_resume	     endp
   4883	17CE			     _TEXT   ends
   4884	0000			     _BSS    segment word public 'BSS'
   4885	0000			     _miniSO_oldisr  label   dword
   4886	0000  04*(??)			     db	     4 dup (?)
   4887	0004			     _miniSO_nextthread	     label   word
   4888	0004  02*(??)			     db	     2 dup (?)
   4889	0006			     _miniSO_delcurthread    label   byte
   4890	0006  01*(??)			     db	     1 dup (?)
   4891	0007			     _miniSO_thread  label   word
   4892	0007  01A0*(??)			     db	     416 dup (?)
   4893	01A7			     _miniSO_sem     label   word
   4894	01A7  50*(??)			     db	     80	dup (?)
   4895					     ?debug  C E9
   4896					     ?debug  C FA00000000
   4897	01F7			     _BSS    ends
   4898	0094			     _DATA   segment word public 'DATA'
   4899	0094			     s@	     label   byte
   4900	0094  0A			     db	     10
   4901	0095  0A			     db	     10
   4902	0096  00			     db	     0
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 87
scall.ASM



   4903	0097  50 72 65 73 73 69	6F+	     db	     'Pressione	uma tecla para reiniciar...'
   4904	      6E 65 20 75 6D 61	20+
   4905	      74 65 63 6C 61 20	70+
   4906	      61 72 61 20 72 65	69+
   4907	      6E 69 63 69 61 72	2E+
   4908	      2E 2E
   4909	00BC  0A			     db	     10
   4910	00BD  00			     db	     0
   4911	00BE  6B 69 6C 6C 28 29	3A+	     db	     'kill(): thread 0 excluida!'
   4912	      20 74 68 72 65 61	64+
   4913	      20 30 20 65 78 63	6C+
   4914	      75 69 64 61 21
   4915	00D8  00			     db	     0
   4916	00D9  6B 69 6C 6C 28 29	3A+	     db	     'kill(): nao ha'
   4917	      20 6E 61 6F 20 68	61
   4918	00E7  27			     db	     39
   4919	00E8  20 6D 61 69 73 20	74+	     db	     ' mais threads executando!'
   4920	      68 72 65 61 64 73	20+
   4921	      65 78 65 63 75 74	61+
   4922	      6E 64 6F 21
   4923	0101  00			     db	     0
   4924	0102  77 61 69 74 70 69	64+	     db	     'waitpid(): nao ha'
   4925	      28 29 3A 20 6E 61	6F+
   4926	      20 68 61
   4927	0113  27			     db	     39
   4928	0114  20 6D 61 69 73 20	74+	     db	     ' mais threads executando!'
   4929	      68 72 65 61 64 73	20+
   4930	      65 78 65 63 75 74	61+
   4931	      6E 64 6F 21
   4932	012D  00			     db	     0
   4933	012E  77 61 69 74 28 29	3A+	     db	     'wait(): nao ha'
   4934	      20 6E 61 6F 20 68	61
   4935	013C  27			     db	     39
   4936	013D  20 6D 61 69 73 20	74+	     db	     ' mais threads executando!'
   4937	      68 72 65 61 64 73	20+
   4938	      65 78 65 63 75 74	61+
   4939	      6E 64 6F 21
   4940	0156  00			     db	     0
   4941	0157  65 78 69 74 28 29	3A+	     db	     'exit(): thread 0 encerrada!'
   4942	      20 74 68 72 65 61	64+
   4943	      20 30 20 65 6E 63	65+
   4944	      72 72 61 64 61 21
   4945	0172  00			     db	     0
   4946	0173  65 78 69 74 28 29	3A+	     db	     'exit(): pai nao encontrado!'
   4947	      20 70 61 69 20 6E	61+
   4948	      6F 20 65 6E 63 6F	6E+
   4949	      74 72 61 64 6F 21
   4950	018E  00			     db	     0
   4951	018F  65 78 69 74 28 29	3A+	     db	     'exit(): nao ha'
   4952	      20 6E 61 6F 20 68	61
   4953	019D  27			     db	     39
   4954	019E  20 6D 61 69 73 20	74+	     db	     ' mais threads executando!'
   4955	      68 72 65 61 64 73	20+
   4956	      65 78 65 63 75 74	61+
   4957	      6E 64 6F 21
   4958	01B7  00			     db	     0
   4959	01B8  77 61 69 74 73 69	67+	     db	     'waitsignal(): nao	ha'
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 88
scall.ASM



   4960	      6E 61 6C 28 29 3A	20+
   4961	      6E 61 6F 20 68 61
   4962	01CC  27			     db	     39
   4963	01CD  20 6D 61 69 73 20	74+	     db	     ' mais threads executando!'
   4964	      68 72 65 61 64 73	20+
   4965	      65 78 65 63 75 74	61+
   4966	      6E 64 6F 21
   4967	01E6  00			     db	     0
   4968	01E7  73 65 6D 64 6F 77	6E+	     db	     'semdown(): nao ha'
   4969	      28 29 3A 20 6E 61	6F+
   4970	      20 68 61
   4971	01F8  27			     db	     39
   4972	01F9  20 6D 61 69 73 20	74+	     db	     ' mais threads executando!'
   4973	      68 72 65 61 64 73	20+
   4974	      65 78 65 63 75 74	61+
   4975	      6E 64 6F 21
   4976	0212  00			     db	     0
   4977	0213			     _DATA   ends
   4978	17CE			     _TEXT   segment byte public 'CODE'
   4979	17CE			     _TEXT   ends
   4980				     _get_sem_pos    equ     get_sem_pos
   4981					     extrn   _miniSO_return_addr:near
   4982					     public  _miniSO_contextswitch
   4983					     public  _scall
   4984				     _get_pcb	     equ     get_pcb
   4985				     _end_mso	     equ     end_mso
   4986				     _scroll equ     scroll
   4987				     _getCursorPosition	     equ     getCursorPosition
   4988				     _setCursorPosition	     equ     setCursorPosition
   4989					     public  _miniSO_scall_table
   4990					     public  _miniSO_oldisr
   4991					     public  _miniSO_nextthread
   4992					     public  _miniSO_delcurthread
   4993					     public  _miniSO_free
   4994					     public  _miniSO_ready
   4995					     public  _miniSO_thread
   4996				     _nextsemid	     equ     nextsemid
   4997					     public  _miniSO_sem
   4998				     _miniSO_key     equ     miniSO_key
   4999				     _miniSO_iskey   equ     miniSO_iskey
   5000				     _miniSO_pag     equ     miniSO_pag
   5001				     _miniSO_cor     equ     miniSO_cor
   5002				     _miniSO_col     equ     miniSO_col
   5003					     extrn   _putstr:near
   5004					     extrn   _getch:near
   5005					     extrn   _putch:near
   5006					     public  _sc_resume
   5007					     public  _sc_stop
   5008					     public  _sc_semdestroy
   5009					     public  _sc_semdown
   5010					     public  _sc_semup
   5011					     public  _sc_semset
   5012					     public  _sc_semcreate
   5013					     public  _sc_waitsignal
   5014					     public  _sc_sendsignal
   5015					     public  _sc_getppid
   5016					     public  _sc_getpid
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 89
scall.ASM



   5017					     public  _sc_exit
   5018					     public  _sc_waitpid
   5019					     public  _sc_wait
   5020					     public  _sc_kill
   5021					     public  _sc_fork
   5022					     public  _sc_reboot
   5023					     public  _sc_gettime
   5024					     public  _sc_getdate
   5025					     public  _sc_gotoxy
   5026					     public  _sc_wherey
   5027					     public  _sc_wherex
   5028					     public  _sc_setcolor
   5029					     public  _sc_getcolor
   5030					     public  _sc_clrscr
   5031					     public  _sc_getch
   5032					     public  _sc_putch
   5033					     public  _miniSO_init_semtable
   5034					     public  _miniSO_init_proctable
   5035					     extrn   _FP_OFF:near
   5036					     extrn   _FP_SEG:near
   5037					     extrn   _MK_FP:near
   5038					     extrn   _disable:near
   5039					     extrn   _enable:near
   5040					     extrn   _setvect:near
   5041				     _s@     equ     s@
   5042					     end
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 90
Symbol Table




Symbol Name		Type   Value			   Cref	(defined at #)

??DATE			Text   "12/06/17"
??FILENAME		Text   "scall	"
??TIME			Text   "01:51:25"
??VERSION		Number 030A
@10@58			Near   _TEXT:0207		   767	#768
@11@58			Near   _TEXT:0218		   790	#791
@12@58			Near   _TEXT:0244		   836	#837
@13@114			Near   _TEXT:02F3		   958	#959
@14@114			Near   _TEXT:038D		   1067	 #1068
@15@170			Near   _TEXT:03C6		   1112	 #1119
@15@226			Near   _TEXT:0403		   1118	 1146  #1155
@15@254			Near   _TEXT:0435		   1106	 #1188
@15@86			Near   _TEXT:03AC		   1088	 #1098
@17@142			Near   _TEXT:04AD		   #1308  1320
@17@170			Near   _TEXT:04AF		   1296	 1303  #1310
@17@198			Near   _TEXT:04B0		   1285	 #1312
@17@254			Near   _TEXT:04BA		   1309	 #1321
@17@58			Near   _TEXT:0489		   #1286  1314
@18@114			Near   _TEXT:04D0		   1342	 #1352
@18@58			Near   _TEXT:04C3		   #1343  1354
@19@114			Near   _TEXT:0596		   1462	 #1483
@19@58			Near   _TEXT:0576		   #1463  1485
@1@170			Near   _TEXT:0039		   #195	 276
@1@198			Near   _TEXT:0046		   #205	 219  234  250	265
@1@226			Near   _TEXT:0048		   #207	 277
@1@254			Near   _TEXT:0059		   #220	 278
@1@282			Near   _TEXT:006E		   #235	 279
@1@310			Near   _TEXT:0087		   182	192  #251
@1@338			Near   _TEXT:0088		   170	#253
@1@394			Near   _TEXT:0094		   206	#266
@1@58			Near   _TEXT:000D		   #171	 256
@1@C434			Word   _TEXT:0098		   194	#275
@20@114			Near   _TEXT:05D6		   1548	 #1549
@21@114			Near   _TEXT:05ED		   1585	 #1592
@21@142			Near   _TEXT:05F4		   #1603  1640
@21@198			Near   _TEXT:0607		   1616	 #1621
@21@254			Near   _TEXT:0617		   1626	 #1632
@21@282			Near   _TEXT:061B		   1602	 1631  #1638
@21@338			Near   _TEXT:082E		   1591	 #1937
@21@86			Near   _TEXT:05EA		   #1590  1936
@22@1010		Near   _TEXT:0A5B		   2307	 #2353
@22@1038		Near   _TEXT:0A6A		   2266	 #2363
@22@1066		Near   _TEXT:0A7B		   2373	 #2374
@22@1122		Near   _TEXT:0B0A		   2392	 #2457
@22@114			Near   _TEXT:085B		   #1992  2217
@22@1150		Near   _TEXT:0B14		   #2469  2470
@22@1178		Near   _TEXT:0B16		   2468	 #2471
@22@1206		Near   _TEXT:0B1C		   2002	 #2479
@22@142			Near   _TEXT:0861		   #2001  2478
@22@170			Near   _TEXT:0864		   1991	 #2003
@22@198			Near   _TEXT:0866		   #2005  2056
@22@226			Near   _TEXT:08A6		   2004	 #2049
@22@310			Near   _TEXT:08BC		   #2064  2107
@22@394			Near   _TEXT:0906		   2074	 2087  #2103
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 91
Symbol Table



@22@422			Near   _TEXT:0907		   2063	 #2105
@22@562			Near   _TEXT:0945		   #2141  2490	2491
@22@646			Near   _TEXT:0980		   2173	 #2183
@22@674			Near   _TEXT:098B		   2167	 2182  #2194
@22@702			Near   _TEXT:098D		   #2201  2495
@22@730			Near   _TEXT:098F		   #2208  2493	2494  2496
@22@758			Near   _TEXT:0991		   2138	 #2216	2492
@22@786			Near   _TEXT:0994		   2200	 2207  2215  #2218
@22@842			Near   _TEXT:09D5		   2240	 #2267
@22@86			Near   _TEXT:084D		   1969	 #1977
@22@898			Near   _TEXT:0A14		   2286	 #2308
@22@926			Near   _TEXT:0A24		   #2320  2336
@22@954			Near   _TEXT:0A31		   2319	 #2330
@22@C1266		Word   _TEXT:0B22		   2140	 #2489
@23@114			Near   _TEXT:0B71		   #2553  2821
@23@142			Near   _TEXT:0B74		   2543	 #2555
@23@226			Near   _TEXT:0BB5		   2595	 #2603
@23@254			Near   _TEXT:0C27		   2672	 #2673	2682
@23@310			Near   _TEXT:0C3A		   2566	 #2688
@23@394			Near   _TEXT:0C82		   2730	 #2739
@23@422			Near   _TEXT:0C84		   2717	 #2744
@23@450			Near   _TEXT:0C92		   2743	 #2754
@23@506			Near   _TEXT:0CA7		   2759	 #2769
@23@534			Near   _TEXT:0CFD		   2554	 #2822
@23@86			Near   _TEXT:0B6B		   2530	 #2544
@24@114			Near   _TEXT:0D56		   2890	 #2898
@24@142			Near   _TEXT:0DBD		   2960	 #2961	2970
@24@198			Near   _TEXT:0DD0		   2863	 #2976
@24@254			Near   _TEXT:0E23		   3010	 #3023
@24@282			Near   _TEXT:0E7D		   3077	 #3078
@25@114			Near   _TEXT:0E9F		   #3120  3170
@25@142			Near   _TEXT:0EE0		   3119	 #3163
@25@226			Near   _TEXT:0EF7		   #3178  3214
@25@310			Near   _TEXT:0F35		   3188	 3201  #3210
@25@338			Near   _TEXT:0F36		   3177	 #3212
@25@422			Near   _TEXT:0F5C		   3231	 #3239
@25@506			Near   _TEXT:0F92		   3262	 #3270
@25@534			Near   _TEXT:0FEF		   3255	 3269  #3324
@25@590			Near   _TEXT:1021		   3350	 #3358
@25@646			Near   _TEXT:1076		   3386	 #3408
@25@674			Near   _TEXT:1085		   #3419  3435
@25@702			Near   _TEXT:1092		   3418	 #3429
@25@758			Near   _TEXT:10C1		   3407	 #3453
@25@786			Near   _TEXT:1100		   #3493  3494
@25@86			Near   _TEXT:0E9D		   3110	 #3118
@26@58			Near   _TEXT:111B		   3522	 #3523
@27@58			Near   _TEXT:1130		   3546	 #3547
@28@114			Near   _TEXT:1151		   3583	 #3594
@28@198			Near   _TEXT:1225		   3616	 3643  #3720
@28@226			Near   _TEXT:122E		   3593	 #3732
@28@86			Near   _TEXT:114E		   #3592  3731
@29@142			Near   _TEXT:12B5		   3834	 #3842
@29@170			Near   _TEXT:130F		   3799	 #3896
@29@226			Near   _TEXT:131A		   3907	 #3908	3917
@29@254			Near   _TEXT:132A		   3906	 #3918
@29@282			Near   _TEXT:132E		   3924	 #3925
@29@86			Near   _TEXT:127B		   3778	 #3800
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 92
Symbol Table



@30@142			Near   _TEXT:1359		   #3969  3980
@30@170			Near   _TEXT:135B		   3958	 3964  #3971
@30@198			Near   _TEXT:135C		   3949	 #3973
@30@254			Near   _TEXT:1366		   3970	 #3981
@30@58			Near   _TEXT:133B		   #3950  3975
@31@114			Near   _TEXT:1380		   #4015  4039
@31@170			Near   _TEXT:1390		   4022	 #4028
@31@198			Near   _TEXT:1394		   4014	 4027  #4034
@31@254			Near   _TEXT:13E1		   #4079  4093
@31@282			Near   _TEXT:13E3		   4013	 #4081
@31@310			Near   _TEXT:13E4		   4004	 #4083
@31@366			Near   _TEXT:13F0		   4080	 #4094
@31@58			Near   _TEXT:1371		   #4005  4086
@32@114			Near   _TEXT:1415		   #4135  4150
@32@142			Near   _TEXT:1417		   4129	 #4137
@32@170			Near   _TEXT:1429		   4136	 #4151
@32@86			Near   _TEXT:1412		   4124	 #4130
@33@114			Near   _TEXT:144E		   4188	 #4199
@33@198			Near   _TEXT:14AD		   4244	 #4256
@33@226			Near   _TEXT:150A		   4216	 #4308
@33@254			Near   _TEXT:1513		   4198	 #4319
@33@86			Near   _TEXT:144B		   #4197  4318
@34@114			Near   _TEXT:153B		   4358	 #4369
@34@198			Near   _TEXT:1586		   4415	 #4423
@34@226			Near   _TEXT:1597		   #4437  4455
@34@254			Near   _TEXT:15AB		   4436	 #4452
@34@366			Near   _TEXT:15D5		   4461	 #4481
@34@394			Near   _TEXT:15F3		   4480	 #4500
@34@422			Near   _TEXT:163E		   4546	 #4547	4556
@34@478			Near   _TEXT:1650		   4386	 #4562
@34@506			Near   _TEXT:1653		   4561	 #4568
@34@534			Near   _TEXT:1659		   4368	 #4574
@34@86			Near   _TEXT:1538		   #4367  4573
@35@114			Near   _TEXT:1681		   #4617  4631
@35@142			Near   _TEXT:1683		   4611	 #4619
@35@170			Near   _TEXT:1694		   4618	 #4632
@35@86			Near   _TEXT:167E		   4606	 #4612
@36@114			Near   _TEXT:16C6		   #4685  4756
@36@142			Near   _TEXT:16C8		   4675	 #4687
@36@170			Near   _TEXT:1738		   4686	 #4757
@36@86			Near   _TEXT:16C0		   4669	 #4676
@37@114			Near   _TEXT:176A		   #4812  4873
@37@142			Near   _TEXT:176C		   4802	 #4814
@37@170			Near   _TEXT:17CA		   4813	 #4874
@37@86			Near   _TEXT:1764		   4796	 #4803
@3@114			Near   _TEXT:00BF		   334	#335
@5@114			Near   _TEXT:010E		   433	#439
@5@142			Near   _TEXT:0111		   438	#445
@5@170			Near   _TEXT:0113		   411	#450
@5@310			Near   _TEXT:0153		   511	#517
@5@338			Near   _TEXT:0156		   449	502  516  #523
@5@366			Near   _TEXT:016A		   544	#545
@6@114			Near   _TEXT:0188		   570	#582
@6@226			Near   _TEXT:01AB		   617	#620
@6@254			Near   _TEXT:01B8		   619	#634
@6@282			Near   _TEXT:01BC		   581	#641
@6@86			Near   _TEXT:0186		   #580	 640
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 93
Symbol Table



@7@170			Near   _TEXT:01E0		   700	#701
@8@58			Near   _TEXT:01EB		   721	#722
@9@58			Near   _TEXT:01FA		   746	#747
@@0			Near   _TEXT:0090		   255	#257
@@1			Near   _TEXT:03B8		   1105	 #1107
@@10			Near   _TEXT:1555		   4385	 #4387
@@2			Near   _TEXT:0A94		   2391	 #2393
@@3			Near   _TEXT:0B88		   2565	 #2567
@@4			Near   _TEXT:0D26		   2862	 #2864
@@5			Near   _TEXT:0F6F		   3254	 #3256
@@6			Near   _TEXT:1174		   3615	 #3617
@@7			Near   _TEXT:11A4		   3642	 #3644
@@8			Near   _TEXT:13EB		   4085	 #4087
@@9			Near   _TEXT:1468		   4215	 #4217
@CPU			Text   0101H
@CURSEG			Text   _TEXT			   #10	#14  #18  #22  #152  #1557  #1561  #4884  #4898	 #4978
@FILENAME		Text   SCALL
@WORDSIZE		Text   2			   #10	#14  #18  #22  #152  #1557  #1561  #4884  #4898	 #4978
B@			Byte   _BSS:0000		   #19
B@W			Word   _BSS:0000		   #20
D@			Byte   _DATA:0000		   #15
D@W			Word   _DATA:0000		   #16	1608  1620  1625  1630	1637
END_MSO			Near   _TEXT:043D		   #1205  1975	2180  2601  2896  3116	3237  3356  3840  4421
GETCURSORPOSITION	Near   _TEXT:00B0		   #314	 415  476  765	786
GET_PCB			Near   _TEXT:0482		   #1275  1609	1983  2233  2520  3224	3575  4660  4786
GET_SEM_POS		Near   _TEXT:1334		   #3939  4036	4117  4181  4351  4599
MINISO_COL		Byte   _DATA:0000		   #23	369  499  672
MINISO_COR		Byte   _DATA:0001		   #25	377  456  719  741
MINISO_ISKEY		Byte   _DATA:0003		   #29	569  574  624
MINISO_KEY		Byte   _DATA:0004		   #31	578  629
MINISO_PAG		Byte   _DATA:0002		   #27	295  321  460
NEXTSEMID		Word   _DATA:0005		   #33	4021  4026  4033  4035	4054  4056
S@			Byte   _DATA:0094		   1227	 1251  1973  2178  2599	 2894  3114  3235  3354	 3838  4419  #4899
SCROLL			Near   _TEXT:00C1		   #346	 444  522
SETCURSORPOSITION	Near   _TEXT:00A0		   #284	 538  694  830
_DISABLE		Near   ----:---- Extern		   1375	 1596  1963  2514  2687	 2849  2975  3104  3569	 3762  4176  4346 +
							   4654	 4780  #5038
_ENABLE			Near   ----:---- Extern		   1222	 1508  1537  1931  1996	 2463  2548  2671  2816	 2959  3068  3492 +
							   3587	 3726  3901  4192  4313	 4362  4545  4567  4680	 4751  4807  4868 +
							   #5039
_END_MSO		Alias  END_MSO			   #4985
_FP_OFF			Near   ----:---- Extern		   1825	 #5035
_FP_SEG			Near   ----:---- Extern		   1810	 #5036
_GETCH			Near   ----:---- Extern		   1259	 #5004
_GETCURSORPOSITION	Alias  GETCURSORPOSITION	   #4987
_GET_PCB		Alias  GET_PCB			   #4984
_GET_SEM_POS		Alias  GET_SEM_POS		   #4980
_MINISO_COL		Alias  MINISO_COL		   #5002
_MINISO_CONTEXTSWITCH	Near   _TEXT:0391		   #1080  4982
_MINISO_COR		Alias  MINISO_COR		   #5001
_MINISO_DELCURTHREAD	Byte   _BSS:0006		   1111	 1117  1499  2193  2467	 3488  #4889  4992
_MINISO_FREE		Word   _DATA:0009		   #39	1457  1584  1646  1650	1655  2031  2037  2256	2262  2797  2804  +
							   3030	 3044  3145  3159  4993
_MINISO_INIT_PROCTABLE	Near   _TEXT:04D7		   #1365  5034
_MINISO_INIT_SEMTABLE	Near   _TEXT:04BC		   #1332  1381	5033
_MINISO_ISKEY		Alias  MINISO_ISKEY		   #4999
_MINISO_KEY		Alias  MINISO_KEY		   #4998
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 94
Symbol Table



_MINISO_NEXTTHREAD	Word   _BSS:0004		   1087	 1097  1103  1161  1194	 1503  2189  2667  2955	 3484  3891  4541 +
							   #4887  4991
_MINISO_OLDISR		Dword  _BSS:0000		   1213	 1214  1528  1529  #4885  4990
_MINISO_PAG		Alias  MINISO_PAG		   #5000
_MINISO_READY		Word   _DATA:0007		   #36	1092  1104  1125  1133	1141  1150  1162  1166	1175  1183  1386  +
							   1390	 1398  1406  1409  1415	 1418  1424  1432  1440	 1448  1667  1887 +
							   1909	 1923  2166  2172  2398	 2420  2435  2537  2572	 2721  2853  2857 +
							   2888	 3109  3133  3164  3195	 3219  3268  3275  3297	 3311  3330  3339 +
							   3348	 3393  3399  3442  3448	 3458  3466  3474  3517	 3541  3650  3674 +
							   3685	 3766  4260  4286  4297	 4391  4819  4843  4854	 4994
_MINISO_RETURN_ADDR	Near   ----:---- Extern		   1797	 #4981
_MINISO_SCALL_TABLE	Word   _DATA:000B		   #42	179  190  204  217  231	 248  4989
_MINISO_SEM		Word   _BSS:01A7		   1350	 3957  3962  4012  4047	 4055  4064  4071  4078	 4128  4145  4207 +
							   4214	 4224  4236  4243  4251	 4377  4384  4435  4468	 4610  4626  #4893+
							   4997
_MINISO_THREAD		Word   _BSS:0007		   1096	 1129  1137  1145  1154	 1170  1179  1187  1295	 1301  1394  1402 +
							   1411	 1420  1428  1436  1444	 1452  1473  1481  1490	 1494  1654  1663 +
							   1671	 1678  1819  1834  1842	 1850  1858  1866  1874	 1882  1891  1902 +
							   1911	 1919  1927  2017  2024	 2033  2045  2054  2073	 2079  2086  2095 +
							   2102	 2117  2126  2136  2153	 2162  2232  2249  2258	 2277  2285  2295 +
							   2303	 2318  2329  2335  2344	 2352  2362  2372  2385	 2402  2413  2422 +
							   2431	 2440  2448  2456  2535	 2542  2564  2580  2589	 2612  2620  2628 +
							   2637	 2645  2654  2663  2681	 2703  2712  2725  2738	 2753  2768  2787 +
							   2799	 2812  2861  2873  2882	 2907  2915  2923  2931	 2941  2950  2969 +
							   2986	 2994  3001  3009  3018	 3022  3032  3040  3062	 3076  3131  3138 +
							   3147	 3155  3168  3187  3193	 3200  3209  3223  3253	 3261  3267  3279 +
							   3290	 3299  3307  3315  3323	 3334  3343  3368  3377	 3385  3395  3403 +
							   3417	 3428  3434  3444  3452	 3462  3470  3479  3521	 3545  3605  3614 +
							   3627	 3634  3641  3654  3662	 3670  3678  3687  3695	 3704  3711  3719 +
							   3775	 3787
_MK_FP			Near   ----:---- Extern		   864	985  1692  2775	 3050  #5037
_NEXTSEMID		Alias  NEXTSEMID		   #4996
_PUTCH			Near   ----:---- Extern		   1245	 #5005
_PUTSTR			Near   ----:---- Extern		   1229	 1237  1253  #5003
_S@			Alias  S@			   #5041
_SCALL			Near   _TEXT:0000		   #157	 4983
_SCROLL			Alias  SCROLL			   #4986
_SC_CLRSCR		Near   _TEXT:01C0		   54  #653  5030
_SC_EXIT		Near   _TEXT:0E83		   106	1717  #3092  5017
_SC_FORK		Near   _TEXT:05D8		   90  #1566  5021
_SC_GETCH		Near   _TEXT:0170		   50  #559  5031
_SC_GETCOLOR		Near   _TEXT:01E2		   58  #712  5029
_SC_GETDATE		Near   _TEXT:0248		   78  #850  5024
_SC_GETPID		Near   _TEXT:1108		   110	#3510  5016
_SC_GETPPID		Near   _TEXT:111D		   114	#3534  5015
_SC_GETTIME		Near   _TEXT:02F8		   82  #972  5023
_SC_GOTOXY		Near   _TEXT:021A		   74  #802  5025
_SC_KILL		Near   _TEXT:0834		   94  #1951  5020
_SC_PUTCH		Near   _TEXT:00DA		   46  #392  5032
_SC_REBOOT		Near   _TEXT:05B8		   86  1264  #1520  5022
_SC_RESUME		Near   _TEXT:173E		   150	#4771  5006
_SC_SEMCREATE		Near   _TEXT:1368		   126	#3992  5012
_SC_SEMDESTROY		Near   _TEXT:165F		   142	#4588  5008
_SC_SEMDOWN		Near   _TEXT:1519		   138	#4333  5009
_SC_SEMSET		Near   _TEXT:13F3		   130	#4106  5011
_SC_SEMUP		Near   _TEXT:142C		   134	#4163  5010
_SC_SENDSIGNAL		Near   _TEXT:1132		   118	#3558  5014
Turbo Assembler	 Version 3.1	    12/06/17 01:51:26	    Page 95
Symbol Table



_SC_SETCOLOR		Near   _TEXT:01ED		   62  #733  5028
_SC_STOP		Near   _TEXT:1697		   146	#4644  5007
_SC_WAIT		Near   _TEXT:0D03		   102	#2836  5019
_SC_WAITPID		Near   _TEXT:0B30		   98  #2501  5018
_SC_WAITSIGNAL		Near   _TEXT:1232		   122	#3745  5013
_SC_WHEREX		Near   _TEXT:01FC		   66  #758  5027
_SC_WHEREY		Near   _TEXT:0209		   70  #779  5026
_SETCURSORPOSITION	Alias  SETCURSORPOSITION	   #4988
_SETVECT		Near   ----:---- Extern		   1217	 1532  #5040

Macro Name						   Cref	(defined at #)

$COMM							   #1

Groups & Segments	Bit Size Align	Combine	Class	   Cref	(defined at #)

DGROUP			Group				   #12	13  179	 190  204  217	231  248  295  321  369	 377  456  460	  +
							   499	569  574  578  624  629	 672  719  741	1087  1092  1096  1097	  +
							   1103	 1104  1111  1117  1125	 1129  1133  1137  1141	 1145  1150  1154 +
							   1161	 1162  1166  1170  1175	 1179  1183  1187  1194	 1213  1214  1227 +
							   1251	 1295  1301  1350  1386	 1390  1394  1398  1402	 1406  1409  1411 +
							   1415	 1418  1420  1424  1428	 1432  1436  1440  1444	 1448  1452  1457 +
							   1473	 1481  1490  1494  1499	 1503  1528  1529  1584	 1608  1620  1625 +
							   1630	 1637  1646  1650  1654	 1655  1663  1667  1671	 1678  1819  1834 +
							   1842	 1850  1858  1866  1874	 1882  1887  1891  1902	 1909  1911  1919 +
							   1923	 1927  1973  2017  2024	 2031  2033  2037  2045	 2054  2073  2079 +
							   2086	 2095  2102  2117  2126	 2136  2153  2162  2166	 2172  2178  2189 +
							   2193	 2232  2249  2256  2258	 2262  2277  2285  2295	 2303  2318  2329 +
							   2335	 2344  2352  2362  2372	 2385  2398  2402  2413	 2420  2422  2431 +
							   2435	 2440  2448  2456  2467	 2535  2537  2542  2564	 2572  2580  2589 +
							   2599	 2612  2620
  _BSS			16  01F7 Word	Public	BSS	   12  #18  #4884
  _DATA			16  0213 Word	Public	DATA	   12  #14  #22	 #1557	#4898
_TEXT			16  17CE Byte	Public	CODE	   #10	13  #152  156  283  313	 345  391  558	652  711  732  757  778	  +
							   801	849  971  1079	1204  1274  1331  1364	1519  #1561  1565  1950	  +
							   2500	 2835  3091  3509  3533	 3557  3744  3938  3991	 4105  4162  4332 +
							   4587	 4643  4770  #4978
